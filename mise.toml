# Pragmastat Build Configuration
# Task runner: mise (https://mise.jdx.dev/)
#
# Usage: mise run <task>
# List all tasks: mise tasks

[tools]
dotnet = "10.0"
go = "1.24"
golangci-lint = "latest"
java = "temurin-23"
node = "22"
python = "3.13"
ruff = "latest"
rust = "stable"
uv = "0.6"

# ==========================================================================
# C# Tasks (cs/)
# ==========================================================================

[tasks."cs:build"]
description = "Build C# package (debug mode)"
dir = "cs"
run = "dotnet build -c Debug"

[tasks."cs:build:release"]
description = "Build C# package (release mode)"
dir = "cs"
run = "dotnet build -c Release"

[tasks."cs:test"]
description = "Run C# tests"
dir = "cs/Pragmastat.Tests"
run = "dotnet run"

[tasks."cs:check"]
description = "Verify C# code formatting"
dir = "cs"
run = "dotnet format --verify-no-changes"

[tasks."cs:check:fix"]
description = "Format C# code"
dir = "cs"
run = "dotnet format"

[tasks."cs:clean"]
description = "Clean C# build artifacts"
dir = "cs"
run = """
dotnet clean
rm -rf bin/ obj/ *.nupkg
"""

[tasks."cs:restore"]
description = "Restore C# dependencies"
dir = "cs"
run = "dotnet restore"

[tasks."cs:demo"]
description = "Run C# demo"
dir = "cs/Pragmastat.Demo"
run = "dotnet run"

[tasks."cs:pack"]
description = "Pack C# NuGet package"
dir = "cs"
run = """
mkdir -p ./artifacts
dotnet pack ./Pragmastat/Pragmastat.csproj --configuration Release --include-symbols --include-source -p:SymbolPackageFormat=snupkg --output ./artifacts
"""

[tasks."cs:gen"]
description = "Generate C# reference test files"
dir = "cs"
run = "dotnet run --project Pragmastat.TestGenerator/Pragmastat.TestGenerator.csproj"

[tasks."cs:sim"]
description = "Run C# simulations"
dir = "cs/Pragmastat.Simulations"
run = "dotnet run"

[tasks."cs:ci"]
description = "Run C# CI pipeline"
run = [
    { task = "cs:clean" },
    { task = "cs:restore" },
    { task = "cs:check" },
    { task = "cs:build" },
    { task = "cs:test" },
]

# ==========================================================================
# Go Tasks (go/)
# ==========================================================================

[tasks."go:build"]
description = "Build Go package"
dir = "go"
run = "go build ./..."

[tasks."go:test"]
description = "Run Go tests"
dir = "go"
run = "go test ./..."

[tasks."go:test:verbose"]
description = "Run Go tests with verbose output"
dir = "go"
run = "go test -v ./..."

[tasks."go:check"]
description = "Check Go code (format and lint)"
dir = "go"
run = """
test -z "$(go fmt ./...)" || { echo "Code is not formatted"; exit 1; }
golangci-lint run
"""

[tasks."go:check:fix"]
description = "Format Go code"
dir = "go"
run = "go fmt ./..."

[tasks."go:clean"]
description = "Clean Go build cache"
dir = "go"
run = """
go clean
rm -f coverage.out coverage.html
"""

[tasks."go:restore"]
description = "Download and verify Go dependencies"
dir = "go"
run = """
go mod download
go mod verify
"""

[tasks."go:demo"]
description = "Run Go demo"
dir = "go"
run = "go run ./demo"

[tasks."go:bench"]
description = "Run Go benchmarks"
dir = "go"
run = "go test -bench=. ./..."

[tasks."go:coverage"]
description = "Run Go tests with coverage"
dir = "go"
run = "go test -cover ./..."

[tasks."go:ci"]
description = "Run Go CI pipeline"
run = [
    { task = "go:clean" },
    { task = "go:restore" },
    { task = "go:check" },
    { task = "go:build" },
    { task = "go:test" },
]

# ==========================================================================
# Kotlin Tasks (kt/)
# ==========================================================================

[tasks."kt:build"]
description = "Build Kotlin package"
dir = "kt"
run = "./gradlew build"

[tasks."kt:test"]
description = "Run Kotlin tests"
dir = "kt"
run = "./gradlew test"

[tasks."kt:check"]
description = "Check Kotlin code"
dir = "kt"
run = "./gradlew check"

[tasks."kt:clean"]
description = "Clean Kotlin build artifacts"
dir = "kt"
run = "./gradlew clean"

[tasks."kt:demo"]
description = "Run Kotlin demo"
dir = "kt"
run = "./gradlew run"

[tasks."kt:pack"]
description = "Package Kotlin JAR"
dir = "kt"
run = "./gradlew jar"

[tasks."kt:ci"]
description = "Run Kotlin CI pipeline"
run = [
    { task = "kt:clean" },
    { task = "kt:check" },
    { task = "kt:build" },
    { task = "kt:test" },
]

# ==========================================================================
# Python Tasks (py/)
# ==========================================================================

[tasks."py:build"]
description = "Build Python package"
dir = "py"
run = """
pip install -q build
rm -rf dist/ build/ *.egg-info
python -m build
"""

[tasks."py:test"]
description = "Run Python tests"
dir = "py"
run = """
pip install -q pytest
pip install -q -e .
python -m pytest tests/ -v
"""

[tasks."py:check"]
description = "Check Python code (lint and format)"
dir = "py"
run = """
ruff check .
ruff format --check .
"""

[tasks."py:check:fix"]
description = "Format Python code"
dir = "py"
run = """
ruff check --fix .
ruff format .
"""

[tasks."py:pack"]
description = "Build and verify Python package"
dir = "py"
depends = ["py:build"]
run = "twine check dist/*"

[tasks."py:clean"]
description = "Clean Python build artifacts"
dir = "py"
run = """
rm -rf build/ dist/ *.egg-info __pycache__/ .pytest_cache/ venv/ .pip-packages
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
find . -type f -name "*.pyo" -delete 2>/dev/null || true
"""

[tasks."py:restore"]
description = "Install Python package in development mode"
dir = "py"
run = "pip install -e ."

[tasks."py:demo"]
description = "Run Python demo"
dir = "py"
run = """
pip install -q -e .
python examples/demo.py
"""

[tasks."py:ci"]
description = "Run Python CI pipeline"
run = [
    { task = "py:clean" },
    { task = "py:restore" },
    { task = "py:check" },
    { task = "py:test" },
    { task = "py:pack" },
]

# ==========================================================================
# R Tasks (r/)
# R is not managed by mise - uses system R via Rscript
# ==========================================================================

[tasks."r:build"]
description = "Build R source package"
dir = "r"
run = """
rm -rf pragmastat/src/*.o pragmastat/src/*.so pragmastat/src/*.dll 2>/dev/null || true
R CMD build pragmastat
"""

[tasks."r:test"]
description = "Run R tests"
dir = "r"
run = """
if [ ! -d "pragmastat/tests/tests" ]; then
    mkdir -p pragmastat/tests/tests
    cp -r ../tests/* pragmastat/tests/tests/
fi
cd pragmastat && Rscript -e "devtools::test()"
"""

[tasks."r:check"]
description = "Check R package"
dir = "r"
run = """
if [ ! -d "pragmastat/tests/tests" ]; then
    mkdir -p pragmastat/tests/tests
    cp -r ../tests/* pragmastat/tests/tests/
fi
R CMD check --no-tests --no-check-dependencies pragmastat
"""

[tasks."r:check:fix"]
description = "Format R code with styler"
dir = "r/pragmastat"
run = "Rscript -e \"if (!requireNamespace('styler', quietly = TRUE)) install.packages('styler', repos = 'https://cloud.r-project.org'); styler::style_pkg()\""

[tasks."r:clean"]
description = "Clean R build artifacts"
dir = "r"
run = """
rm -rf pragmastat.Rcheck pragmastat_*.tar.gz pragmastat/..Rcheck ..Rcheck
rm -rf pragmastat/src/*.o pragmastat/src/*.so pragmastat/src/*.dll
rm -rf pragmastat/inst/testdata pragmastat/tests/tests
"""

[tasks."r:restore"]
description = "Install R package locally"
dir = "r/pragmastat"
run = "Rscript -e \"if (!requireNamespace('devtools', quietly = TRUE)) install.packages('devtools', repos = 'https://cloud.r-project.org'); devtools::install()\""

[tasks."r:demo"]
description = "Run R demo"
dir = "r/pragmastat"
run = """
Rscript -e "if (!requireNamespace('devtools', quietly = TRUE)) install.packages('devtools', repos = 'https://cloud.r-project.org'); devtools::install(quiet = TRUE, upgrade = 'never')"
Rscript inst/examples/demo.R
"""

[tasks."r:doc"]
description = "Build R documentation"
dir = "r/pragmastat"
run = "Rscript -e \"if (!requireNamespace('devtools', quietly = TRUE)) install.packages('devtools', repos = 'https://cloud.r-project.org'); devtools::document()\""

[tasks."r:ci"]
description = "Run R CI pipeline"
run = [
    { task = "r:clean" },
    { task = "r:check" },
    { task = "r:build" },
    { task = "r:test" },
]

# ==========================================================================
# Rust Tasks (rs/)
# ==========================================================================

[tasks."rs:build"]
description = "Build Rust package (debug mode)"
dir = "rs/pragmastat"
run = "cargo build"

[tasks."rs:build:release"]
description = "Build Rust package (release mode)"
dir = "rs/pragmastat"
run = "cargo build --release"

[tasks."rs:test"]
description = "Run Rust tests"
dir = "rs/pragmastat"
run = "cargo test --verbose"

[tasks."rs:check"]
description = "Check Rust code (clippy, fmt, cargo check)"
dir = "rs/pragmastat"
run = """
cargo clippy -- -D warnings
cargo fmt -- --check
cargo check
"""

[tasks."rs:check:fix"]
description = "Format Rust code"
dir = "rs/pragmastat"
run = "cargo fmt"

[tasks."rs:clean"]
description = "Clean Rust build artifacts"
dir = "rs/pragmastat"
run = """
cargo clean
rm -rf Cargo.lock
"""

[tasks."rs:demo"]
description = "Run Rust demo"
dir = "rs/pragmastat"
run = "cargo run --example demo"

[tasks."rs:bench"]
description = "Run Rust benchmarks"
dir = "rs/pragmastat"
run = "cargo bench"

[tasks."rs:doc"]
description = "Build Rust documentation"
dir = "rs/pragmastat"
run = "cargo doc --no-deps"

[tasks."rs:pack"]
description = "Package Rust crate"
dir = "rs/pragmastat"
run = "cargo package --verbose"

[tasks."rs:publish:dry"]
description = "Dry run of publishing Rust crate"
dir = "rs/pragmastat"
run = "cargo publish --dry-run"

[tasks."rs:ci"]
description = "Run Rust CI pipeline"
run = [
    { task = "rs:clean" },
    { task = "rs:check" },
    { task = "rs:build" },
    { task = "rs:test" },
]

# ==========================================================================
# TypeScript Tasks (ts/)
# ==========================================================================

[tasks."ts:build"]
description = "Build TypeScript package"
dir = "ts"
run = "npm run build"

[tasks."ts:test"]
description = "Run TypeScript tests"
dir = "ts"
run = "npm test"

[tasks."ts:check"]
description = "Check TypeScript code (lint and format)"
dir = "ts"
run = """
npm run lint
npm run format:check
"""

[tasks."ts:check:fix"]
description = "Format TypeScript code"
dir = "ts"
run = "npm run format"

[tasks."ts:clean"]
description = "Clean TypeScript build artifacts"
dir = "ts"
run = "npm run clean"

[tasks."ts:restore"]
description = "Install TypeScript dependencies"
dir = "ts"
run = "npm ci"

[tasks."ts:demo"]
description = "Run TypeScript demo"
dir = "ts"
run = "npx ts-node examples/demo.ts"

[tasks."ts:coverage"]
description = "Run TypeScript tests with coverage"
dir = "ts"
run = "npm run test:coverage"

[tasks."ts:pack"]
description = "Package TypeScript npm tarball"
dir = "ts"
run = "npm pack"

[tasks."ts:ci"]
description = "Run TypeScript CI pipeline"
run = [
    { task = "ts:clean" },
    { task = "ts:restore" },
    { task = "ts:check" },
    { task = "ts:build" },
    { task = "ts:test" },
]

# ==========================================================================
# Content Generation Tasks (gen/)
# ==========================================================================

[tasks."gen:build"]
description = "Generate content (draft mode)"
dir = "gen"
run = "python3 generate.py"

[tasks."gen:build:release"]
description = "Generate content (release mode)"
dir = "gen"
run = "python3 generate.py --release"

[tasks."gen:clean"]
description = "Clean generated content"
run = "echo 'No clean operation defined for gen'"

# ==========================================================================
# Image Generation Tasks (img/)
# ==========================================================================

[tasks."img:build"]
description = "Generate images"
dir = "img"
run = """
if [ ! -d "venv" ] && [ ! -f "/.dockerenv" ] && [ -z "$VIRTUAL_ENV" ]; then
    python3 -m venv venv
    ./venv/bin/pip install -q --upgrade pip
    ./venv/bin/pip install -q -r requirements.txt
fi
if [ -d "venv" ]; then
    ./venv/bin/python3 generate-images.py
else
    python3 generate-images.py
fi
"""

[tasks."img:logo"]
description = "Generate logo"
dir = "img"
run = """
if [ ! -d "venv" ] && [ ! -f "/.dockerenv" ] && [ -z "$VIRTUAL_ENV" ]; then
    python3 -m venv venv
    ./venv/bin/pip install -q --upgrade pip
    ./venv/bin/pip install -q -r requirements.txt
fi
if [ -d "venv" ]; then
    ./venv/bin/python3 generate-logo.py
else
    python3 generate-logo.py
fi
"""

[tasks."img:clean"]
description = "Clean generated images"
dir = "img"
run = """
find . -maxdepth 1 -type f \\( -name "*.png" ! -name "logo.png" -o -name "*.jpg" -o -name "*.svg" \\) -delete 2>/dev/null || true
rm -rf venv
"""

# ==========================================================================
# PDF Generation Tasks (pdf/)
# ==========================================================================

[tasks."pdf:build"]
description = "Build PDF manual (draft mode)"
dir = "pdf"
run = """
VERSION=$(cat ../manual/version.txt)
pandoc 'pragmastat.md' \
    --pdf-engine=latexmk \
    --pdf-engine-opt=-xelatex \
    --pdf-engine-opt=-shell-escape \
    --pdf-engine-opt=-interaction=batchmode \
    --number-sections \
    --citeproc \
    -o "pragmastat-v${VERSION}-draft.pdf"
"""

[tasks."pdf:build:release"]
description = "Build PDF manual (release mode)"
dir = "pdf"
run = """
VERSION=$(cat ../manual/version.txt)
pandoc 'pragmastat.md' \
    --pdf-engine=latexmk \
    --pdf-engine-opt=-xelatex \
    --pdf-engine-opt=-shell-escape \
    --pdf-engine-opt=-interaction=batchmode \
    --number-sections \
    --citeproc \
    -o "pragmastat-v${VERSION}.pdf"
"""

[tasks."pdf:clean"]
description = "Clean generated PDF files"
dir = "pdf"
run = "rm -f pragmastat-v*.pdf 2>/dev/null || true"

# ==========================================================================
# Website Tasks (web/)
# ==========================================================================

[tasks."web:restore"]
description = "Initialize web tools (download Hugo and Tailwind)"
dir = "web"
run = """
mkdir -p .bin
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)
[ "$OS" = "darwin" ] && OS="darwin"
[ "$ARCH" = "x86_64" ] && ARCH="amd64"
[ "$ARCH" = "aarch64" ] && ARCH="arm64"

HUGO_VERSION="0.152.2"
TAILWIND_VERSION="4.1.16"

# Download Hugo
HUGO_ARCH="$ARCH"
[ "$OS" = "darwin" ] && HUGO_ARCH="universal"
curl -L -o .bin/hugo.tar.gz "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_${OS}-${HUGO_ARCH}.tar.gz"
cd .bin && tar -xzf hugo.tar.gz hugo && rm hugo.tar.gz && chmod +x hugo && cd ..

# Download Tailwind
TAILWIND_OS="$OS"
TAILWIND_ARCH="$ARCH"
[ "$OS" = "darwin" ] && TAILWIND_OS="macos"
[ "$ARCH" = "amd64" ] && TAILWIND_ARCH="x64"
curl -L -o .bin/tailwind "https://github.com/tailwindlabs/tailwindcss/releases/download/v${TAILWIND_VERSION}/tailwindcss-${TAILWIND_OS}-${TAILWIND_ARCH}"
chmod +x .bin/tailwind
"""

[tasks."web:build"]
description = "Build website (draft mode)"
dir = "web"
depends = ["_web:ensure-tools"]
run = """
VERSION=$(cat ../manual/version.txt)
DATE=$(date +%Y-%m-%d)

# Run Tailwind
.bin/tailwind -i ./assets/css/styles-tailwindcss.css -o ./assets/css/styles.css --minify

# Copy PDF
cp "../pdf/pragmastat-v${VERSION}-draft.pdf" static/pragmastat.pdf

# Write config
cat > data/config.toml << EOF
version = "$VERSION"
date = "$DATE"
isRelease = false
EOF

# Copy favicon
if [ -f "../img/logo.ico" ]; then
    mkdir -p content/img
    cp ../img/logo.ico content/img/favicon.ico
fi

# Build Hugo
.bin/hugo --minify
"""

[tasks."web:build:release"]
description = "Build website (release mode)"
dir = "web"
depends = ["_web:ensure-tools"]
run = """
VERSION=$(cat ../manual/version.txt)
DATE=$(date +%Y-%m-%d)

# Run Tailwind
.bin/tailwind -i ./assets/css/styles-tailwindcss.css -o ./assets/css/styles.css --minify

# Copy PDF
cp "../pdf/pragmastat-v${VERSION}.pdf" static/pragmastat.pdf

# Write config
cat > data/config.toml << EOF
version = "$VERSION"
date = "$DATE"
isRelease = true
EOF

# Copy favicon
if [ -f "../img/logo.ico" ]; then
    mkdir -p content/img
    cp ../img/logo.ico content/img/favicon.ico
fi

# Build Hugo
.bin/hugo --minify
"""

[tasks."web:serve"]
description = "Start Hugo development server"
dir = "web"
depends = ["_web:ensure-tools"]
run = ".bin/hugo server --renderToMemory --port 1729 --liveReloadPort 1729 --forceSyncStatic --gc --watch --buildDrafts"

[tasks."web:clean"]
description = "Clean website build artifacts"
dir = "web"
run = """
rm -rf public/ resources/
rm -f .hugo_build.lock
rm -f assets/css/styles.css
"""

[tasks."_web:ensure-tools"]
description = "Ensure Hugo and Tailwind are available"
dir = "web"
run = """
if [ ! -f ".bin/hugo" ] || [ ! -f ".bin/tailwind" ]; then
    echo "Hugo or Tailwind not found. Running web:restore..."
    mise run web:restore
fi
"""
hide = true

# ==========================================================================
# Aggregate Tasks
# ==========================================================================

[tasks."build"]
description = "Build all language implementations"
depends = ["cs:build", "go:build", "kt:build", "py:build", "r:build", "rs:build", "ts:build"]

[tasks."test"]
description = "Test all language implementations"
depends = ["cs:test", "go:test", "kt:test", "py:test", "r:test", "rs:test", "ts:test"]

[tasks."check"]
description = "Check all language implementations"
depends = ["cs:check", "go:check", "kt:check", "py:check", "r:check", "rs:check", "ts:check"]

[tasks."clean"]
description = "Clean all build artifacts"
depends = ["cs:clean", "go:clean", "kt:clean", "py:clean", "r:clean", "rs:clean", "ts:clean", "img:clean", "pdf:clean", "web:clean"]

[tasks."demo"]
description = "Run demos for all language implementations"
depends = ["cs:demo", "go:demo", "kt:demo", "py:demo", "r:demo", "rs:demo", "ts:demo"]

[tasks."ci"]
description = "Run CI pipeline for all language implementations"
depends = ["cs:ci", "go:ci", "kt:ci", "py:ci", "r:ci", "rs:ci", "ts:ci"]

# ==========================================================================
# Publish Task
# ==========================================================================

[tasks."publish"]
description = "Publish a new version"
file = ".mise/tasks/publish"

# ==========================================================================
# Docker Tasks
# ==========================================================================

[tasks."docker:build"]
description = "Build all Docker images"
run = "docker compose build"

[tasks."docker:clean"]
description = "Remove all Docker containers and images"
run = "docker compose down --rmi all --volumes --remove-orphans"
