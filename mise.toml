# Pragmastat Build Configuration
# Task runner: mise (https://mise.jdx.dev/)
#
# Usage: mise run <task>
# List all tasks: mise tasks

[tools]
dotnet = "10.0"
go = "1.24"
golangci-lint = "latest"
java = "temurin-23"
node = "22"
pnpm = "10"
python = "3.13"
ruff = "latest"
rust = "stable"
uv = "0.6"

# ==========================================================================
# C# Tasks (cs/)
# ==========================================================================

[tasks."cs:build"]
description = "Build C# package (debug mode)"
dir = "cs"
run = "dotnet build -c Debug"

[tasks."cs:build:release"]
description = "Build C# package (release mode)"
dir = "cs"
run = "dotnet build -c Release"

[tasks."cs:test"]
description = "Run C# tests"
dir = "cs/Pragmastat.Tests"
run = "dotnet run"

[tasks."cs:check"]
description = "Verify C# code formatting"
dir = "cs"
run = "dotnet format --verify-no-changes"

[tasks."cs:check:fix"]
description = "Format C# code"
dir = "cs"
run = "dotnet format"

[tasks."cs:clean"]
description = "Clean C# build artifacts"
dir = "cs"
run = """
dotnet clean
rm -rf bin/ obj/ *.nupkg
"""

[tasks."cs:restore"]
description = "Restore C# dependencies"
dir = "cs"
run = "dotnet restore"

[tasks."cs:demo"]
description = "Run C# demo"
dir = "cs/Pragmastat.Demo"
run = "dotnet run"

[tasks."cs:pack"]
description = "Pack C# NuGet package"
dir = "cs"
depends = ["img:logo"]
run = """
mkdir -p ./artifacts
dotnet pack ./Pragmastat/Pragmastat.csproj --configuration Release --include-symbols --include-source -p:SymbolPackageFormat=snupkg --output ./artifacts
"""

[tasks."cs:gen"]
description = "Generate C# reference test files"
dir = "cs"
run = "dotnet run --project Pragmastat.TestGenerator/Pragmastat.TestGenerator.csproj"

[tasks."cs:sim"]
description = "Run C# simulations"
dir = "cs/Pragmastat.Simulations"
run = "dotnet run"

[tasks."cs:ci"]
description = "Run C# CI pipeline"
run = [
    { task = "cs:clean" },
    { task = "cs:restore" },
    { task = "cs:check" },
    { task = "cs:build" },
    { task = "cs:test" },
]

# ==========================================================================
# Go Tasks (go/)
# ==========================================================================

[tasks."go:build"]
description = "Build Go package"
dir = "go"
run = "go build ./..."

[tasks."go:test"]
description = "Run Go tests"
dir = "go"
run = "go test ./..."

[tasks."go:test:verbose"]
description = "Run Go tests with verbose output"
dir = "go"
run = "go test -v ./..."

[tasks."go:check"]
description = "Check Go code (format and lint)"
dir = "go"
run = """
test -z "$(go fmt ./...)" || { echo "Code is not formatted"; exit 1; }
golangci-lint run
"""

[tasks."go:check:fix"]
description = "Format Go code"
dir = "go"
run = "go fmt ./..."

[tasks."go:clean"]
description = "Clean Go build cache"
dir = "go"
run = """
go clean
rm -f coverage.out coverage.html
"""

[tasks."go:restore"]
description = "Download and verify Go dependencies"
dir = "go"
run = """
go mod download
go mod verify
"""

[tasks."go:demo"]
description = "Run Go demo"
dir = "go"
run = "go run ./demo"

[tasks."go:bench"]
description = "Run Go benchmarks"
dir = "go"
run = "go test -bench=. ./..."

[tasks."go:coverage"]
description = "Run Go tests with coverage"
dir = "go"
run = "go test -cover ./..."

[tasks."go:ci"]
description = "Run Go CI pipeline"
run = [
    { task = "go:clean" },
    { task = "go:restore" },
    { task = "go:check" },
    { task = "go:build" },
    { task = "go:test" },
]

# ==========================================================================
# Kotlin Tasks (kt/)
# ==========================================================================

[tasks."kt:build"]
description = "Build Kotlin package"
dir = "kt"
run = "./gradlew build"

[tasks."kt:test"]
description = "Run Kotlin tests"
dir = "kt"
run = "./gradlew test"

[tasks."kt:check"]
description = "Check Kotlin code"
dir = "kt"
run = "./gradlew check"

[tasks."kt:clean"]
description = "Clean Kotlin build artifacts"
dir = "kt"
run = "./gradlew clean"

[tasks."kt:demo"]
description = "Run Kotlin demo"
dir = "kt"
run = "./gradlew run"

[tasks."kt:pack"]
description = "Package Kotlin JAR"
dir = "kt"
run = "./gradlew jar"

[tasks."kt:restore"]
description = "Restore Kotlin dependencies"
dir = "kt"
run = "./gradlew dependencies --quiet"

[tasks."kt:ci"]
description = "Run Kotlin CI pipeline"
run = [
    { task = "kt:clean" },
    { task = "kt:restore" },
    { task = "kt:check" },
    { task = "kt:build" },
    { task = "kt:test" },
]

# ==========================================================================
# Python Tasks (py/)
# ==========================================================================

[tasks."py:build"]
description = "Build Python package"
dir = "py"
run = """
pip install -q build
rm -rf dist/ build/ *.egg-info
python -m build
"""

[tasks."py:test"]
description = "Run Python tests"
dir = "py"
run = """
pip install -q pytest
pip install -q -e .
python -m pytest tests/ -v
"""

[tasks."py:check"]
description = "Check Python code (lint and format)"
dir = "py"
run = """
ruff check .
ruff format --check .
"""

[tasks."py:check:fix"]
description = "Format Python code"
dir = "py"
run = """
ruff check --fix .
ruff format .
"""

[tasks."py:pack"]
description = "Build and verify Python package"
dir = "py"
depends = ["py:build"]
run = "twine check dist/*"

[tasks."py:clean"]
description = "Clean Python build artifacts"
dir = "py"
run = """
rm -rf build/ dist/ *.egg-info __pycache__/ .pytest_cache/ venv/ .pip-packages
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
find . -type f -name "*.pyo" -delete 2>/dev/null || true
"""

[tasks."py:restore"]
description = "Install Python package and dev dependencies"
dir = "py"
run = """
python -m pip install --upgrade pip
pip install pytest build twine ruff
pip install -e .
"""

[tasks."py:demo"]
description = "Run Python demo"
dir = "py"
run = """
pip install -q -e .
python examples/demo.py
"""

[tasks."py:ci"]
description = "Run Python CI pipeline"
run = [
    { task = "py:clean" },
    { task = "py:restore" },
    { task = "py:check" },
    { task = "py:test" },
    { task = "py:pack" },
]

# ==========================================================================
# R Tasks (r/)
# R is not managed by mise - uses system R via Rscript
# ==========================================================================

[tasks."r:build"]
description = "Build R source package"
dir = "r"
run = """
rm -rf pragmastat/src/*.o pragmastat/src/*.so pragmastat/src/*.dll 2>/dev/null || true
R CMD build pragmastat
"""

[tasks."r:test"]
description = "Run R tests"
dir = "r"
run = """
if [ ! -d "pragmastat/tests/tests" ]; then
    mkdir -p pragmastat/tests/tests
    cp -r ../tests/* pragmastat/tests/tests/
fi
cd pragmastat && Rscript -e "devtools::test()"
"""

[tasks."r:check"]
description = "Check R package"
dir = "r"
run = """
if [ ! -d "pragmastat/tests/tests" ]; then
    mkdir -p pragmastat/tests/tests
    cp -r ../tests/* pragmastat/tests/tests/
fi
R CMD check --no-tests --no-check-dependencies pragmastat
"""

[tasks."r:check:fix"]
description = "Format R code with styler"
dir = "r/pragmastat"
run = "Rscript -e \"if (!requireNamespace('styler', quietly = TRUE)) install.packages('styler', repos = 'https://cloud.r-project.org'); styler::style_pkg()\""

[tasks."r:clean"]
description = "Clean R build artifacts"
dir = "r"
run = """
rm -rf pragmastat.Rcheck pragmastat_*.tar.gz pragmastat/..Rcheck ..Rcheck
rm -rf pragmastat/src/*.o pragmastat/src/*.so pragmastat/src/*.dll
rm -rf pragmastat/inst/testdata pragmastat/tests/tests
"""

[tasks."r:restore"]
description = "Install R package locally"
dir = "r/pragmastat"
run = "Rscript -e \"if (!requireNamespace('devtools', quietly = TRUE)) install.packages('devtools', repos = 'https://cloud.r-project.org'); devtools::install()\""

[tasks."r:demo"]
description = "Run R demo"
dir = "r/pragmastat"
run = """
Rscript -e "if (!requireNamespace('devtools', quietly = TRUE)) install.packages('devtools', repos = 'https://cloud.r-project.org'); devtools::install(quiet = TRUE, upgrade = 'never')"
Rscript inst/examples/demo.R
"""

[tasks."r:doc"]
description = "Build R documentation"
dir = "r/pragmastat"
run = "Rscript -e \"if (!requireNamespace('devtools', quietly = TRUE)) install.packages('devtools', repos = 'https://cloud.r-project.org'); devtools::document()\""

[tasks."r:ci"]
description = "Run R CI pipeline"
run = [
    { task = "r:clean" },
    { task = "r:check" },
    { task = "r:build" },
    { task = "r:test" },
]

# ==========================================================================
# Rust Tasks (rs/)
# ==========================================================================

[tasks."rs:build"]
description = "Build Rust package (debug mode)"
dir = "rs/pragmastat"
run = "cargo build"

[tasks."rs:build:release"]
description = "Build Rust package (release mode)"
dir = "rs/pragmastat"
run = "cargo build --release"

[tasks."rs:test"]
description = "Run Rust tests"
dir = "rs/pragmastat"
run = "cargo test --verbose"

[tasks."rs:check"]
description = "Check Rust code (clippy, fmt, cargo check)"
dir = "rs/pragmastat"
run = """
cargo clippy -- -D warnings
cargo fmt -- --check
cargo check
"""

[tasks."rs:check:fix"]
description = "Format Rust code"
dir = "rs/pragmastat"
run = "cargo fmt"

[tasks."rs:clean"]
description = "Clean Rust build artifacts"
dir = "rs/pragmastat"
run = """
cargo clean
rm -rf Cargo.lock
"""

[tasks."rs:demo"]
description = "Run Rust demo"
dir = "rs/pragmastat"
run = "cargo run --example demo"

[tasks."rs:bench"]
description = "Run Rust benchmarks"
dir = "rs/pragmastat"
run = "cargo bench"

[tasks."rs:gen:rng-tests"]
description = "Generate RNG and distribution reference test files"
dir = "rs/pragmastat"
run = "cargo run --example gen_rng_tests"

[tasks."rs:doc"]
description = "Build Rust documentation"
dir = "rs/pragmastat"
run = "cargo doc --no-deps"

[tasks."rs:pack"]
description = "Package Rust crate"
dir = "rs/pragmastat"
run = "cargo package --verbose"

[tasks."rs:publish:dry"]
description = "Dry run of publishing Rust crate"
dir = "rs/pragmastat"
run = "cargo publish --dry-run"

[tasks."rs:ci"]
description = "Run Rust CI pipeline"
run = [
    { task = "rs:clean" },
    { task = "rs:check" },
    { task = "rs:build" },
    { task = "rs:test" },
]

# ==========================================================================
# TypeScript Tasks (ts/)
# ==========================================================================

[tasks."ts:build"]
description = "Build TypeScript package"
dir = "ts"
run = "pnpm build"

[tasks."ts:test"]
description = "Run TypeScript tests"
dir = "ts"
run = "pnpm test"

[tasks."ts:check"]
description = "Check TypeScript code (lint and format)"
dir = "ts"
run = """
pnpm lint
pnpm format:check
"""

[tasks."ts:check:fix"]
description = "Format TypeScript code"
dir = "ts"
run = "pnpm format"

[tasks."ts:clean"]
description = "Clean TypeScript build artifacts"
dir = "ts"
run = "pnpm clean"

[tasks."ts:restore"]
description = "Install TypeScript dependencies"
dir = "ts"
run = "pnpm install --frozen-lockfile"

[tasks."ts:demo"]
description = "Run TypeScript demo"
dir = "ts"
run = "pnpm exec ts-node examples/demo.ts"

[tasks."ts:coverage"]
description = "Run TypeScript tests with coverage"
dir = "ts"
run = "pnpm test:coverage"

[tasks."ts:pack"]
description = "Package TypeScript npm tarball"
dir = "ts"
run = "pnpm pack"

[tasks."ts:ci"]
description = "Run TypeScript CI pipeline"
run = [
    { task = "ts:clean" },
    { task = "ts:restore" },
    { task = "ts:check" },
    { task = "ts:build" },
    { task = "ts:test" },
]

# ==========================================================================
# Image Generation Tasks (img/)
# ==========================================================================

[tasks."img:build"]
description = "Generate images"
dir = "img"
run = """
if [ ! -d "venv" ] && [ ! -f "/.dockerenv" ] && [ -z "$VIRTUAL_ENV" ]; then
    python3 -m venv venv
    ./venv/bin/pip install -q --upgrade pip
    ./venv/bin/pip install -q -r requirements.txt
fi
if [ -d "venv" ]; then
    ./venv/bin/python3 generate-images.py
else
    python3 generate-images.py
fi
"""

[tasks."img:logo"]
description = "Generate logo PNG files from SVG"
run = "cargo run --manifest-path tools/Cargo.toml --release -- build img"

[tasks."img:clean"]
description = "Clean generated images"
dir = "img"
run = """
find . -maxdepth 1 -type f \\( -name "*.png" -o -name "*.jpg" -o -name "*.ico" \\) -delete 2>/dev/null || true
rm -rf venv
"""

# ==========================================================================
# Documentation Generation Tasks
# ==========================================================================

[tasks."docs:version"]
description = "Sync versioned manifests"
run = "cargo run --manifest-path tools/Cargo.toml --release -- sync version"

[tasks."docs:templates"]
description = "Sync templated docs and READMEs"
run = "cargo run --manifest-path tools/Cargo.toml --release -- sync templates"

[tasks."docs:sync"]
description = "Sync versions and templated docs"
run = "cargo run --manifest-path tools/Cargo.toml --release -- sync all"

[tasks."pdf:restore"]
description = "Download required fonts for PDF generation"
run = """
if [ ! -d "manual/fonts/Ubuntu" ] || [ ! -d "manual/fonts/Vollkorn" ]; then
  mkdir -p manual/fonts/Ubuntu manual/fonts/Vollkorn
  FONTS_BASE="https://raw.githubusercontent.com/google/fonts/main"
  echo "Downloading Ubuntu font..."
  curl -sL -o manual/fonts/Ubuntu/Ubuntu-Regular.ttf "${FONTS_BASE}/ufl/ubuntu/Ubuntu-Regular.ttf"
  curl -sL -o manual/fonts/Ubuntu/Ubuntu-Bold.ttf "${FONTS_BASE}/ufl/ubuntu/Ubuntu-Bold.ttf"
  curl -sL -o manual/fonts/Ubuntu/Ubuntu-Light.ttf "${FONTS_BASE}/ufl/ubuntu/Ubuntu-Light.ttf"
  curl -sL -o manual/fonts/Ubuntu/Ubuntu-Italic.ttf "${FONTS_BASE}/ufl/ubuntu/Ubuntu-Italic.ttf"
  echo "Downloading Vollkorn font..."
  VOLLKORN_BASE="https://cdn.jsdelivr.net/fontsource/fonts/vollkorn@latest/latin"
  curl -sL -o manual/fonts/Vollkorn/Vollkorn-Regular.ttf "${VOLLKORN_BASE}-400-normal.ttf"
  curl -sL -o manual/fonts/Vollkorn/Vollkorn-Bold.ttf "${VOLLKORN_BASE}-700-normal.ttf"
  curl -sL -o manual/fonts/Vollkorn/Vollkorn-Italic.ttf "${VOLLKORN_BASE}-400-italic.ttf"
  curl -sL -o manual/fonts/Vollkorn/Vollkorn-BoldItalic.ttf "${VOLLKORN_BASE}-700-italic.ttf"
  echo "Fonts installed."
else
  echo "Fonts already installed."
fi
"""

[tasks."pdf:build"]
description = "Build PDF manual"
depends = ["pdf:restore", "docs:sync", "img:build"]
run = "typst compile --root . --font-path manual/fonts manual/template.typ manual/pragmastat.pdf"

[tasks."pdf:build:release"]
description = "Build PDF manual (release mode)"
depends = ["pdf:restore", "docs:sync", "img:build"]
run = "typst compile --root . --font-path manual/fonts manual/template.typ manual/pragmastat.pdf"

[tasks."web:gen"]
description = "Generate Astro content"
depends = ["docs:sync"]
run = "cargo run --manifest-path tools/Cargo.toml --release -- build web"

[tasks."web:restore"]
description = "Install web dependencies"
dir = "web"
run = "pnpm install"

[tasks."web:dev"]
description = "Start Astro dev server"
depends = ["web:restore", "web:gen"]
dir = "web"
run = "pnpm dev"

[tasks."web:serve"]
description = "Alias for web:dev"
depends = ["web:restore", "web:gen"]
dir = "web"
run = "pnpm dev"

[tasks."web:build"]
description = "Build Astro site"
depends = ["web:restore", "web:gen"]
dir = "web"
run = """
cp ../manual/pragmastat.pdf public/
cp ../img/logo.svg public/img/
pnpm build
"""

[tasks."web:build:release"]
description = "Build Astro site (release mode)"
depends = ["web:restore", "web:gen"]
dir = "web"
run = """
cp ../manual/pragmastat.pdf public/
cp ../img/logo.svg public/img/
NODE_ENV=production pnpm build
"""

[tasks."web:clean"]
description = "Clean Astro build artifacts"
dir = "web"
run = """
rm -rf dist .astro .output
"""

[tasks."docs:clean"]
description = "Clean generated documentation artifacts"
run = "cargo run --manifest-path tools/Cargo.toml --release -- clean"

[tasks."docs:ci"]
description = "Run documentation CI pipeline"
run = [
    { task = "docs:clean" },
    { task = "docs:sync" },
    { task = "pdf:build" },
    { task = "web:build" },
]

# ==========================================================================
# Aggregate Tasks
# ==========================================================================

[tasks."build"]
description = "Build all language implementations"
depends = ["cs:build", "go:build", "kt:build", "py:build", "r:build", "rs:build", "ts:build"]

[tasks."test"]
description = "Test all language implementations"
depends = ["cs:test", "go:test", "kt:test", "py:test", "r:test", "rs:test", "ts:test"]

[tasks."check"]
description = "Check all language implementations"
depends = ["cs:check", "go:check", "kt:check", "py:check", "r:check", "rs:check", "ts:check"]

[tasks."clean"]
description = "Clean all build artifacts"
depends = ["cs:clean", "go:clean", "kt:clean", "py:clean", "r:clean", "rs:clean", "ts:clean", "img:clean", "web:clean", "docs:clean"]

[tasks."demo"]
description = "Run demos for all language implementations"
depends = ["cs:demo", "go:demo", "kt:demo", "py:demo", "r:demo", "rs:demo", "ts:demo"]

[tasks."ci"]
description = "Run CI pipeline for all language implementations"
depends = ["cs:ci", "go:ci", "kt:ci", "py:ci", "r:ci", "rs:ci", "ts:ci", "docs:ci"]

# ==========================================================================
# Publish Task
# ==========================================================================

[tasks."publish"]
description = "Publish a new version"
file = ".mise/tasks/publish"

# ==========================================================================
# Docker Tasks
# ==========================================================================

[tasks."docker:build"]
description = "Build all Docker images"
run = "docker compose build"

[tasks."docker:clean"]
description = "Remove all Docker containers and images"
run = "docker compose down --rmi all --volumes --remove-orphans"
