<!DOCTYPE html><html lang="en" data-astro-cid-37fxchfa> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Pragmatic Statistical Toolkit"><title>Algorithms | Pragmastat</title><link rel="icon" type="image/svg+xml" href="/img/logo.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css" crossorigin="anonymous"><!-- Prevent flash of wrong theme / sidebar state / background color --><script>
      (function() {
        const stored = localStorage.getItem('pragmastat-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        // Set background color immediately to prevent flash
        document.documentElement.style.backgroundColor = theme === 'light' ? '#fcfcfc' : '#242936';
        if (stored) {
          document.documentElement.setAttribute('data-theme-setting', stored);
        }
        // Pre-set sidebar collapsed state to prevent layout shift
        if (localStorage.getItem('pragmastat-sidebar-collapsed') === 'true') {
          document.documentElement.setAttribute('data-sidebar-collapsed', '');
        }
      })();
    </script><link rel="stylesheet" href="/_astro/_slug_.DCZT5byF.css">
<link rel="stylesheet" href="/_astro/_slug_.WLFREvr1.css"></head> <body data-astro-cid-37fxchfa>  <div class="layout" id="docs-layout" data-astro-cid-mw7aashj> <aside class="sidebar-container" data-astro-cid-mw7aashj> <nav class="sidebar" aria-label="Main navigation" data-astro-cid-ssfzsv2f> <div class="sidebar-header" data-astro-cid-ssfzsv2f> <a href="/" class="logo" data-astro-cid-tvrurpns>
Pragmastat
</a>  <div class="sidebar-controls" data-astro-cid-ssfzsv2f> <a href="https://github.com/AndreyAkinshin/pragmastat" class="github-button" target="_blank" rel="noopener noreferrer" aria-label="GitHub repository" data-astro-cid-xtw5atjx> <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-astro-cid-xtw5atjx> <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" data-astro-cid-xtw5atjx></path> </svg> </a>  <div class="theme-switcher" data-astro-cid-dz5h74bc> <button class="theme-button" id="theme-button" aria-label="Toggle theme" aria-haspopup="true" data-astro-cid-dz5h74bc> <svg class="icon icon-system" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg> <svg class="icon icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg> <svg class="icon icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg> </button> <div class="theme-dropdown" id="theme-dropdown" data-astro-cid-dz5h74bc> <button class="theme-option" data-theme="system" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg>
System
</button> <button class="theme-option" data-theme="light" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg>
Light
</button> <button class="theme-option" data-theme="dark" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg>
Dark
</button> </div> </div> <script type="module">const n=document.getElementById("theme-button"),o=document.getElementById("theme-dropdown"),s=document.querySelectorAll(".theme-option"),a=document.documentElement;function m(e){return e==="light"||e==="dark"?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function c(e){document.querySelector(".theme-switcher")?.setAttribute("data-setting",e||"system")}function r(e){const t=m(e);a.setAttribute("data-theme",t),e?(a.setAttribute("data-theme-setting",e),localStorage.setItem("pragmastat-theme",e)):(a.removeAttribute("data-theme-setting"),localStorage.removeItem("pragmastat-theme")),c(e)}const d=localStorage.getItem("pragmastat-theme");c(d);n?.addEventListener("click",()=>{o?.classList.toggle("open")});document.addEventListener("click",e=>{!n?.contains(e.target)&&!o?.contains(e.target)&&o?.classList.remove("open")});s.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-theme");r(t==="system"?null:t),o?.classList.remove("open")})});window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{localStorage.getItem("pragmastat-theme")||r(null)});</script>  <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="true" data-astro-cid-lp5naqcd> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-lp5naqcd> <polyline points="11 17 6 12 11 7" data-astro-cid-lp5naqcd></polyline> <polyline points="18 17 13 12 18 7" data-astro-cid-lp5naqcd></polyline> </svg> </button>  </div> </div> <div class="sidebar-section" data-astro-cid-ssfzsv2f> <ul class="sidebar-list" data-astro-cid-ssfzsv2f> <li data-astro-cid-ssfzsv2f> <a href="/introduction" class="sidebar-link" data-astro-cid-ssfzsv2f> Introduction </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/estimators" class="sidebar-link" data-astro-cid-ssfzsv2f> Estimators </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/distributions" class="sidebar-link" data-astro-cid-ssfzsv2f> Distributions </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/properties" class="sidebar-link" data-astro-cid-ssfzsv2f> Properties </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/methodology" class="sidebar-link" data-astro-cid-ssfzsv2f> Methodology </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/algorithms" class="sidebar-link active" aria-current="page" data-astro-cid-ssfzsv2f> Algorithms </a> <ul class="sidebar-sublist" data-astro-cid-ssfzsv2f> <li data-astro-cid-ssfzsv2f> <a href="#fast-center" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> Fast Center </a> </li><li data-astro-cid-ssfzsv2f> <a href="#fast-spread" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> Fast Spread </a> </li><li data-astro-cid-ssfzsv2f> <a href="#fast-shift" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> Fast Shift </a> </li><li data-astro-cid-ssfzsv2f> <a href="#fast-pairwisemargin" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> Fast PairwiseMargin </a> </li> </ul> </li><li data-astro-cid-ssfzsv2f> <a href="/studies" class="sidebar-link" data-astro-cid-ssfzsv2f> Studies </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/implementations" class="sidebar-link" data-astro-cid-ssfzsv2f> Implementations </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/tests" class="sidebar-link" data-astro-cid-ssfzsv2f> Tests </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/artifacts" class="sidebar-link" data-astro-cid-ssfzsv2f> Artifacts </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/bibliography" class="sidebar-link" data-astro-cid-ssfzsv2f> Bibliography </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/colophon" class="sidebar-link" data-astro-cid-ssfzsv2f> Colophon </a>  </li> </ul> </div> </nav>  </aside> <main class="main-content" data-astro-cid-mw7aashj> <article class="content" data-astro-cid-mw7aashj> <h1 data-astro-cid-mw7aashj>Algorithms</h1>  <p>This chapter describes the core algorithms that power the robust estimators in the toolkit. Both algorithms solve a fundamental computational challenge: how to efficiently find medians within large collections of derived values without materializing the entire collection in memory.</p>
<h2 id="fast-center">Fast Center</h2>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Center}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">Center</span></span></span></span></span> estimator computes the median of all pairwise averages from a sample. Given a dataset <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">x = (x_{1}, x_{2}, \ldots, x_{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, this estimator is defined as:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi mathvariant="normal">median</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>≤</mo><mi>j</mi><mo>≤</mo><mi>n</mi></mrow></msub><mfrac><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><msub><mi>x</mi><mi>j</mi></msub></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\operatorname{Center}(\mathbf{x}) = \operatorname{median}_{1 \leq i \leq j \leq n} \frac{x_{i} + x_{j}}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Center</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.9463em;vertical-align:-0.686em"></span><span class="mop"><span class="mop"><span class="mord mathrm">median</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2603em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>A direct implementation would generate all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">n(n+1)/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">/2</span></span></span></span> pairwise averages and sort them. With <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>10000</mn></mrow><annotation encoding="application/x-tex">n = 10000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">10000</span></span></span></span>, this approach creates approximately 50 million values, requiring quadratic memory and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^{2} log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> time.</p>
<p>The breakthrough came in 1984 when John Monahan developed an algorithm that reduces expected complexity to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> while using only linear memory (see <span class="citation" data-key="monahan1984">Monahan 1984</span>). The algorithm exploits the inherent structure in pairwise sums rather than computing them explicitly. After sorting the values <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>x</mi><mn>2</mn></msub><mo>≤</mo><mo>…</mo><mo>≤</mo><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">x_{1} \leq x_{2} \leq \ldots \leq x_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, the algorithm considers the implicit upper triangular matrix <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">M</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">M_{i,j} = x_{i} + x_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>≤</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i \leq j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7955em;vertical-align:-0.136em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span></span>. This matrix has a crucial property: each row and column is sorted in non-decreasing order, enabling efficient median selection without storing the matrix.</p>
<p>Rather than sorting all pairwise sums, the algorithm uses a selection approach similar to quickselect. It maintains search bounds for each matrix row and iteratively narrows the search space. For each row <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span>, the algorithm tracks active column indices from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span>, defining which pairwise sums remain candidates for the median. It selects a candidate sum as a pivot using randomized selection from active matrix elements, then counts how many pairwise sums fall below the pivot. Because both rows and columns are sorted, this counting takes only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> time using a two-pointer sweep from the matrixs upper-right corner.</p>
<p>The median corresponds to rank <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mo stretchy="false">⌊</mo><mfrac><mrow><mi>N</mi><mo>+</mo><mn>1</mn></mrow><mn>2</mn></mfrac><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">k = \lfloor \frac{N+1}{2} \rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em"></span><span class="mopen">⌊</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">N = n(n+1)/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">/2</span></span></span></span>. If fewer than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> sums lie below the pivot, the median must be larger; if more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> sums lie below the pivot, the median must be smaller. Based on this comparison, the algorithm eliminates portions of each row that cannot contain the median, shrinking the active search space while preserving the true median.</p>
<p>Real data often contain repeated values, which can cause the selection process to stall. When the algorithm detects no progress between iterations, it switches to a midrange strategy: find the smallest and largest pairwise sums still in the search space, then use their average as the next pivot. If the minimum equals the maximum, all remaining candidates are identical and the algorithm terminates. This tie-breaking mechanism ensures reliable convergence with discrete or duplicated data.</p>
<p>The algorithm achieves <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> time complexity through linear partitioning (each pivot evaluation requires only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> operations) and logarithmic iterations (randomized pivot selection leads to expected <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> iterations, similar to quickselect). The algorithm maintains only row bounds and counters, using <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> additional space. This matches the complexity of sorting a single array while avoiding the quadratic memory and time explosion of computing all pairwise combinations.</p>
<pre class="astro-code astro-code-themes kanagawa-lotus nord" style="background-color:#F2ECBC;--shiki-dark-bg:#2e3440ff;color:#545464;--shiki-dark:#d8dee9ff;overflow-x:auto" tabindex="0" data-language="cs"><code><span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">namespace</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Pragmastat</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Algorithms</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">internal</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#624C83;--shiki-dark:#81A1C1"> class</span><span style="color:#597B75;--shiki-dark:#8FBCBB"> FastCenter</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">{</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// ACM Algorithm 616: fast computation of the Hodges-Lehmann location estimator</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">remarks</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// Computes the median of all pairwise averages (xi + xj)/2 efficiently.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// See: John F Monahan, &quot;Algorithm 616: fast computation of the Hodges-Lehmann location estimator&quot;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// (1984) DOI: 10.1145/1271.319414</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">remarks</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#624C83;--shiki-dark:#8FBCBB"> name</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">=</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">values</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span><span style="color:#716E61;--shiki-dark:#616E88">A sorted sample of values</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#624C83;--shiki-dark:#8FBCBB"> name</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">=</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">random</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span><span style="color:#716E61;--shiki-dark:#616E88">Random number generator</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#624C83;--shiki-dark:#8FBCBB"> name</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">=</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">isSorted</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span><span style="color:#716E61;--shiki-dark:#616E88">If values are sorted</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">returns</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span><span style="color:#716E61;--shiki-dark:#616E88">Exact center value (Hodges-Lehmann estimator)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">returns</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Estimate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">?</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> random</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> null</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> isSorted</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> false</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    random</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ??=</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#77713F;--shiki-dark:#81A1C1">!</span><span style="color:#545464;--shiki-dark:#D8DEE9">isSorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      values</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">OrderBy</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">x</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =&gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">).</span><span style="color:#4D699B;--shiki-dark:#88C0D0">ToList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Calculate target median rank(s) among all pairwise sums</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> totalPairs</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> medianRankLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">totalPairs</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // For odd totalPairs, this is the median</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> medianRankHigh</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      (</span><span style="color:#545464;--shiki-dark:#D8DEE9">totalPairs</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // For even totalPairs, average of ranks medianRankLow and medianRankHigh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Initialize search bounds for each row in the implicit matrix</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> leftBounds</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rightBounds</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> partitionCounts</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // Row i can pair with columns [i+1..n] (1-based indexing)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // Initially, all columns are available</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Start with a good pivot: sum of middle elements (handles both odd and even n)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> activeSetSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> totalPairs</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> previousCount</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#CC6D00;--shiki-dark:#81A1C1">true</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === PARTITION STEP ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // Count pairwise sums less than current pivot</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> countBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> currentColumn</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        partitionCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Move left from current column until we find sums &lt; pivot</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // This exploits the sorted nature of the matrix</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">currentColumn</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">currentColumn</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          currentColumn</span><span style="color:#77713F;--shiki-dark:#81A1C1">--</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Count elements in this row that are &lt; pivot</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">currentColumn</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> elementsBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> currentColumn</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          partitionCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> elementsBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          countBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> elementsBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === CONVERGENCE CHECK ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // If no progress, we have ties - break them using midrange strategy</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> previousCount</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MinValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Find the range of sums still in the active search space</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // Skip empty rows</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> smallestInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> largestInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          minActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Min</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">minActiveSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestInRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          maxActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Max</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">maxActiveSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestInRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActiveSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActiveSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActiveSum</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // If all remaining values are identical, we&#39;re done</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActiveSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> activeSetSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === TARGET CHECK ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // Check if we&#39;ve found the median rank(s)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> atTargetRank</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> medianRankLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> medianRankHigh</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">atTargetRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Find the boundary values: largest &lt; pivot and smallest &gt;= pivot</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> largestBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MinValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> smallestAtOrAbovePivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> countInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> partitionCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> totalInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Find largest sum in this row that&#39;s &lt; pivot</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">            long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> lastBelowIndex</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">            double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> lastBelowValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">lastBelowIndex</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            largestBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Max</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">largestBelowPivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lastBelowValue</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Find smallest sum in this row that&#39;s &gt;= pivot</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> totalInRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">            long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> firstAtOrAboveIndex</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countInRow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">            double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> firstAtOrAboveValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">firstAtOrAboveIndex</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            smallestAtOrAbovePivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Min</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">smallestAtOrAbovePivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> firstAtOrAboveValue</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Calculate final result based on whether we have odd or even number of pairs</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">medianRankLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> medianRankHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Even total: average the two middle values</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">smallestAtOrAbovePivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelowPivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 4</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Odd total: return the single middle value</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> needLargest</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> medianRankLow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">needLargest</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> largestBelowPivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbovePivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === UPDATE BOUNDS ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // Narrow the search space based on partition result</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelowPivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> medianRankLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Too few values below pivot - eliminate smaller values, search higher</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> partitionCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Too many values below pivot - eliminate larger values, search lower</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> partitionCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === PREPARE NEXT ITERATION ===</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      previousCount</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelowPivot</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // Recalculate how many elements remain in the active search space</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      activeSetSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        activeSetSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Max</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowSize</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // Choose next pivot based on remaining active set size</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">activeSetSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Use randomized row median strategy for efficiency</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Handle large activeSetSize by using double precision for random selection</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> randomFraction</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">NextDouble</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> targetIndex</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)(</span><span style="color:#545464;--shiki-dark:#D8DEE9">randomFraction</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> activeSetSize</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> selectedRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Find which row contains the target index</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> cumulativeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Max</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">targetIndex</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> cumulativeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowSize</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            selectedRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">            break</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          cumulativeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowSize</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Use median element of the selected row as pivot</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> medianColumnInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">selectedRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">selectedRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">selectedRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">medianColumnInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Few elements remain - use midrange strategy</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minRemainingSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxRemainingSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MinValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // Skip empty rows</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">leftBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxInRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rightBounds</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowValue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          minRemainingSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Min</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">minRemainingSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minInRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          maxRemainingSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Max</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">maxRemainingSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxInRow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minRemainingSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRemainingSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minRemainingSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRemainingSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRemainingSum</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minRemainingSum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRemainingSum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">}</span></span></code></pre>
<h2 id="fast-spread">Fast Spread</h2>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> estimator computes the median of all pairwise absolute differences. Given a sample <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">x = (x_{1}, x_{2}, \ldots, x_{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, this estimator is defined as:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi mathvariant="normal">median</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo>≤</mo><mi>n</mi></mrow></msub><mrow><mo fence="true">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>x</mi><mi>j</mi></msub><mo fence="true">∣</mo></mrow></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x}) = \operatorname{median}_{1 \leq i &lt; j \leq n} \left|x_{i} - x_{j}\right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mop"><span class="mop"><span class="mord mathrm">median</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em">∣</span></span></span></span></span></span>
<p>Like <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Center}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">Center</span></span></span></span></span>, computing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> naively requires generating all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">n(n-1)/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">/2</span></span></span></span> pairwise differences, sorting them, and finding the median — a quadratic approach that becomes computationally prohibitive for large datasets.</p>
<p>The same structural principles that accelerate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Center}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">Center</span></span></span></span></span> computation also apply to pairwise differences, yielding an exact <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> algorithm. After sorting the input to obtain <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>y</mi><mn>2</mn></msub><mo>≤</mo><mo>…</mo><mo>≤</mo><msub><mi>y</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">y_{1} \leq y_{2} \leq \ldots \leq y_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, all pairwise absolute differences <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>x</mi><mi>j</mi></msub><mo fence="true">∣</mo></mrow><annotation encoding="application/x-tex">\left|x_{i} - x_{j}\right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em">∣</span></span></span></span></span> with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i &lt; j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span></span> become positive differences <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>j</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_{j} - y_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>. This allows considering the implicit upper triangular matrix <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>y</mi><mi>j</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">D_{i,j} = y_{j} - y_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i &lt; j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span></span>. This matrix has a crucial structural property: for a fixed row <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span>, differences increase monotonically, while for a fixed column <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span></span>, differences decrease as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span> increases. This sorted structure enables linear-time counting of elements below any threshold.</p>
<p>The algorithm applies Monahans selection strategy, adapted for differences rather than sums. For each row <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span>, it tracks active column indices representing differences still under consideration, initially spanning columns <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span> through <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span>. It chooses candidate differences from the active set using weighted random row selection, maintaining expected logarithmic convergence while avoiding expensive pivot computations. For any pivot value <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>, the number of differences falling below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> is counted using a single sweep; the monotonic structure ensures this counting requires only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> operations. While counting, the largest difference below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> and the smallest difference at or above <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> are maintained — these boundary values become the exact answer when the target rank is reached.</p>
<p>The algorithm naturally handles both odd and even cases. For an odd number of differences, it returns the single middle element when the count exactly hits the median rank. For an even number of differences, it returns the average of the two middle elements; boundary tracking during counting provides both values simultaneously. Unlike approximation methods, this algorithm returns the precise median of all pairwise differences; randomness affects only performance, not correctness.</p>
<p>The algorithm includes the same stall-handling mechanisms as the center algorithm. It tracks whether the count below the pivot changes between iterations; when progress stalls due to tied values, it computes the range of remaining active differences and pivots to their midrange. This midrange strategy ensures convergence even with highly discrete data or datasets with many identical values.</p>
<p>Several optimizations make the implementation practical for production use. A global column pointer that never moves backward during counting exploits the matrix structure to avoid redundant comparisons. Exact boundary values are captured during each counting pass, eliminating the need for additional searches when the target rank is reached. Using only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> additional space for row bounds and counters, the algorithm achieves <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> time complexity with minimal memory overhead, making robust scale estimation practical for large datasets.</p>
<pre class="astro-code astro-code-themes kanagawa-lotus nord" style="background-color:#F2ECBC;--shiki-dark-bg:#2e3440ff;color:#545464;--shiki-dark:#d8dee9ff;overflow-x:auto" tabindex="0" data-language="cs"><code><span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">namespace</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Pragmastat</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Algorithms</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">internal</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#624C83;--shiki-dark:#81A1C1"> class</span><span style="color:#597B75;--shiki-dark:#8FBCBB"> FastSpread</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">{</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// Shamos &quot;Spread&quot;.  Expected O(n log n) time, O(n) extra space. Exact.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Estimate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">?</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> random</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> null</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> isSorted</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> false</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Abs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    random</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ??=</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Prepare a sorted working copy.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> isSorted</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CopySorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> EnsureSorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Total number of pairwise differences with i &lt; j</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> N</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">N</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // 1-based rank of lower middle</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> kHigh</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">N</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // 1-based rank of upper middle</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Per-row active bounds over columns j (0-based indices).</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Row i allows j in [i+1, n-1] initially.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> L</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> R</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowCounts</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // # of elements in row i that are &lt; pivot (for current partition)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Min</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // n means empty</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // inclusive</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span><span style="color:#716E61;--shiki-dark:#616E88"> // mark empty</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // A reasonable initial pivot: a central gap</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> prevCountBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD">1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#CC6D00;--shiki-dark:#81A1C1">true</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === PARTITION: count how many differences are &lt; pivot; also track boundary neighbors ===</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // max difference &lt; pivot</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> smallestAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // min difference &gt;= pivot</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // global two-pointer (non-decreasing across rows)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        rowCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> cntRow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> cntRow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // boundary elements for this row</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // last &lt; pivot in this row is (j-1)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> candBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">candBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> candBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> candAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">candAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> candAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === TARGET CHECK ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // If we&#39;ve split exactly at the middle, we can return using the boundaries we just found.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> atTarget</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#716E61;--shiki-dark:#616E88"> // lower middle is the largest &lt; pivot</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kHigh</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // upper middle is the smallest &gt;= pivot</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">atTarget</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Even N: average the two central order stats.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Odd N: pick the single middle depending on which side we hit.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> needLargest</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> needLargest</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === STALL HANDLING (ties / no progress) ===</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> prevCountBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Compute min/max remaining difference in the ACTIVE set and pivot to their midrange.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> active</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Li</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">],</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Ri</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">Li</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> Ri</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">Li</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">Ri</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowMin</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowMax</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          active</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">Ri</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> Li</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">active</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // No active candidates left: the only consistent answer is the boundary implied by counts.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Fall back to neighbors from this partition.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">maxActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // all remaining equal</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        prevCountBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === SHRINK ACTIVE WINDOW ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // --- SHRINK ACTIVE WINDOW (fixed) ---</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Need larger differences: discard all strictly below pivot.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // First j with a[j] - a[i] &gt;= pivot is j = i + 1 + cntRow (may be n =&gt; empty row)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> newL</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">newL</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> newL</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // do NOT clamp; allow L[i] == n to mean empty</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          }</span><span style="color:#716E61;--shiki-dark:#616E88"> // mark empty</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Too many below: keep only those strictly below pivot.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Last j with a[j] - a[i] &lt; pivot is j = i + cntRow  (not cntRow-1!)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> newR</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">newR</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> newR</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // shrink downward to the true last-below</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          }</span><span style="color:#716E61;--shiki-dark:#616E88"> // empty row if none remain</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      prevCountBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === CHOOSE NEXT PIVOT FROM ACTIVE SET (weighted random row, then row median) ===</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#545464;--shiki-dark:#D8DEE9"> activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Few candidates left: return midrange of remaining exactly.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> lo</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> hi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">lo</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minRem</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lo</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">hi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> hi</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#716E61;--shiki-dark:#616E88"> // safety net; fall back to boundary from last partition</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Abs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">((</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Abs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> t</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> NextIndex</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> activeSize</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // 0..activeSize-1</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> acc</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> size</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">t</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> acc</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> size</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> break</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          acc</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> size</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Median column of the selected row</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> col</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;&gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">col</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // --- Helpers ---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CopySorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> v</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNaN</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">v</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">NaN not allowed.</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#77713F;--shiki-dark:#81A1C1"> nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> v</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    Array</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Sort</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> EnsureSorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Trust caller; still copy to array for fast indexed access.</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> v</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNaN</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">v</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">NaN not allowed.</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#77713F;--shiki-dark:#81A1C1"> nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> v</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> NextIndex</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Random</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> limitExclusive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Uniform 0..limitExclusive-1 even for large ranges.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Use rejection sampling for correctness.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    ulong</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> uLimit</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">limitExclusive</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">uLimit</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Next</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">((</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">uLimit</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#CC6D00;--shiki-dark:#81A1C1">true</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      ulong</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> ((</span><span style="color:#545464;--shiki-dark:#81A1C1">ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)(</span><span style="color:#545464;--shiki-dark:#81A1C1">uint</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Next</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;&lt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 32</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> |</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">uint</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Next</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      ulong</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> r</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> %</span><span style="color:#545464;--shiki-dark:#D8DEE9"> uLimit</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> r</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#81A1C1"> ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> %</span><span style="color:#545464;--shiki-dark:#D8DEE9"> uLimit</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">r</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">}</span></span></code></pre>
<h2 id="fast-shift">Fast Shift</h2>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Shift</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Shift}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm">Shift</span></span></span></span></span> estimator measures the median of all pairwise differences between elements of two samples. Given samples <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (x_{1}, x_{2}, \ldots, x_{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>m</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{y} = (y_{1}, y_{2}, \ldots, y_{m})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, this estimator is defined as:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Shift</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo separator="true">,</mo><mi mathvariant="bold">y</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi mathvariant="normal">median</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mn>1</mn><mo>≤</mo><mi>j</mi><mo>≤</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\operatorname{Shift}(\mathbf{x}, \mathbf{y}) = \operatorname{median}_{1 \leq i \leq n, 1 \leq j \leq m} (x_{i} - y_{j})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Shift</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mop"><span class="mop"><span class="mord mathrm">median</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>
<p>This definition represents a special case of a more general problem: computing arbitrary quantiles of all pairwise differences. For samples of size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span>, the total number of pairwise differences is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">n \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span>. A naive approach would materialize all differences, sort them, and extract the desired quantile. With <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>m</mi><mo>=</mo><mn>10000</mn></mrow><annotation encoding="application/x-tex">n = m = 10000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">10000</span></span></span></span>, this approach creates 100 million values, requiring quadratic memory and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n m \log(n m))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mclose">))</span></span></span></span> time.</p>
<p>The presented algorithm avoids materializing pairwise differences by exploiting the sorted structure of the samples. After sorting both samples to obtain <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>x</mi><mn>2</mn></msub><mo>≤</mo><mo>…</mo><mo>≤</mo><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">x_{1} \leq x_{2} \leq \ldots \leq x_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>y</mi><mn>2</mn></msub><mo>≤</mo><mo>…</mo><mo>≤</mo><msub><mi>y</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">y_{1} \leq y_{2} \leq \ldots \leq y_{m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, the key insight is that its possible to count how many pairwise differences fall below any threshold without computing them explicitly. This counting operation enables a binary search over the continuous space of possible difference values, iteratively narrowing the search range until it converges to the exact quantile.</p>
<p>The algorithm operates through a value-space search rather than index-space selection. It maintains a search interval <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mtext>searchMin</mtext><mo separator="true">,</mo><mtext>searchMax</mtext><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[\text{searchMin}, \text{searchMax}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord text"><span class="mord">searchMin</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">searchMax</span></span><span class="mclose">]</span></span></span></span>, initialized to the range of all possible differences: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>x</mi><mn>1</mn></msub><mo>−</mo><msub><mi>y</mi><mi>m</mi></msub><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo>−</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[x_{1} - y_{m}, x_{n} - y_{1}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>. At each iteration, it selects a candidate value within this interval and counts how many pairwise differences are less than or equal to this threshold. For the median (quantile <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">p = 0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.5</span></span></span></span>), if fewer than half the differences lie below the threshold, the median must be larger; if more than half lie below, the median must be smaller. Based on this comparison, the search space is reduced by eliminating portions that cannot contain the target quantile.</p>
<p>The counting operation achieves linear complexity via a two-pointer sweep. For a given threshold <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em"></span><span class="mord mathnormal">t</span></span></span></span>, the number of pairs <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span><span class="mclose">)</span></span></span></span> satisfying <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>j</mi></msub><mo>≤</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">x_{i} - y_{j} \leq t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9221em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6151em"></span><span class="mord mathnormal">t</span></span></span></span> is counted. This is equivalent to counting pairs where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>j</mi></msub><mo>≥</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">y_{j} \geq x_{i} - t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9221em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6151em"></span><span class="mord mathnormal">t</span></span></span></span>. For each row <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span> in the implicit matrix of differences, a column pointer advances through the sorted <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span> array while <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>j</mi></msub><mo>&gt;</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">x_{i} - y_{j} &gt; t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8252em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6151em"></span><span class="mord mathnormal">t</span></span></span></span>, stopping at the first position where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>j</mi></msub><mo>≤</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">x_{i} - y_{j} \leq t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9221em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6151em"></span><span class="mord mathnormal">t</span></span></span></span>. All subsequent positions in that row satisfy the condition, contributing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m - j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span><span class="mclose">)</span></span></span></span> pairs to the count for row <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span>. Because both samples are sorted, the column pointer advances monotonically and never backtracks across rows, making each counting pass <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n + m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span> regardless of the total number of differences.</p>
<p>During each counting pass, the algorithm tracks boundary values: the largest difference at or below the threshold and the smallest difference above it. When the count exactly matches the target rank (or the two middle ranks for even-length samples), these boundary values provide the exact answer without additional searches. For Type-7 quantile computation, which interpolates between order statistics, the algorithm collects the necessary boundary values in a single pass and performs linear interpolation: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>w</mi><mo stretchy="false">)</mo><mo>⋅</mo><mtext>lower</mtext><mo>+</mo><mi>w</mi><mo>⋅</mo><mtext>upper</mtext></mrow><annotation encoding="application/x-tex">(1 - w) \cdot \text{lower} + w \cdot \text{upper}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord text"><span class="mord">lower</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal" style="margin-right:0.02691em">w</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord text"><span class="mord">upper</span></span></span></span></span>.</p>
<p>Real datasets often contain discrete or repeated values that can cause search stagnation. The algorithm detects when the search interval stops shrinking between iterations, indicating that multiple pairwise differences share the same value. When the closest difference below the threshold equals the closest above, all remaining candidates are identical and the algorithm terminates immediately. Otherwise, it uses the boundary values from the counting pass to snap the search interval to actual difference values, ensuring reliable convergence even with highly discrete data.</p>
<p>The binary search employs numerically stable midpoint calculations and terminates when the search interval collapses to a single value or when boundary tracking confirms convergence. Iteration limits are included as a safety mechanism, though convergence typically occurs much earlier due to the exponential narrowing of the search space.</p>
<p>The algorithm naturally generalizes to multiple quantiles by computing each one independently. For <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> quantiles with samples of size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span>, the total complexity is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(k(n + m) log L)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">gL</span><span class="mclose">)</span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span></span></span></span> represents the convergence precision. This is dramatically more efficient than the naive <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n m \log(n m))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mclose">))</span></span></span></span> approach, especially for large <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> with small <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span>. The algorithm requires only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> additional space beyond the input arrays, making it practical for large-scale statistical analysis where memory constraints prohibit materializing quadratic data structures.</p>
<pre class="astro-code astro-code-themes kanagawa-lotus nord" style="background-color:#F2ECBC;--shiki-dark-bg:#2e3440ff;color:#545464;--shiki-dark:#d8dee9ff;overflow-x:auto" tabindex="0" data-language="cs"><code><span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">namespace</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Pragmastat</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Algorithms</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">using</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> System</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">using</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> System</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Collections</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Generic</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">using</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> System</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Linq</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">public</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#624C83;--shiki-dark:#81A1C1"> class</span><span style="color:#597B75;--shiki-dark:#8FBCBB"> FastShift</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">{</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// Computes quantiles of all pairwise differences { x_i - y_j }.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// Time: O((m + n) * log(precision)) per quantile. Space: O(1).</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#624C83;--shiki-dark:#8FBCBB"> name</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">=</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">p</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span><span style="color:#716E61;--shiki-dark:#616E88">Probabilities in [0, 1].</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#624C83;--shiki-dark:#8FBCBB"> name</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">=</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">assumeSorted</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span><span style="color:#716E61;--shiki-dark:#616E88">If false, collections will be sorted.</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Estimate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> assumeSorted</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> false</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">x</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> null</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> null</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> p</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> null</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentNullException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">x and y must be non-empty.</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    foreach</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> pk</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> in</span><span style="color:#545464;--shiki-dark:#D8DEE9"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNaN</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">pk</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pk</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pk</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1.0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentOutOfRangeException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#77713F;--shiki-dark:#81A1C1">nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">),</span><span style="color:#6F894E;--shiki-dark:#ECEFF4"> &quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">Probabilities must be within [0, 1].</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> xs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ys</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">assumeSorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      xs</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#77713F;--shiki-dark:#81A1C1"> as</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ??</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">ToArray</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      ys</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#77713F;--shiki-dark:#81A1C1"> as</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ??</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">ToArray</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      xs</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">OrderBy</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">v</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =&gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> v</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">).</span><span style="color:#4D699B;--shiki-dark:#88C0D0">ToArray</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      ys</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">OrderBy</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">v</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =&gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> v</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">).</span><span style="color:#4D699B;--shiki-dark:#88C0D0">ToArray</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> xs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> ys</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> total</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Type-7 quantile: h = 1 + (n-1)*p, then interpolate between floor(h) and ceil(h)</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> requiredRanks</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> SortedSet</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> interpolationParams</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lowerRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#545464;--shiki-dark:#D8DEE9"> upperRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#545464;--shiki-dark:#D8DEE9"> weight</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)[</span><span style="color:#545464;--shiki-dark:#D8DEE9">p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> h</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1.0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">total</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> lowerRank</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">Math</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Floor</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">h</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> upperRank</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">Math</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Ceiling</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">h</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> weight</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> h</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lowerRank</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">lowerRank</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lowerRank</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">upperRank</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> total</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> upperRank</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> total</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      interpolationParams</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">lowerRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> upperRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> weight</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      requiredRanks</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Add</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">lowerRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      requiredRanks</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Add</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">upperRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rankValues</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Dictionary</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    foreach</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rank</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> in</span><span style="color:#545464;--shiki-dark:#D8DEE9"> requiredRanks</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      rankValues</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">rank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> SelectKthPairwiseDiff</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">xs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> ys</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> result</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">      var</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">lowerRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> upperRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> weight</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> interpolationParams</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> lower</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rankValues</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">lowerRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> upper</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rankValues</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">upperRank</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      result</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> weight</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lower</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#B35B79;--shiki-dark:#B48EAD">1.0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> weight</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lower</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> weight</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> upper</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> result</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // Binary search in [min_diff, max_diff] that snaps to actual discrete values.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // Avoids materializing all m*n differences.</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> SelectKthPairwiseDiff</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> k</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> total</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">k</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#D8DEE9"> k</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> total</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentOutOfRangeException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#77713F;--shiki-dark:#81A1C1">nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">k</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> searchMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> searchMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNaN</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">searchMin</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNaN</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">searchMax</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> InvalidOperationException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">NaN in input values.</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    const</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxIterations</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 128</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // Sufficient for double precision convergence</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> prevMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> prevMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> iter</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> iter</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxIterations</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> !=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMax</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> iter</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Midpoint</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">searchMin</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMax</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4D699B;--shiki-dark:#88C0D0">      CountAndNeighbors</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mid</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#624C83;--shiki-dark:#81A1C1"> out</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> countLessOrEqual</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#624C83;--shiki-dark:#81A1C1"> out</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> closestBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#624C83;--shiki-dark:#81A1C1"> out</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> closestAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">closestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> closestAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> closestBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // No progress means we&#39;re stuck between two discrete values</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">searchMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> prevMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> prevMax</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countLessOrEqual</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> k</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> closestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> closestAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      prevMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMin</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      prevMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMax</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countLessOrEqual</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> k</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        searchMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> closestBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        searchMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> closestAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">searchMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> !=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMax</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> InvalidOperationException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">Convergence failure (pathological input).</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> searchMin</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // Two-pointer algorithm: counts pairs where x[i] - y[j] &lt;= threshold, and tracks</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // the closest actual differences on either side of threshold.</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> void</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CountAndNeighbors</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> threshold</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    out</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> countLessOrEqual</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#624C83;--shiki-dark:#81A1C1"> out</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> closestBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#624C83;--shiki-dark:#81A1C1"> out</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> closestAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> count</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> threshold</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        j</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      count</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> j</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> diff</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">diff</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> diff</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> diff</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">diff</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> diff</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Fallback to actual min/max if no boundaries found (shouldn&#39;t happen in normal operation)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">maxBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      maxBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsPositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">minAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      minAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> x</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> y</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    countLessOrEqual</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> count</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    closestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    closestAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Midpoint</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> b</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =&gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">b</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">}</span></span></code></pre>
<h2 id="fast-pairwisemargin">Fast PairwiseMargin</h2>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">PairwiseMargin</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{PairwiseMargin}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">PairwiseMargin</span></span></span></span></span> function determines how many extreme pairwise differences to exclude when constructing bounds around <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Shift</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo separator="true">,</mo><mi mathvariant="bold">y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\operatorname{Shift}(\mathbf{x}, \mathbf{y})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Shift</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span><span class="mclose">)</span></span></span></span>. Given samples <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (x_{1}, \ldots, x_{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>m</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{y} = (y_{1}, \ldots, y_{m})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ShiftBounds</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{ShiftBounds}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm">ShiftBounds</span></span></span></span></span> estimator computes all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">n m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">nm</span></span></span></span> pairwise differences <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">z_{i j} = x_{i} - y_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> and sorts them. The bounds select specific order statistics from this sorted sequence: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>z</mi><mrow><mo stretchy="false">(</mo><msub><mi>k</mi><mtext>left</mtext></msub><mo stretchy="false">)</mo></mrow></msub><mo separator="true">,</mo><msub><mi>z</mi><mrow><mo stretchy="false">(</mo><msub><mi>k</mi><mtext>right</mtext></msub><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[z_{(k_{\text{left}})}, z_{(k_{\text{right}})}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1333em;vertical-align:-0.3833em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.5198em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3488em;margin-left:-0.0315em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">left</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.5198em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3488em;margin-left:-0.0315em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">right</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3833em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>. The challenge lies in determining which order statistics produce bounds that contain the true shift <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Shift</mi><mo>⁡</mo><mo stretchy="false">[</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\operatorname{Shift}[X, Y]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Shift</span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span><span class="mclose">]</span></span></span></span> with probability <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow></mrow><annotation encoding="application/x-tex">1 - \mathrm{misrate}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span></span></span></span>.</p>
<p>Random sampling creates natural variation in pairwise differences. Even when populations have identical distributions, sampling variation produces both positive and negative differences. The margin function quantifies this sampling variability: it specifies how many extreme pairwise differences could occur by chance with probability <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span></span></span></span>. For symmetric bounds, this margin splits evenly between the tails, giving <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mtext>left</mtext></msub><mo>=</mo><mo stretchy="false">⌊</mo><mi mathvariant="normal">PairwiseMargin</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn><mo stretchy="false">⌋</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k_{\text{left}} = \lfloor \operatorname{PairwiseMargin}(n, m, \mathrm{misrate}) / 2 \rfloor + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">left</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">⌊</span><span class="mop"><span class="mord mathrm">PairwiseMargin</span></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mclose">)</span><span class="mord">/2</span><span class="mclose">⌋</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mtext>right</mtext></msub><mo>=</mo><mi>n</mi><mi>m</mi><mo>−</mo><mo stretchy="false">⌊</mo><mi mathvariant="normal">PairwiseMargin</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">k_{\text{right}} = n m - \lfloor \operatorname{PairwiseMargin}(n, m, \mathrm{misrate}) / 2 \rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">right</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">nm</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">⌊</span><span class="mop"><span class="mord mathrm">PairwiseMargin</span></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mclose">)</span><span class="mord">/2</span><span class="mclose">⌋</span></span></span></span>.</p>
<p>Computing the margin requires understanding the distribution of pairwise comparisons. Each pairwise difference corresponds to a comparison: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>j</mi></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x_{i} - y_{j} &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8252em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span> exactly when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>&gt;</mo><msub><mi>y</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">x_{i} &gt; y_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span>. This connection motivates the dominance function:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Dominance</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo separator="true">,</mo><mi mathvariant="bold">y</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><mn mathvariant="double-struck">1</mn><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>&gt;</mo><msub><mi>y</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Dominance}(\mathbf{x}, \mathbf{y}) = \sum_{i=1}^{n} \sum_{j=1}^{m} \mathbb{1}(x_{i} &gt; y_{j})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">Dominance</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:3.0652em;vertical-align:-1.4138em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em"><span style="top:-1.8723em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em"><span style="top:-1.8723em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>
<p>The dominance function counts how many pairwise comparisons favor <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span></span></span></span> over <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span></span></span></span>. Both <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Shift</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Shift}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm">Shift</span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> operate on the same collection of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">n m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">nm</span></span></span></span> pairwise differences. The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Shift</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Shift}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm">Shift</span></span></span></span></span> estimator examines difference values, returning the median as a location estimate. The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> function examines difference signs, counting how many comparisons produce positive differences. While <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Shift</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Shift}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm">Shift</span></span></span></span></span> provides the estimate itself, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> determines which order statistics form reliable bounds around that estimate.</p>
<p>When populations have equivalent distributions, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> concentrates near <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mfrac><mi>m</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">n \frac{m}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em"></span><span class="mord mathnormal">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> by symmetry. The distribution of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> across all possible sample orderings determines reliable bounds. If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> deviates from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mfrac><mi>m</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">n \frac{m}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em"></span><span class="mord mathnormal">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> by at least <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>k</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{k}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> with probability <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span></span></span></span>, then the interval excluding the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> most extreme pairwise differences contains zero with probability <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow></mrow><annotation encoding="application/x-tex">1 - \mathrm{misrate}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span></span></span></span>. Translation invariance extends this relationship to arbitrary shifts: the margin computed from the comparison distribution applies regardless of the true shift value.</p>
<p>Two computational approaches provide the distribution of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span>: exact calculation for small samples and approximation for large samples.</p>
<p><strong>Exact method</strong></p>
<p>Small sample sizes allow exact computation without approximation. The exact approach exploits a fundamental symmetry: under equivalent populations, all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mrow><mi>n</mi><mo>+</mo><mi>m</mi></mrow><mi>n</mi></mfrac><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\binom{n+m}{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2023em;vertical-align:-0.35em"></span><span class="mord"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">(</span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8523em"><span style="top:-2.355em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.144em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">)</span></span></span></span></span></span> orderings of the combined measurements occur with equal probability. This symmetry enables direct calculation of how many orderings produce each comparison count.</p>
<p>Direct computation faces a combinatorial challenge. Enumerating all orderings to count comparison outcomes requires substantial memory and computation time. For samples beyond a few dozen measurements, naive implementation becomes impractical.</p>
<p>Löfflers recurrence relation (<span class="citation" data-key="loeffler1982">Löffler 1982</span>) resolves this through algebraic structure. The recurrence exploits cycle properties in the comparison distribution, reducing memory requirements while maintaining exact calculation. The algorithm builds cumulative probabilities sequentially until reaching the threshold corresponding to the desired error rate. This approach extends practical exact computation to combined sample sizes of several hundred.</p>
<p>Define <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{n,m}(c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span> as the number of orderings producing exactly <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span></span></span></span> comparisons favoring <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span></span></span></span>. The probability mass function becomes:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Pr</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>Dominance</mtext><mo>=</mo><mi>c</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mfrac><mi>c</mi><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mrow><mi>n</mi><mo>+</mo><mi>m</mi></mrow><mi>n</mi></mfrac><mo fence="true">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\Pr(\text{Dominance} = c) = p_{n,m}\frac{c}{\binom{n+m}{n}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">Pr</span><span class="mopen">(</span><span class="mord text"><span class="mord">Dominance</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.1999em;vertical-align:-1.0923em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em"><span style="top:-2.2577em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">(</span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8523em"><span style="top:-2.355em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.144em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0923em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>A direct recurrence follows from considering the largest measurement. The rightmost element comes from either <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span></span></span></span> (contributing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> comparisons) or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span></span></span></span> (contributing zero):</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>p</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>c</mi><mo>−</mo><mi>m</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{n,m}(c) = p_{n-1,m}(c - m) + p_{n,m-1}(c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span>
<p>with base cases <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mn>0</mn></mrow></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">p_{n,0}(0) = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mn>0</mn><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">p_{0,m}(0) = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span>.</p>
<p>Direct implementation requires <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo>⋅</mo><mi>m</mi><mo>⋅</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \cdot m \cdot n m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">nm</span><span class="mclose">)</span></span></span></span> time and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mclose">)</span></span></span></span> memory. An alternative recurrence (<span class="citation" data-key="loeffler1982">Löffler 1982</span>) exploits cycle structure:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>c</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>c</mi><mo>−</mo><mn>1</mn></mrow></munderover><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>c</mi><mo>−</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{n,m}(c) = \frac{1}{c} \sum_{i=0}^{c-1} p_{n,m}(i) \cdot sigma_{n,m}(c - i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:3.0788em;vertical-align:-1.2777em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">c</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011em"><span style="top:-1.8723em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">sigma_{n,m}(d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span> captures structural properties through divisors:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><msub><mi>a</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>k</mi><mi mathvariant="normal">∣</mi><mi>d</mi></mrow></munder><mi>e</mi><mi>p</mi><mi>s</mi><mi>i</mi><mi>l</mi><mi>o</mi><msub><mi>n</mi><mi>k</mi></msub><mo>⋅</mo><mi>k</mi><mo separator="true">,</mo><mi>q</mi><mi>u</mi><mi>a</mi><mi>d</mi><mi>e</mi><mi>p</mi><mi>s</mi><mi>i</mi><mi>l</mi><mi>o</mi><msub><mi>n</mi><mi>k</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if</mtext><mn>1</mn><mo>≤</mo><mi>k</mi><mo>≤</mo><mi>n</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if</mtext><mi>m</mi><mo>+</mo><mn>1</mn><mo>≤</mo><mi>k</mi><mo>≤</mo><mi>m</mi><mo>+</mo><mi>n</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
sigma_{n,m}(d) = \sum_{k|d} epsilon_{k} \cdot k, quad
epsilon_{k} = \begin{cases} 1 &amp; \text{if} 1 \leq k \leq n \\ -1 &amp; \text{if} m+1 \leq k \leq m+n \\ 0 &amp; \text{otherwise} \end{cases}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.62em;vertical-align:-2.06em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.56em"><span style="top:-4.56em"><span class="pstrut" style="height:4.41em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em"><span style="top:-1.809em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="mord mtight">∣</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.516em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em"><span style="top:-2.2em"><span class="pstrut" style="height:3.15em"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em"><span class="pstrut" style="height:3.15em"></span><span style="height:0.316em;width:0.8889em"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"></path></svg></span></span><span style="top:-3.15em"><span class="pstrut" style="height:3.15em"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em"><span class="pstrut" style="height:3.15em"></span><span style="height:0.316em;width:0.8889em"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"></path></svg></span></span><span style="top:-4.6em"><span class="pstrut" style="height:3.15em"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em"><span style="top:-4.41em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.97em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span style="top:-1.53em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em"><span style="top:-4.41em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord text"><span class="mord">if</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord mathnormal">n</span></span></span><span style="top:-2.97em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord text"><span class="mord">if</span></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">n</span></span></span><span style="top:-1.53em"><span class="pstrut" style="height:3.008em"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.06em"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>This reduces memory to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mclose">)</span></span></span></span> and enables efficient computation through <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mi>n</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">c = n m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">nm</span></span></span></span>.</p>
<p>The algorithm computes cumulative probabilities <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Pr</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>Dominance</mtext><mo>≤</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Pr(\text{Dominance} \leq c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">Pr</span><span class="mopen">(</span><span class="mord text"><span class="mord">Dominance</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span> sequentially until the threshold <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\mathrm{misrate}/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mord">/2</span></span></span></span> is exceeded. By symmetry, the lower and upper thresholds determine the total margin <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">PairwiseMargin</mi><mo>⁡</mo><mo>=</mo><mn>2</mn><mi>c</mi></mrow><annotation encoding="application/x-tex">\operatorname{PairwiseMargin} = 2c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">PairwiseMargin</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">2</span><span class="mord mathnormal">c</span></span></span></span>.</p>
<p>The sequential computation proceeds incrementally. Starting from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">u = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">u</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span> with base probability <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">p_{n,m}(0) = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span>, the algorithm computes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{n,m}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>, then <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{n,m}(2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span>, and so on, accumulating the cumulative distribution function with each step. The loop terminates as soon as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Pr</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>Dominance</mtext><mo>≤</mo><mi>u</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Pr(\text{Dominance} \leq u)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">Pr</span><span class="mopen">(</span><span class="mord text"><span class="mord">Dominance</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">u</span><span class="mclose">)</span></span></span></span> reaches <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\mathrm{misrate}/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mord">/2</span></span></span></span>, returning the threshold value <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">u</span></span></span></span> without computing further probabilities.</p>
<p>This sequential approach performs particularly well for small misrates. For <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>6</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\mathrm{misrate} = 10^{-6}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span>, the threshold <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">u</span></span></span></span> typically remains small even with large sample sizes, requiring only a few iterations regardless of whether <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> equal 50 or 200. The algorithm computes only the extreme tail probabilities needed to reach the threshold, never touching the vast majority of probability mass concentrated near <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mfrac><mi>m</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">n \frac{m}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em"></span><span class="mord mathnormal">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>. This efficiency advantage grows as misrates decrease: stricter bounds require fewer computed values, making exact calculation particularly attractive for high-confidence applications.</p>
<p><strong>Approximate method</strong></p>
<p>Large samples make exact computation impractical. The dominance count <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> concentrates near <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mfrac><mi>m</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">n \frac{m}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em"></span><span class="mord mathnormal">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> with variance <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>12</mn></mrow><annotation encoding="application/x-tex">n m(n+m+1)/12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">/12</span></span></span></span>. A basic <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span> (Normal) approximation suffices asymptotically:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Dominance</mtext><mo>≈</mo><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder><mo stretchy="false">(</mo><mi>n</mi><mfrac><mi>m</mi><mn>2</mn></mfrac><mo separator="true">,</mo><msqrt><mrow><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>12</mn></mrow></msqrt><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Dominance} \approx \underline{\operatorname{Additive}}(n \frac{m}{2}, \sqrt{n m(n+m+1)/12})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9839em"><span class="svg-align" style="top:-3.2em"><span class="pstrut" style="height:3.2em"></span><span class="mord" style="padding-left:1em"><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">/12</span></span></span><span style="top:-2.9439em"><span class="pstrut" style="height:3.2em"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2561em"><span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>
<p>This approximation underestimates tail probabilities for moderate sample sizes. The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span> (Normal) approximation provides a convenient baseline but fails to capture the true distribution shape in the tails, producing mis-calibrated probabilities that become problematic for small error rates.</p>
<p>The Edgeworth expansion refines this approximation through moment-based corrections (<span class="citation" data-key="fix1955">Fix &amp; Hodges 1955</span>). The expansion starts with the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span> (Normal) cumulative distribution as a baseline, then adds correction terms that account for the distributions asymmetry (skewness) and tail weight (kurtosis). These corrections use Hermite polynomials to adjust the baseline curve where the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span> (Normal) approximation deviates most from the true distribution. The first few correction terms typically achieve the practical balance between accuracy and computational cost, substantially improving tail probability estimates compared to the basic approximation.</p>
<p>The standardized comparison count:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>z</mi><mo>=</mo><mfrac><mrow><mi>c</mi><mo>−</mo><mi>n</mi><mfrac><mi>m</mi><mn>2</mn></mfrac></mrow><msqrt><mrow><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>12</mn></mrow></msqrt></mfrac></mrow><annotation encoding="application/x-tex">z = \frac{c - n \frac{m}{2}}{\sqrt{n m(n+m+1)/12}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.5604em;vertical-align:-1.13em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4304em"><span style="top:-2.175em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em"><span class="svg-align" style="top:-3.2em"><span class="pstrut" style="height:3.2em"></span><span class="mord" style="padding-left:1em"><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">/12</span></span></span><span style="top:-2.895em"><span class="pstrut" style="height:3.2em"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewBox="0 0 400000 1296" preserveAspectRatio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em"><span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.735em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.13em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>produces the approximated cumulative distribution:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Pr</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>Dominance</mtext><mo>≤</mo><mi>c</mi><mo stretchy="false">)</mo><mo>≈</mo><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>e</mi><mn>3</mn></msub><msup><mi>ϕ</mi><mrow><mo stretchy="false">(</mo><mn>3</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>e</mi><mn>5</mn></msub><msup><mi>ϕ</mi><mrow><mo stretchy="false">(</mo><mn>5</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>e</mi><mn>7</mn></msub><msup><mi>ϕ</mi><mrow><mo stretchy="false">(</mo><mn>7</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Pr(\text{Dominance} \leq c) \approx \Phi(z) + e_{3} \phi^{(3)}(z) + e_{5} \phi^{(5)}(z) + e_{7} \phi^{(7)}(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">Pr</span><span class="mopen">(</span><span class="mord text"><span class="mord">Dominance</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">3</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">5</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">7</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord">Φ</span></span></span></span> denotes the standard <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span> (Normal) CDF.</p>
<p>The correction coefficients depend on standardized moments:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>e</mi><mn>3</mn></msub><mo>=</mo><mfrac><mn>1</mn><mn>24</mn></mfrac><mo stretchy="false">(</mo><msup><mfrac><mrow><mi>m</mi><msub><mi>u</mi><mn>4</mn></msub></mrow><mrow><mi>m</mi><msub><mi>u</mi><mn>2</mn></msub></mrow></mfrac><mn>2</mn></msup><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>q</mi><mi>u</mi><mi>a</mi><mi>d</mi><msub><mi>e</mi><mn>5</mn></msub><mo>=</mo><mfrac><mn>1</mn><mn>720</mn></mfrac><mo stretchy="false">(</mo><msup><mfrac><mrow><mi>m</mi><msub><mi>u</mi><mn>6</mn></msub></mrow><mrow><mi>m</mi><msub><mi>u</mi><mn>2</mn></msub></mrow></mfrac><mn>3</mn></msup><mo>−</mo><mn>15</mn><msup><mfrac><mrow><mi>m</mi><msub><mi>u</mi><mn>4</mn></msub></mrow><mrow><mi>m</mi><msub><mi>u</mi><mn>2</mn></msub></mrow></mfrac><mn>2</mn></msup><mo>+</mo><mn>30</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>q</mi><mi>u</mi><mi>a</mi><mi>d</mi><msub><mi>e</mi><mn>7</mn></msub><mo>=</mo><mfrac><mn>35</mn><mn>40320</mn></mfrac><mo stretchy="false">(</mo><msup><mfrac><mrow><mi>m</mi><msub><mi>u</mi><mn>4</mn></msub></mrow><mrow><mi>m</mi><msub><mi>u</mi><mn>2</mn></msub></mrow></mfrac><mn>2</mn></msup><mo>−</mo><mn>3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">e_{3} = \frac{1}{24} (\frac{mu_{4}}{mu_{2}}^{2} - 3), quad
e_{5} = \frac{1}{720} (\frac{mu_{6}}{mu_{2}}^{3} - 15 \frac{mu_{4}}{mu_{2}}^{2} + 30), quad
e_{7} = \frac{35}{40320} (\frac{mu_{4}}{mu_{2}}^{2} - 3)^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.1574em;vertical-align:-0.836em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">24</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.3116em"><span style="top:-3.5605em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">3</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.1574em;vertical-align:-0.836em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">720</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.3116em"><span style="top:-3.5605em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:2.1476em;vertical-align:-0.836em"></span><span class="mord">15</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.3116em"><span style="top:-3.5605em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">30</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.1574em;vertical-align:-0.836em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">40320</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">35</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.3116em"><span style="top:-3.5605em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span>
<p>The moments <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><msub><mi>u</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">mu_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><msub><mi>u</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">mu_{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><msub><mi>u</mi><mn>6</mn></msub></mrow><annotation encoding="application/x-tex">mu_{6}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> are computed from sample sizes:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>m</mi><msub><mi>u</mi><mn>2</mn></msub><mo>=</mo><mfrac><mrow><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>12</mn></mfrac></mrow><annotation encoding="application/x-tex">mu_{2} = \frac{n m(n+m+1)}{12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">12</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>m</mi><msub><mi>u</mi><mn>4</mn></msub><mo>=</mo><mfrac><mrow><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>240</mn></mfrac><mo stretchy="false">(</mo><mn>5</mn><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo><mo>−</mo><mn>2</mn><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><msup><mi>m</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mn>3</mn><mi>n</mi><mi>m</mi><mo>−</mo><mn>2</mn><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">mu_{4} = \frac{n m(n+m+1)}{240} (5 n m(n+m) - 2(n^{2} + m^{2}) + 3 n m - 2(n+m))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">240</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">5</span><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">3</span><span class="mord mathnormal">nm</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">))</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>m</mi><msub><mi>u</mi><mn>6</mn></msub><mo>=</mo><mfrac><mrow><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>4032</mn></mfrac><mo stretchy="false">(</mo><mn>35</mn><msup><mi>n</mi><mn>2</mn></msup><msup><mi>m</mi><mn>2</mn></msup><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><msup><mi>m</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mn>70</mn><msup><mi>n</mi><mn>3</mn></msup><msup><mi>m</mi><mn>3</mn></msup><mo>−</mo><mn>42</mn><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo>+</mo><msup><mi>m</mi><mn>3</mn></msup><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo>−</mo><mn>14</mn><msup><mi>n</mi><mn>2</mn></msup><msup><mi>m</mi><mn>2</mn></msup><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo><mo>+</mo><mn>16</mn><mo stretchy="false">(</mo><msup><mi>n</mi><mn>4</mn></msup><mo>+</mo><msup><mi>m</mi><mn>4</mn></msup><mo stretchy="false">)</mo><mo>−</mo><mn>52</mn><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><msup><mi>m</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo>−</mo><mn>43</mn><msup><mi>n</mi><mn>2</mn></msup><msup><mi>m</mi><mn>2</mn></msup><mo>+</mo><mn>32</mn><mo stretchy="false">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo>+</mo><msup><mi>m</mi><mn>3</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mn>14</mn><mi>n</mi><mi>m</mi><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo>+</mo><mn>8</mn><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><msup><mi>m</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mn>16</mn><mi>n</mi><mi>m</mi><mo>−</mo><mn>8</mn><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">mu_{6} = \frac{n m(n+m+1)}{4032} (35 n^{2} m^{2}(n^{2} + m^{2}) + 70 n^{3} m^{3} - 42 n m(n^{3} + m^{3}) \\
  - 14 n^{2} m^{2}(n + m) + 16(n^{4} + m^{4}) - 52 n m(n^{2} + m^{2}) \\
  - 43 n^{2} m^{2} + 32(n^{3} + m^{3}) + 14 n m(n + m) \\
  + 8(n^{2} + m^{2}) + 16 n m - 8(n + m))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">4032</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">35</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord">70</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">42</span><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">−</span><span class="mord">14</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">16</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">52</span><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord">−</span><span class="mord">43</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">32</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">14</span><span class="mord mathnormal">nm</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord">+</span><span class="mord">8</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">16</span><span class="mord mathnormal">nm</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">8</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">m</span><span class="mclose">))</span></span></span></span></span>
<p>The correction terms use Hermite polynomials:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>ϕ</mi><mrow><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mi>ϕ</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><msub><mi>H</mi><mi>k</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\phi^{(k)}(z) = -\phi(z) H_{k}(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">−</span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>H</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>z</mi><mn>3</mn></msup><mo>−</mo><mn>3</mn><mi>z</mi><mo separator="true">,</mo><mi>q</mi><mi>u</mi><mi>a</mi><mi>d</mi><msub><mi>H</mi><mn>5</mn></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>z</mi><mn>5</mn></msup><mo>−</mo><mn>10</mn><msup><mi>z</mi><mn>3</mn></msup><mo>+</mo><mn>15</mn><mi>z</mi><mo separator="true">,</mo><mi>q</mi><mi>u</mi><mi>a</mi><mi>d</mi><msub><mi>H</mi><mn>7</mn></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>z</mi><mn>7</mn></msup><mo>−</mo><mn>21</mn><msup><mi>z</mi><mn>5</mn></msup><mo>+</mo><mn>105</mn><msup><mi>z</mi><mn>3</mn></msup><mo>−</mo><mn>105</mn><mi>z</mi></mrow><annotation encoding="application/x-tex">H_{3}(z) = z^{3} - 3z, quad
H_{5}(z) = z^{5} - 10z^{3} + 15z, quad
H_{7}(z) = z^{7} - 21z^{5} + 105z^{3} - 105z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord">10</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">15</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord">21</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em"></span><span class="mord">105</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">105</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span></span>
<p>Binary search locates the threshold value efficiently. The algorithm maintains a search interval <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[a, b]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">b</span><span class="mclose">]</span></span></span></span> initialized to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi>n</mi><mi>m</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, n m]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">nm</span><span class="mclose">]</span></span></span></span>. Each iteration computes the midpoint <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mfrac><mrow><mi>a</mi><mo>+</mo><mi>b</mi></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">c = \frac{a + b}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> and evaluates the Edgeworth CDF at <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span></span></span></span>. If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Pr</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>Dominance</mtext><mo>≤</mo><mi>c</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\Pr(\text{Dominance} \leq c) &lt; \mathrm{misrate}/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">Pr</span><span class="mopen">(</span><span class="mord text"><span class="mord">Dominance</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mord">/2</span></span></span></span>, the threshold lies above <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span></span></span></span> and the search continues with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>=</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">a = c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span></span></span></span>. If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Pr</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>Dominance</mtext><mo>≤</mo><mi>c</mi><mo stretchy="false">)</mo><mo>≥</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\Pr(\text{Dominance} \leq c) \geq \mathrm{misrate}/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop">Pr</span><span class="mopen">(</span><span class="mord text"><span class="mord">Dominance</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mord">/2</span></span></span></span>, the threshold lies below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span></span></span></span> and the search continues with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">b = c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span></span></span></span>. The loop terminates when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">a</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">b</span></span></span></span> become adjacent, requiring <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log(n m))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mclose">))</span></span></span></span> CDF evaluations.</p>
<p>This binary search exhibits uniform performance across misrate values. Whether computing bounds for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>6</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\mathrm{misrate} = 10^{-6}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\mathrm{misrate} = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.05</span></span></span></span>, the algorithm performs the same number of iterations determined solely by the sample sizes. Each CDF evaluation costs constant time regardless of the threshold location, making the approximate method particularly efficient for large samples where exact computation becomes impractical. The logarithmic scaling ensures that doubling the sample size adds only one additional iteration, enabling practical computation for samples in the thousands or tens of thousands.</p>
<p>The toolkit selects between exact and approximate computation based on combined sample size: exact method for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>+</mo><mi>m</mi><mo>≤</mo><mn>400</mn></mrow><annotation encoding="application/x-tex">n + m \leq 400</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">400</span></span></span></span>, approximate method for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>+</mo><mi>m</mi><mo>&gt;</mo><mn>400</mn></mrow><annotation encoding="application/x-tex">n + m &gt; 400</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">400</span></span></span></span>. The exact method guarantees correctness but scales as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mclose">)</span></span></span></span> memory and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O((n m)^{2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">((</span><span class="mord mathnormal">nm</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> time. For <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>m</mi><mo>=</mo><mn>200</mn></mrow><annotation encoding="application/x-tex">n = m = 200</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">200</span></span></span></span>, this requires 40,000 memory locations. The approximate method achieves 1% accuracy with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log(n m))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mopen">(</span><span class="mord mathnormal">nm</span><span class="mclose">))</span></span></span></span> constant-time evaluations. For <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>m</mi><mo>=</mo><mn>10000</mn></mrow><annotation encoding="application/x-tex">n = m = 10000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">10000</span></span></span></span>, the approximate method completes in milliseconds versus minutes for exact computation.</p>
<p>Both methods handle discrete data. Repeated measurements produce tied pairwise differences, creating plateaus in the sorted sequence. The exact method counts orderings without assuming continuity. The approximate methods moment-based corrections capture the actual distribution shape regardless of discreteness.</p>
<p><strong>Minimum reasonable misrate</strong></p>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span></span></span></span> parameter controls how many extreme pairwise differences the bounds exclude. Lower misrate produces narrower bounds with higher confidence but requires excluding fewer extreme values. However, sample size limits how small misrate can meaningfully become.</p>
<p>Consider the most extreme configuration: all measurements from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span></span></span></span> exceed all measurements from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em"></span><span class="mord mathbf" style="margin-right:0.01597em">y</span></span></span></span>, giving <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo>&gt;</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">x_{1}, \ldots, x_{n} &gt; y_{1}, \ldots, y_{m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>. Under equivalent populations, this arrangement occurs purely by chance. The probability equals the chance of having all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> elements from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span></span></span></span> occupy the top <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> positions among <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>+</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">n+m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> total measurements:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mrow><mi>n</mi><mo>+</mo><mi>m</mi></mrow><mi>n</mi></mfrac><mo fence="true">)</mo></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>n</mi><mo stretchy="false">!</mo><mo>⋅</mo><mi>m</mi><mo stretchy="false">!</mo></mrow><mrow><mi>n</mi><mo>+</mo><mi>m</mi></mrow></mfrac><mo stretchy="false">!</mo></mrow><annotation encoding="application/x-tex">\mathrm{misrate}_min = \frac{1}{\binom{n+m}{n}} = \frac{n! \cdot m!}{n+m}!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.4138em;vertical-align:-1.0923em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.2577em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">(</span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8523em"><span style="top:-2.355em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.144em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0923em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.1408em;vertical-align:-0.7693em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mclose">!</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">m</span><span class="mclose">!</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">!</span></span></span></span></span>
<p>This represents the minimum probability of the most extreme ordering under random sampling. Setting <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>&lt;</mo><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate} &lt; \mathrm{misrate}_min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.707em;vertical-align:-0.0391em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span></span></span></span> makes bounds construction problematic. The exact distribution of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Dominance</mtext></mrow><annotation encoding="application/x-tex">\text{Dominance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">Dominance</span></span></span></span></span> cannot support misrates smaller than the probability of its most extreme realization. Attempting to construct bounds with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>&lt;</mo><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate} &lt; \mathrm{misrate}_min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.707em;vertical-align:-0.0391em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span></span></span></span> forces the algorithm to exclude zero pairwise differences from the tails, making <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">PairwiseMargin</mi><mo>⁡</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\operatorname{PairwiseMargin} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">PairwiseMargin</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span>. The resulting bounds span all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">n m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">nm</span></span></span></span> pairwise differences, returning <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>z</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msub><mo separator="true">,</mo><msub><mi>z</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[z_{(1)}, z_{(n m)}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1052em;vertical-align:-0.3552em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.5198em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.5198em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">nm</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> regardless of the desired confidence level. These bounds convey no useful information beyond the range of observed pairwise differences.</p>
<p>For small samples, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate}_min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span></span></span></span> can exceed commonly used values. With <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>m</mi><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">n = m = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">6</span></span></span></span>, the minimum misrate equals <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mn>12</mn><mn>6</mn></mfrac><mo fence="true">)</mo></mrow></mfrac><mo>≈</mo><mn>0.00108</mn></mrow><annotation encoding="application/x-tex">\frac{1}{\binom{12}{6}} \approx 0.00108</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.8551em;vertical-align:-1.01em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em"><span style="top:-2.3925em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen sizing reset-size3 size6 mtight delimcenter" style="top:0.075em"><span class="delimsizing size1 mtight"><span class="mtight">(</span></span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-2.156em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">6</span></span></span></span><span style="top:-2.971em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em"><span></span></span></span></span></span><span class="mclose sizing reset-size3 size6 mtight delimcenter" style="top:0.075em"><span class="delimsizing size1 mtight"><span class="mtight">)</span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.01em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.00108</span></span></span></span>, making the typical choice of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\mathrm{misrate} = 10^{-3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span> impossible. With <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi>m</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">n = m = 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">4</span></span></span></span>, the minimum becomes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mn>8</mn><mn>4</mn></mfrac><mo fence="true">)</mo></mrow></mfrac><mo>≈</mo><mn>0.0143</mn></mrow><annotation encoding="application/x-tex">\frac{1}{\binom{8}{4}} \approx 0.0143</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.8551em;vertical-align:-1.01em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em"><span style="top:-2.3925em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen sizing reset-size3 size6 mtight delimcenter" style="top:0.075em"><span class="delimsizing size1 mtight"><span class="mtight">(</span></span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-2.156em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-2.971em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">8</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em"><span></span></span></span></span></span><span class="mclose sizing reset-size3 size6 mtight delimcenter" style="top:0.075em"><span class="delimsizing size1 mtight"><span class="mtight">)</span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.01em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.0143</span></span></span></span>, exceeding even <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><mn>0.01</mn></mrow><annotation encoding="application/x-tex">\mathrm{misrate} = 0.01</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.01</span></span></span></span>.</p>
<p>The table below shows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate}_min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span></span></span></span> for small sample sizes:</p>




















































































































































<table><thead><tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th></tr></thead><tbody><tr><td>1</td><td>0.500000</td><td>0.333333</td><td>0.250000</td><td>0.200000</td><td>0.166667</td><td>0.142857</td><td>0.125000</td><td>0.111111</td><td>0.100000</td><td>0.090909</td></tr><tr><td>2</td><td>0.333333</td><td>0.166667</td><td>0.100000</td><td>0.066667</td><td>0.047619</td><td>0.035714</td><td>0.027778</td><td>0.022222</td><td>0.018182</td><td>0.015152</td></tr><tr><td>3</td><td>0.250000</td><td>0.100000</td><td>0.050000</td><td>0.028571</td><td>0.017857</td><td>0.011905</td><td>0.008333</td><td>0.006061</td><td>0.004545</td><td>0.003497</td></tr><tr><td>4</td><td>0.200000</td><td>0.066667</td><td>0.028571</td><td>0.014286</td><td>0.007937</td><td>0.004762</td><td>0.003030</td><td>0.002020</td><td>0.001399</td><td>0.000999</td></tr><tr><td>5</td><td>0.166667</td><td>0.047619</td><td>0.017857</td><td>0.007937</td><td>0.003968</td><td>0.002165</td><td>0.001263</td><td>0.000777</td><td>0.000500</td><td>0.000333</td></tr><tr><td>6</td><td>0.142857</td><td>0.035714</td><td>0.011905</td><td>0.004762</td><td>0.002165</td><td>0.001082</td><td>0.000583</td><td>0.000333</td><td>0.000200</td><td>0.000125</td></tr><tr><td>7</td><td>0.125000</td><td>0.027778</td><td>0.008333</td><td>0.003030</td><td>0.001263</td><td>0.000583</td><td>0.000291</td><td>0.000155</td><td>0.000087</td><td>0.000051</td></tr><tr><td>8</td><td>0.111111</td><td>0.022222</td><td>0.006061</td><td>0.002020</td><td>0.000777</td><td>0.000333</td><td>0.000155</td><td>0.000078</td><td>0.000041</td><td>0.000023</td></tr><tr><td>9</td><td>0.100000</td><td>0.018182</td><td>0.004545</td><td>0.001399</td><td>0.000500</td><td>0.000200</td><td>0.000087</td><td>0.000041</td><td>0.000021</td><td>0.000011</td></tr><tr><td>10</td><td>0.090909</td><td>0.015152</td><td>0.003497</td><td>0.000999</td><td>0.000333</td><td>0.000125</td><td>0.000051</td><td>0.000023</td><td>0.000011</td><td>0.000005</td></tr></tbody></table>
<p>For meaningful bounds construction, choose <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>&gt;</mo><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate} &gt; \mathrm{misrate}_min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.707em;vertical-align:-0.0391em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span></span></span></span>. This ensures the margin function excludes at least some extreme pairwise differences, producing bounds narrower than the full range. When working with small samples, verify that the desired misrate exceeds <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate}_min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span></span></span></span> for the given sample sizes. With moderate sample sizes (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≥</mo><mn>15</mn></mrow><annotation encoding="application/x-tex">n, m \geq 15</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">15</span></span></span></span>), <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mi>m</mi></msub><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">\mathrm{misrate}_min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em"></span><span class="mord"><span class="mord"><span class="mord mathrm">misrate</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">in</span></span></span></span> drops below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-8}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span>, making standard choices like <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow><mo>=</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>6</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\mathrm{misrate} = 10^{-6}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em"></span><span class="mord"><span class="mord mathrm">misrate</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span> feasible.</p>
<pre class="astro-code astro-code-themes kanagawa-lotus nord" style="background-color:#F2ECBC;--shiki-dark-bg:#2e3440ff;color:#545464;--shiki-dark:#d8dee9ff;overflow-x:auto" tabindex="0" data-language="cs"><code><span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">using</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> System</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">using</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> JetBrains</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Annotations</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">using</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Pragmastat</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Internal</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">namespace</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Pragmastat</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Functions</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">/// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">/// PairwiseMargin function</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">/// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">/// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#624C83;--shiki-dark:#8FBCBB"> name</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">=</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">threshold</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span><span style="color:#716E61;--shiki-dark:#616E88">The maximum value for n+m, after which implementation switches from exact to approx</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">param</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">public</span><span style="color:#624C83;--shiki-dark:#81A1C1"> class</span><span style="color:#597B75;--shiki-dark:#8FBCBB"> PairwiseMargin</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> threshold</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> PairwiseMargin</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxExactSize</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">{</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#624C83;--shiki-dark:#81A1C1"> readonly</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> PairwiseMargin</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Instance</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> const</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> MaxExactSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 400</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  [</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">PublicAPI</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Calc</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    Assertion</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">MoreThan</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#77713F;--shiki-dark:#81A1C1">nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">),</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    Assertion</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">MoreThan</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#77713F;--shiki-dark:#81A1C1">nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">),</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    Assertion</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">InRangeInclusive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#77713F;--shiki-dark:#81A1C1">nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">),</span><span style="color:#545464;--shiki-dark:#D8DEE9"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> threshold</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">      ?</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcExact</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">      :</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcApprox</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  [</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">PublicAPI</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcExact</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> raw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcExactRaw</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> misrate</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#77713F;--shiki-dark:#81A1C1"> checked</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">raw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  [</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">PublicAPI</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcApprox</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> raw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcApproxRaw</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> misrate</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> margin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> raw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">margin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> OverflowException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">$&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">Pairwise margin exceeds supported range for n=</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">{</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">}</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">, m=</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">{</span><span style="color:#545464;--shiki-dark:#D8DEE9">m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">}</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">margin</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // Inversed implementation of Andreas Löffler&#39;s (1982) &quot;Über eine Partition der nat. Zahlen und ihre Anwendung beim U-Test&quot;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcExactRaw</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> total</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> BinomialCoefficientFunction</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxAcceptableN</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">      ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> BinomialCoefficientFunction</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">BinomialCoefficient</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">      :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> BinomialCoefficientFunction</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">BinomialCoefficient</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1.0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> pmf</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> List</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> {</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> }</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // pmf[0] = 1</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> sigma</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> List</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> {</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> }</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // sigma[0] is unused</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> cdf</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1.0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#545464;--shiki-dark:#D8DEE9"> total</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">cdf</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#CC6D00;--shiki-dark:#81A1C1">true</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      u</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // Ensure sigma has entry for u</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">sigma</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> value</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> %</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            value</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> %</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            value</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> d</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        sigma</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Add</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">value</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // Compute pmf[u] using Loeffler recurrence</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> sum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        sum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pmf</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> sigma</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      sum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      pmf</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Add</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">sum</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      cdf</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> sum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#545464;--shiki-dark:#D8DEE9"> total</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">cdf</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> p</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">sum</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        break</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pmf</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // Inverse Edgeworth Approximation</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CalcApproxRaw</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> b</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> b</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> c</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> b</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> p</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> EdgeworthCdf</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> c</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">p</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> misrate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> c</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        b</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> c</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> EdgeworthCdf</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> b</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> misrate</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> b</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> EdgeworthCdf</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> u</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> nm</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mu</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> nm</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2.0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> su</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Sqrt</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">nm</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 12.0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> z</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#545464;--shiki-dark:#D8DEE9"> su</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> phi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Exp</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#77713F;--shiki-dark:#81A1C1">-</span><span style="color:#545464;--shiki-dark:#D8DEE9">z</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Sqr</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Sqrt</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#B35B79;--shiki-dark:#B48EAD">2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> PI</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Phi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> AcmAlgorithm209</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Gauss</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">z</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Pre-compute powers of n and m for efficiency</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n4</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> m4</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mu2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 12.0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mu4</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      (</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">m2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      )</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 240.0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mu6</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      (</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 35</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">m2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 70</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n3</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 42</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">m3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n3</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 14</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 16</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n4</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m4</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 52</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 43</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 32</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">m3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n3</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 14</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 8</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 16</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span></span>
<span class="line"><span style="color:#77713F;--shiki-dark:#81A1C1">       -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 8</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> m</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      )</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 4032.0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Pre-compute powers of mu2 and related terms</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mu2_2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mu2_3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu2_2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mu4_mu2_2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu4</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu2_2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Factorial constants: 4! = 24, 6! = 720, 8! = 40320</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> e3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">mu4_mu2_2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 3</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 24.0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> e5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">mu6</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu2_3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 15</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mu4_mu2_2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 30</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 720.0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> e7</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 35</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">mu4_mu2_2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 3</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">mu4_mu2_2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 3</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 40320.0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Pre-compute powers of z for Hermite polynomials</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> z2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> z3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z2</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> z5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> z7</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> f3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9">phi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">z3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> f5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9">phi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">z5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 10</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 15</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> f7</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9">phi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">z7</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 21</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 105</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 105</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> z</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> edgeworth</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> Phi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> e3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> f3</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> e5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> f5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> e7</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#545464;--shiki-dark:#D8DEE9"> f7</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Min</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Max</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">edgeworth</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">),</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">}</span></span></code></pre>  </article> </main> <!-- Expand button (visible when sidebar is collapsed) --> <button id="sidebar-expand" class="sidebar-expand" aria-label="Expand sidebar" data-astro-cid-mw7aashj> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-mw7aashj> <polyline points="13 17 18 12 13 7" data-astro-cid-mw7aashj></polyline> <polyline points="6 17 11 12 6 7" data-astro-cid-mw7aashj></polyline> </svg> </button> </div>  <header class="mobile-header" data-astro-cid-mw7aashj> <button id="menu-button" class="menu-button" aria-label="Toggle navigation menu" aria-expanded="false" data-astro-cid-4yyail6s> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-4yyail6s> <line x1="3" y1="6" x2="21" y2="6" data-astro-cid-4yyail6s></line> <line x1="3" y1="12" x2="21" y2="12" data-astro-cid-4yyail6s></line> <line x1="3" y1="18" x2="21" y2="18" data-astro-cid-4yyail6s></line> </svg> </button>  <a href="/" class="mobile-logo" data-astro-cid-mw7aashj>Pragmastat</a> <div class="mobile-header-right" data-astro-cid-mw7aashj> <a href="https://github.com/AndreyAkinshin/pragmastat" class="github-button" target="_blank" rel="noopener noreferrer" aria-label="GitHub repository" data-astro-cid-xtw5atjx> <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-astro-cid-xtw5atjx> <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" data-astro-cid-xtw5atjx></path> </svg> </a>  <div class="theme-switcher" data-astro-cid-dz5h74bc> <button class="theme-button" id="theme-button" aria-label="Toggle theme" aria-haspopup="true" data-astro-cid-dz5h74bc> <svg class="icon icon-system" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg> <svg class="icon icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg> <svg class="icon icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg> </button> <div class="theme-dropdown" id="theme-dropdown" data-astro-cid-dz5h74bc> <button class="theme-option" data-theme="system" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg>
System
</button> <button class="theme-option" data-theme="light" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg>
Light
</button> <button class="theme-option" data-theme="dark" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg>
Dark
</button> </div> </div>   </div> </header>  <div class="sidebar-overlay" id="sidebar-overlay" data-astro-cid-mw7aashj></div> <script type="module">const w='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',x='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';document.querySelectorAll(".content pre").forEach(i=>{const o=document.createElement("button");o.className="copy-button",o.innerHTML=w,o.setAttribute("aria-label","Copy code"),o.addEventListener("click",async()=>{const c=i.querySelector("code")?.textContent||"";await navigator.clipboard.writeText(c),o.innerHTML=x,o.classList.add("copied"),setTimeout(()=>{o.innerHTML=w,o.classList.remove("copied")},3e3)}),i.appendChild(o)});const A=document.getElementById("menu-button"),C=document.querySelector(".sidebar-container"),y=document.getElementById("sidebar-overlay");A?.addEventListener("click",()=>{C?.classList.toggle("open"),y?.classList.toggle("open")});y?.addEventListener("click",()=>{C?.classList.remove("open"),y?.classList.remove("open")});const m=document.getElementById("sidebar-toggle"),v=document.getElementById("docs-layout");function L(i){i?(document.documentElement.setAttribute("data-sidebar-collapsed",""),v?.setAttribute("data-sidebar-collapsed",""),m?.setAttribute("aria-expanded","false"),localStorage.setItem("pragmastat-sidebar-collapsed","true")):(document.documentElement.removeAttribute("data-sidebar-collapsed"),v?.removeAttribute("data-sidebar-collapsed"),m?.setAttribute("aria-expanded","true"),localStorage.removeItem("pragmastat-sidebar-collapsed"))}const I=localStorage.getItem("pragmastat-sidebar-collapsed")==="true";I&&(v?.setAttribute("data-sidebar-collapsed",""),m?.setAttribute("aria-expanded","false"));m?.addEventListener("click",()=>{const i=v?.hasAttribute("data-sidebar-collapsed");L(!i)});const B=document.getElementById("sidebar-expand");B?.addEventListener("click",()=>{L(!1)});(async function(){const o=document.querySelectorAll(".citation");if(o.length===0)return;let c={};try{const t=await fetch("/references.json");if(!t.ok){console.warn("Failed to load references.json:",t.status);return}c=await t.json()}catch(t){console.warn("Could not load references.json",t);return}let e=null,a=null,u=!1;function E(t,n){if(a&&(clearTimeout(a),a=null),e&&e.dataset.key===t.dataset.key)return;h(),e=document.createElement("div"),e.className="citation-popover",e.dataset.key=t.dataset.key;const s=document.createElement("div");s.className="citation-popover-title",s.textContent=n.title,e.appendChild(s);const r=document.createElement("div");if(r.className="citation-popover-authors",r.textContent=`${n.authors.join(", ")} (${n.year})`,e.appendChild(r),n.venue){const d=document.createElement("div");d.className="citation-popover-venue",d.textContent=n.venue,e.appendChild(d)}if(n.doi){const d=document.createElement("div");d.className="citation-popover-doi";const l=document.createElement("a");l.href=`https://doi.org/${encodeURIComponent(n.doi)}`,l.target="_blank",l.rel="noopener noreferrer",l.textContent=`DOI: ${n.doi}`,d.appendChild(l),e.appendChild(d)}e.addEventListener("mouseenter",()=>{u=!0,a&&(clearTimeout(a),a=null)}),e.addEventListener("mouseleave",()=>{u=!1,k()}),document.body.appendChild(e);const g=t.getBoundingClientRect(),p=e.getBoundingClientRect();let b=g.left,f=g.bottom+4;b+p.width>window.innerWidth-16&&(b=window.innerWidth-p.width-16),f+p.height>window.innerHeight-16&&(f=g.top-p.height-4),e.style.left=`${b}px`,e.style.top=`${f}px`}function k(){a||(a=setTimeout(()=>{u||h(),a=null},150))}function h(){e&&(e.remove(),e=null),u=!1}o.forEach(t=>{const n=t.dataset.key;if(!n)return;const s=c[n];s&&(t.addEventListener("mouseenter",()=>E(t,s)),t.addEventListener("mouseleave",k),t.addEventListener("click",r=>{r.preventDefault(),e?h():E(t,s)}))})})();</script>  </body></html> 