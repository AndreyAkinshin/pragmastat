<!DOCTYPE html><html lang="en" data-astro-cid-37fxchfa> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Pragmatic Statistical Toolkit"><title>Spread | Pragmastat</title><link rel="icon" type="image/svg+xml" href="/img/logo.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css" crossorigin="anonymous"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.CDGfc0hd.js"></script><!-- Prevent flash of wrong theme / sidebar state / background color --><script>
      (function() {
        const stored = localStorage.getItem('pragmastat-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        // Set background color immediately to prevent flash
        document.documentElement.style.backgroundColor = theme === 'light' ? '#fcfcfc' : '#242936';
        if (stored) {
          document.documentElement.setAttribute('data-theme-setting', stored);
        }
        // Pre-set sidebar collapsed state to prevent layout shift
        if (localStorage.getItem('pragmastat-sidebar-collapsed') === 'true') {
          document.documentElement.setAttribute('data-sidebar-collapsed', '');
        }
      })();
    </script><link rel="stylesheet" href="/_astro/_slug_.Crv_D_PQ.css">
<link rel="stylesheet" href="/_astro/_slug_.BJM9MGeo.css"></head> <body data-astro-cid-37fxchfa>  <div class="layout" id="docs-layout" data-astro-cid-mw7aashj> <aside class="sidebar-container" data-astro-transition-persist="sidebar" data-astro-cid-mw7aashj> <nav class="sidebar" aria-label="Main navigation" data-astro-cid-ssfzsv2f> <div class="sidebar-header" data-astro-cid-ssfzsv2f> <a href="/" class="logo" data-astro-cid-tvrurpns>
Pragmastat
</a>  <div class="sidebar-controls" data-astro-cid-ssfzsv2f> <a href="https://github.com/AndreyAkinshin/pragmastat" class="github-button" target="_blank" rel="noopener noreferrer" aria-label="GitHub repository" data-astro-cid-xtw5atjx> <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-astro-cid-xtw5atjx> <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" data-astro-cid-xtw5atjx></path> </svg> </a>  <div class="theme-switcher" data-astro-cid-dz5h74bc> <button class="theme-button" id="theme-button" aria-label="Toggle theme" aria-haspopup="true" data-astro-cid-dz5h74bc> <svg class="icon icon-system" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg> <svg class="icon icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg> <svg class="icon icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg> </button> <div class="theme-dropdown" id="theme-dropdown" data-astro-cid-dz5h74bc> <button class="theme-option" data-theme="system" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg>
System
</button> <button class="theme-option" data-theme="light" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg>
Light
</button> <button class="theme-option" data-theme="dark" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg>
Dark
</button> </div> </div> <script type="module">const n=document.getElementById("theme-button"),o=document.getElementById("theme-dropdown"),s=document.querySelectorAll(".theme-option"),a=document.documentElement;function m(e){return e==="light"||e==="dark"?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function c(e){document.querySelector(".theme-switcher")?.setAttribute("data-setting",e||"system")}function r(e){const t=m(e);a.setAttribute("data-theme",t),e?(a.setAttribute("data-theme-setting",e),localStorage.setItem("pragmastat-theme",e)):(a.removeAttribute("data-theme-setting"),localStorage.removeItem("pragmastat-theme")),c(e)}const d=localStorage.getItem("pragmastat-theme");c(d);n?.addEventListener("click",()=>{o?.classList.toggle("open")});document.addEventListener("click",e=>{!n?.contains(e.target)&&!o?.contains(e.target)&&o?.classList.remove("open")});s.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-theme");r(t==="system"?null:t),o?.classList.remove("open")})});window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{localStorage.getItem("pragmastat-theme")||r(null)});</script>  <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="true" data-astro-cid-lp5naqcd> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-lp5naqcd> <polyline points="11 17 6 12 11 7" data-astro-cid-lp5naqcd></polyline> <polyline points="18 17 13 12 18 7" data-astro-cid-lp5naqcd></polyline> </svg> </button>  </div> </div> <div class="sidebar-section" data-astro-cid-ssfzsv2f> <ul class="sidebar-list" data-astro-cid-ssfzsv2f> <li data-astro-cid-ssfzsv2f> <a href="/synopsis" class="sidebar-link" data-astro-cid-ssfzsv2f> Synopsis </a>  </li><li class="sidebar-group-header" data-astro-cid-ssfzsv2f> <svg class="sidebar-group-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-ssfzsv2f> <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" data-astro-cid-ssfzsv2f></path> </svg> One-Sample Estimators </li><li data-astro-cid-ssfzsv2f> <a href="/center" class="sidebar-link" data-astro-cid-ssfzsv2f> Center </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/center-bounds" class="sidebar-link" data-astro-cid-ssfzsv2f> CenterBounds </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/spread" class="sidebar-link active" aria-current="page" data-astro-cid-ssfzsv2f> Spread </a> <ul class="sidebar-sublist" data-astro-cid-ssfzsv2f> <li data-astro-cid-ssfzsv2f> <a href="#algorithm" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> Algorithm </a> </li><li data-astro-cid-ssfzsv2f> <a href="#notes" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> Notes </a> </li><li data-astro-cid-ssfzsv2f> <a href="#breakdown" class="sidebar-sublink depth-3" data-astro-cid-ssfzsv2f> Breakdown </a> </li><li data-astro-cid-ssfzsv2f> <a href="#drift" class="sidebar-sublink depth-3" data-astro-cid-ssfzsv2f> Drift </a> </li><li data-astro-cid-ssfzsv2f> <a href="#tests" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> Tests </a> </li><li data-astro-cid-ssfzsv2f> <a href="#references" class="sidebar-sublink depth-2" data-astro-cid-ssfzsv2f> References </a> </li> </ul> </li><li data-astro-cid-ssfzsv2f> <a href="/spread-bounds" class="sidebar-link" data-astro-cid-ssfzsv2f> SpreadBounds </a>  </li><li class="sidebar-group-header" data-astro-cid-ssfzsv2f> <svg class="sidebar-group-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-ssfzsv2f> <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" data-astro-cid-ssfzsv2f></path> </svg> Two-Sample Estimators </li><li data-astro-cid-ssfzsv2f> <a href="/shift" class="sidebar-link" data-astro-cid-ssfzsv2f> Shift </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/shift-bounds" class="sidebar-link" data-astro-cid-ssfzsv2f> ShiftBounds </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/ratio" class="sidebar-link" data-astro-cid-ssfzsv2f> Ratio </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/ratio-bounds" class="sidebar-link" data-astro-cid-ssfzsv2f> RatioBounds </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/disparity" class="sidebar-link" data-astro-cid-ssfzsv2f> Disparity </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/disparity-bounds" class="sidebar-link" data-astro-cid-ssfzsv2f> DisparityBounds </a>  </li><li class="sidebar-group-header" data-astro-cid-ssfzsv2f> <svg class="sidebar-group-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-ssfzsv2f> <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" data-astro-cid-ssfzsv2f></path> </svg> Randomization </li><li data-astro-cid-ssfzsv2f> <a href="/rng" class="sidebar-link" data-astro-cid-ssfzsv2f> Rng </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/uniform-float" class="sidebar-link" data-astro-cid-ssfzsv2f> UniformFloat </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/uniform-int" class="sidebar-link" data-astro-cid-ssfzsv2f> UniformInt </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/sample" class="sidebar-link" data-astro-cid-ssfzsv2f> Sample </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/resample" class="sidebar-link" data-astro-cid-ssfzsv2f> Resample </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/shuffle" class="sidebar-link" data-astro-cid-ssfzsv2f> Shuffle </a>  </li><li class="sidebar-group-header" data-astro-cid-ssfzsv2f> <svg class="sidebar-group-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-ssfzsv2f> <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" data-astro-cid-ssfzsv2f></path> </svg> Distributions </li><li data-astro-cid-ssfzsv2f> <a href="/additive" class="sidebar-link" data-astro-cid-ssfzsv2f> Additive </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/multiplic" class="sidebar-link" data-astro-cid-ssfzsv2f> Multiplic </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/exp" class="sidebar-link" data-astro-cid-ssfzsv2f> Exp </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/power" class="sidebar-link" data-astro-cid-ssfzsv2f> Power </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/uniform" class="sidebar-link" data-astro-cid-ssfzsv2f> Uniform </a>  </li><li class="sidebar-group-header" data-astro-cid-ssfzsv2f> <svg class="sidebar-group-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-ssfzsv2f> <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" data-astro-cid-ssfzsv2f></path> </svg> Implementations </li><li data-astro-cid-ssfzsv2f> <a href="/py" class="sidebar-link" data-astro-cid-ssfzsv2f> Python </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/ts" class="sidebar-link" data-astro-cid-ssfzsv2f> TypeScript </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/r" class="sidebar-link" data-astro-cid-ssfzsv2f> R </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/cs" class="sidebar-link" data-astro-cid-ssfzsv2f> C# </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/kt" class="sidebar-link" data-astro-cid-ssfzsv2f> Kotlin </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/rs" class="sidebar-link" data-astro-cid-ssfzsv2f> Rust </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/go" class="sidebar-link" data-astro-cid-ssfzsv2f> Go </a>  </li><li class="sidebar-group-header" data-astro-cid-ssfzsv2f> <svg class="sidebar-group-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-ssfzsv2f> <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" data-astro-cid-ssfzsv2f></path> </svg> Auxiliary </li><li data-astro-cid-ssfzsv2f> <a href="/avg-spread" class="sidebar-link" data-astro-cid-ssfzsv2f> AvgSpread </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/avg-spread-bounds" class="sidebar-link" data-astro-cid-ssfzsv2f> AvgSpreadBounds </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/median" class="sidebar-link" data-astro-cid-ssfzsv2f> Median </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/sign-margin" class="sidebar-link" data-astro-cid-ssfzsv2f> SignMargin </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/pairwise-margin" class="sidebar-link" data-astro-cid-ssfzsv2f> PairwiseMargin </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/signed-rank-margin" class="sidebar-link" data-astro-cid-ssfzsv2f> SignedRankMargin </a>  </li><li class="sidebar-group-header" data-astro-cid-ssfzsv2f> <svg class="sidebar-group-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-ssfzsv2f> <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" data-astro-cid-ssfzsv2f></path> </svg> Appendix </li><li data-astro-cid-ssfzsv2f> <a href="/assumptions" class="sidebar-link" data-astro-cid-ssfzsv2f> Assumptions </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/foundations" class="sidebar-link" data-astro-cid-ssfzsv2f> Foundations </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/methodology" class="sidebar-link" data-astro-cid-ssfzsv2f> Methodology </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/bibliography" class="sidebar-link" data-astro-cid-ssfzsv2f> Bibliography </a>  </li><li data-astro-cid-ssfzsv2f> <a href="/colophon" class="sidebar-link" data-astro-cid-ssfzsv2f> Colophon </a>  </li> </ul> </div> </nav>  </aside> <main class="main-content" data-astro-cid-mw7aashj> <article class="content" data-astro-cid-mw7aashj> <h1 data-astro-cid-mw7aashj>Spread</h1>  <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><mi><munder><mo><mi mathvariant="normal">Median</mi><mo>⁡</mo></mo><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo>≤</mo><mi>n</mi></mrow></munder></mi><mo stretchy="false">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x}) = \underset{1 \leq i &lt; j \leq n}{\operatorname{Median}} \lvert x_i - x_j \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.6138em;vertical-align:-0.8638em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.3723em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop"><span class="mop"><span class="mord mathrm">Median</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8638em"><span></span></span></span></span></span></span><span class="mopen">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">∣</span></span></span></span></span>
<p>Robust measure of dispersion (variability, scatter).</p>
<ul>
<li><strong>Also known as</strong> — Shamos scale estimator</li>
<li><strong>Asymptotic</strong> — median of the absolute difference between two random measurements from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span></span></span></span></li>
<li><strong>Complexity</strong> — <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></li>
<li><strong>Domain</strong> — any real numbers</li>
<li><strong>Assumptions</strong> — <a href="/assumptions#sparity-assumption">sparity(x)</a></li>
<li><strong>Unit</strong> — same as measurements</li>
</ul>
<p><strong>Properties</strong></p>
<ul>
<li><strong>Shift invariance</strong> <span style="display:inline-block;width:2em"></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>+</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x} + k) = \operatorname{Spread}(\mathbf{x})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span></span></span></span></li>
<li><strong>Scale equivariance</strong> <span style="display:inline-block;width:2em"></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>k</mi><mo>⋅</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">∣</mo><mi>k</mi><mo stretchy="false">∣</mo><mo>⋅</mo><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(k \cdot \mathbf{x}) = \lvert k \rvert \cdot \operatorname{Spread}(\mathbf{x})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">∣</span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mclose">∣</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span></span></span></span></li>
<li><strong>Non-negativity</strong> <span style="display:inline-block;width:2em"></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>≥</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x}) \geq 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span></li>
</ul>
<p><strong>Example</strong></p>
<ul>
<li><code>Spread([0, 2, 4, 6, 8]) = 4</code></li>
<li><code>Spread(x + 10) = 4</code> <span style="display:inline-block;width:1em"></span> <code>Spread(2x) = 8</code></li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> measures how much measurements vary from each other. It serves the same purpose as standard deviation but does not explode with outliers or heavy-tailed data. The result comes in the same units as the measurements, so if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> is 5 milliseconds, that indicates how much values typically differ. Like <a href="/center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Center}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">Center</span></span></span></span></span></a>, it tolerates up to 29% corrupted data. When comparing variability across datasets, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> gives a reliable answer even when standard deviation would be misleading or infinite. When all values are positive, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> can be conveniently expressed in relative units by dividing by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">∣</mo><mi mathvariant="normal">Center</mi><mo>⁡</mo><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\lvert \operatorname{Center} \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">∣</span><span class="mop"><span class="mord mathrm">Center</span></span><span class="mclose">∣</span></span></span></span>: the ratio <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">∣</mo><mi mathvariant="normal">Center</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo stretchy="false">∣</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\operatorname{Spread}(\mathbf{x})}{\lvert \operatorname{Center}(\mathbf{x}) \rvert}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">∣</span><span class="mop mtight"><span class="mord mathrm mtight">Center</span></span><span class="mopen mtight">(</span><span class="mord mathbf mtight">x</span><span class="mclose mtight">)∣</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.485em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mord mathrm mtight">Spread</span></span><span class="mopen mtight">(</span><span class="mord mathbf mtight">x</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> is a robust alternative to the coefficient of variation that is scale-invariant.</p>
<h2 id="algorithm">Algorithm</h2>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> estimator computes the median of all pairwise absolute differences. Given a sample <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">x = (x_1, x_2, \ldots, x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, this estimator is defined as:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi mathvariant="normal">median</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo>≤</mo><mi>n</mi></mrow></msub><mo stretchy="false">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x}) = \operatorname{median}_{1 \leq i &lt; j \leq n} \lvert x_i - x_j \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mop"><span class="mop"><span class="mord mathrm">median</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">∣</span></span></span></span></span>
<p>Like <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Center}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">Center</span></span></span></span></span>, computing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> naively requires generating all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{n(n-1)}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.485em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> pairwise differences, sorting them, and finding the median — a quadratic approach that becomes computationally prohibitive for large datasets.</p>
<p>The same structural principles that accelerate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Center}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">Center</span></span></span></span></span> computation also apply to pairwise differences, yielding an exact <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> algorithm. After sorting the input to obtain <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>y</mi><mn>2</mn></msub><mo>≤</mo><mo>…</mo><mo>≤</mo><msub><mi>y</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">y_1 \leq y_2 \leq \ldots \leq y_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, all pairwise absolute differences <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\lvert x_i - x_j \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">∣</span></span></span></span> with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i &lt; j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span></span> become positive differences <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>j</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_j - y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>. This allows considering the implicit upper triangular matrix <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>y</mi><mi>j</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">D_{i,j} = y_j - y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i &lt; j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span></span>. This matrix has a crucial structural property: for a fixed row <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span>, differences increase monotonically, while for a fixed column <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span></span>, differences decrease as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span> increases. This sorted structure enables linear-time counting of elements below any threshold.</p>
<p>The algorithm applies Monahans selection strategy (<span class="citation" data-key="monahan1984">Monahan 1984</span>), adapted for differences rather than sums. For each row <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span>, it tracks active column indices representing differences still under consideration, initially spanning columns <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span> through <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span>. It chooses candidate differences from the active set using weighted random row selection, maintaining expected logarithmic convergence while avoiding expensive pivot computations. For any pivot value <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>, the number of differences falling below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> is counted using a single sweep; the monotonic structure ensures this counting requires only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> operations. While counting, the largest difference below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> and the smallest difference at or above <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> are maintained — these boundary values become the exact answer when the target rank is reached.</p>
<p>The algorithm naturally handles both odd and even cases. For an odd number of differences, it returns the single middle element when the count exactly hits the median rank. For an even number of differences, it returns the average of the two middle elements; boundary tracking during counting provides both values simultaneously. Unlike approximation methods, this algorithm returns the precise median of all pairwise differences; randomness affects only performance, not correctness.</p>
<p>The algorithm includes the same stall-handling mechanisms as the center algorithm. It tracks whether the count below the pivot changes between iterations; when progress stalls due to tied values, it computes the range of remaining active differences and pivots to their midrange. This midrange strategy ensures convergence even with highly discrete data or datasets with many identical values.</p>
<p>Several optimizations make the implementation practical for production use. A global column pointer that never moves backward during counting exploits the matrix structure to avoid redundant comparisons. Exact boundary values are captured during each counting pass, eliminating the need for additional searches when the target rank is reached. Using only <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> additional space for row bounds and counters, the algorithm achieves <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> time complexity with minimal memory overhead, making robust scale estimation practical for large datasets.</p>
<pre class="astro-code astro-code-themes kanagawa-lotus nord" style="background-color:#F2ECBC;--shiki-dark-bg:#2e3440ff;color:#545464;--shiki-dark:#d8dee9ff;overflow-x:auto" tabindex="0" data-language="cs"><code><span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">namespace</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Pragmastat</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Algorithms</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">internal</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#624C83;--shiki-dark:#81A1C1"> class</span><span style="color:#597B75;--shiki-dark:#8FBCBB"> FastSpread</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">{</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// Shamos &quot;Spread&quot;.  Expected O(n log n) time, O(n) extra space. Exact.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  /// </span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&lt;/</span><span style="color:#77713F;--shiki-dark:#81A1C1">summary</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  public</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Estimate</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">?</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> random</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> null</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> isSorted</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#CC6D00;--shiki-dark:#81A1C1"> false</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Abs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#B35B79;--shiki-dark:#B48EAD">0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    random</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ??=</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Prepare a sorted working copy.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> isSorted</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CopySorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> EnsureSorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Total number of pairwise differences with i &lt; j</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> N</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">N</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // 1-based rank of lower middle</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> kHigh</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">N</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // 1-based rank of upper middle</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Per-row active bounds over columns j (0-based indices).</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Row i allows j in [i+1, n-1] initially.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> L</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> R</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowCounts</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // # of elements in row i that are &lt; pivot (for current partition)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Min</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // n means empty</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // inclusive</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span><span style="color:#716E61;--shiki-dark:#616E88"> // mark empty</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // A reasonable initial pivot: a central gap</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[(</span><span style="color:#545464;--shiki-dark:#D8DEE9">n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> /</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> prevCountBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD">1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#CC6D00;--shiki-dark:#81A1C1">true</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === PARTITION: count how many differences are &lt; pivot; also track boundary neighbors ===</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // max difference &lt; pivot</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> smallestAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // min difference &gt;= pivot</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // global two-pointer (non-decreasing across rows)</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> pivot</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        rowCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> cntRow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> cntRow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // boundary elements for this row</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">cntRow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // last &lt; pivot in this row is (j-1)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> candBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">candBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> candBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> candAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">j</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">candAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> candAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === TARGET CHECK ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // If we&#39;ve split exactly at the middle, we can return using the boundaries we just found.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> atTarget</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ||</span><span style="color:#716E61;--shiki-dark:#616E88"> // lower middle is the largest &lt; pivot</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kHigh</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // upper middle is the smallest &gt;= pivot</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">atTarget</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Even N: average the two central order stats.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Odd N: pick the single middle depending on which side we hit.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          bool</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> needLargest</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> needLargest</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === STALL HANDLING (ties / no progress) ===</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ==</span><span style="color:#545464;--shiki-dark:#D8DEE9"> prevCountBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Compute min/max remaining difference in the ACTIVE set and pivot to their midrange.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> active</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Li</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">],</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> Ri</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">Li</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> Ri</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">Li</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rowMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">Ri</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowMin</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowMin</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowMax</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rowMax</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          active</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">Ri</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> Li</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">active</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // No active candidates left: the only consistent answer is the boundary implied by counts.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Fall back to neighbors from this partition.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">maxActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // all remaining equal</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minActive</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &amp;&amp;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> mid</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxActive</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        prevCountBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === SHRINK ACTIVE WINDOW ===</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // --- SHRINK ACTIVE WINDOW (fixed) ---</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Need larger differences: discard all strictly below pivot.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // First j with a[j] - a[i] &gt;= pivot is j = i + 1 + cntRow (may be n =&gt; empty row)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> newL</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">newL</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> newL</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // do NOT clamp; allow L[i] == n to mean empty</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          }</span><span style="color:#716E61;--shiki-dark:#616E88"> // mark empty</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Too many below: keep only those strictly below pivot.</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">          // Last j with a[j] - a[i] &lt; pivot is j = i + cntRow  (not cntRow-1!)</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> newR</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rowCounts</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">newR</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> newR</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // shrink downward to the true last-below</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">            R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">          }</span><span style="color:#716E61;--shiki-dark:#616E88"> // empty row if none remain</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      prevCountBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelow</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">      // === CHOOSE NEXT PIVOT FROM ACTIVE SET (weighted random row, then row median) ===</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#545464;--shiki-dark:#D8DEE9"> activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 2</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Few candidates left: return midrange of remaining exactly.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">PositiveInfinity</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> maxRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">NegativeInfinity</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> lo</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> hi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">lo</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minRem</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> lo</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">hi</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> hi</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">activeSize</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#716E61;--shiki-dark:#616E88"> // safety net; fall back to boundary from last partition</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> largestBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> smallestAtOrAbove</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kHigh</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0.5</span><span style="color:#77713F;--shiki-dark:#81A1C1"> *</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Abs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">((</span><span style="color:#545464;--shiki-dark:#D8DEE9">kLow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> countBelow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> Abs</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">countBelow</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> kLow</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#77713F;--shiki-dark:#81A1C1"> ?</span><span style="color:#545464;--shiki-dark:#D8DEE9"> minRem</span><span style="color:#77713F;--shiki-dark:#81A1C1"> :</span><span style="color:#545464;--shiki-dark:#D8DEE9"> maxRem</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      else</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> t</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> NextIndex</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">random</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#D8DEE9"> activeSize</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#716E61;--shiki-dark:#616E88"> // 0..activeSize-1</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> acc</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">        for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> n</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> row</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> continue</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">          long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> size</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">          if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">t</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> acc</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> size</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> break</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">          acc</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +=</span><span style="color:#545464;--shiki-dark:#D8DEE9"> size</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">        // Median column of the selected row</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">        int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> col</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">L</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> +</span><span style="color:#545464;--shiki-dark:#D8DEE9"> R</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">])</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &gt;&gt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 1</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">        pivot</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">col</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">row</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">      }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">  // --- Helpers ---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> CopySorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> v</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNaN</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">v</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">NaN not allowed.</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#77713F;--shiki-dark:#81A1C1"> nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> v</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">    Array</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Sort</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[]</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> EnsureSorted</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">IReadOnlyList</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&lt;</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">&gt;</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Trust caller; still copy to array for fast indexed access.</span></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">    var</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> a</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#545464;--shiki-dark:#81A1C1"> double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Count</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    for</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 0</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">Length</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span><span style="color:#545464;--shiki-dark:#D8DEE9"> i</span><span style="color:#77713F;--shiki-dark:#81A1C1">++</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      double</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> v</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">double</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">IsNaN</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">v</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> throw</span><span style="color:#77713F;--shiki-dark:#81A1C1"> new</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> ArgumentException</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#6F894E;--shiki-dark:#A3BE8C">NaN not allowed.</span><span style="color:#6F894E;--shiki-dark:#ECEFF4">&quot;</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#77713F;--shiki-dark:#81A1C1"> nameof</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#545464;--shiki-dark:#D8DEE9">values</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#D8DEE9">      a</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">[</span><span style="color:#545464;--shiki-dark:#D8DEE9">i</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">]</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> v</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> a</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-dark:#81A1C1">  private</span><span style="color:#624C83;--shiki-dark:#81A1C1"> static</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#4D699B;--shiki-dark:#88C0D0"> NextIndex</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">(</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF">Random</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">,</span><span style="color:#545464;--shiki-dark:#81A1C1"> long</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> limitExclusive</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  {</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Uniform 0..limitExclusive-1 even for large ranges.</span></span>
<span class="line"><span style="color:#716E61;--shiki-dark:#616E88">    // Use rejection sampling for correctness.</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">    ulong</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> uLimit</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">limitExclusive</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">uLimit</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#81A1C1"> int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      return</span><span style="color:#545464;--shiki-dark:#D8DEE9"> rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Next</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">((</span><span style="color:#545464;--shiki-dark:#81A1C1">int</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">uLimit</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">    while</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#CC6D00;--shiki-dark:#81A1C1">true</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    {</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      ulong</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> ((</span><span style="color:#545464;--shiki-dark:#81A1C1">ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)(</span><span style="color:#545464;--shiki-dark:#81A1C1">uint</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Next</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;&lt;</span><span style="color:#B35B79;--shiki-dark:#B48EAD"> 32</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#77713F;--shiki-dark:#81A1C1"> |</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">uint</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">rng</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#4D699B;--shiki-dark:#88C0D0">Next</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">()</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#545464;--shiki-dark:#81A1C1">      ulong</span><span style="color:#597B75;--shiki-dark:#D8DEE9FF"> r</span><span style="color:#77713F;--shiki-dark:#81A1C1"> =</span><span style="color:#545464;--shiki-dark:#D8DEE9"> u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> %</span><span style="color:#545464;--shiki-dark:#D8DEE9"> uLimit</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit">      if</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#D8DEE9">u</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#545464;--shiki-dark:#D8DEE9"> r</span><span style="color:#77713F;--shiki-dark:#81A1C1"> &lt;=</span><span style="color:#545464;--shiki-dark:#81A1C1"> ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> -</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">ulong</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">.</span><span style="color:#545464;--shiki-dark:#D8DEE9">MaxValue</span><span style="color:#77713F;--shiki-dark:#81A1C1"> %</span><span style="color:#545464;--shiki-dark:#D8DEE9"> uLimit</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">))</span><span style="color:#624C83;--shiki-light-font-weight:bold;--shiki-dark:#81A1C1;--shiki-dark-font-weight:inherit"> return</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4"> (</span><span style="color:#545464;--shiki-dark:#81A1C1">long</span><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">)</span><span style="color:#545464;--shiki-dark:#D8DEE9">r</span><span style="color:#4E8CA2;--shiki-dark:#81A1C1">;</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">    }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">  }</span></span>
<span class="line"><span style="color:#4E8CA2;--shiki-dark:#ECEFF4">}</span></span></code></pre>
<h2 id="notes">Notes</h2>
<p>This section compares the toolkits robust dispersion estimator against traditional methods to demonstrate its advantages across diverse conditions.</p>
<p><strong>Dispersion Estimators</strong></p>
<p><strong>Standard Deviation</strong>:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">StdDev</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mfrac><mn>1</mn><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mi mathvariant="normal">Mean</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">\operatorname{StdDev}(\mathbf{x}) = \sqrt{\frac{1}{n-1} \sum_{i=1}^n (x_i - \operatorname{Mean}(\mathbf{x}))^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em">StdDev</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:3.1568em;vertical-align:-1.2777em"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8791em"><span class="svg-align" style="top:-5.1168em"><span class="pstrut" style="height:5.1168em"></span><span class="mord" style="padding-left:1.056em"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em"><span style="top:-1.8723em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mop"><span class="mord mathrm">Mean</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em"><span style="top:-2.989em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.8391em"><span class="pstrut" style="height:5.1168em"></span><span class="hide-tail" style="min-width:0.742em;height:3.1968em"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.1968em" viewBox="0 0 400000 3196" preserveAspectRatio="xMinYMin slice"><path d="M702 80H40000040
H742v3062l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1
h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170
c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667
219 661 l218 661zM702 80H400000v40H742z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span></span></span></span></span>
<p><strong>Median Absolute Deviation</strong> (around the median):</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">MAD</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">Median</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo stretchy="false">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mi mathvariant="normal">Median</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo stretchy="false">∣</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\operatorname{MAD}(\mathbf{x}) = \operatorname{Median}(\lvert x_i - \operatorname{Median}(\mathbf{x}) \rvert)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">MAD</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Median</span></span><span class="mopen">(∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Median</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)∣)</span></span></span></span></span>
<p><strong>Spread</strong> (Shamos scale estimator):</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><mi><munder><mo><mi mathvariant="normal">Median</mi><mo>⁡</mo></mo><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo>≤</mo><mi>n</mi></mrow></munder></mi><mo stretchy="false">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x}) = \underset{1 \leq i &lt; j \leq n}{\operatorname{Median}} \lvert x_i - x_j \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.6138em;vertical-align:-0.8638em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.3723em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop"><span class="mop"><span class="mord mathrm">Median</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8638em"><span></span></span></span></span></span></span><span class="mopen">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">∣</span></span></span></span></span>
<h3 id="breakdown">Breakdown</h3>
<p>Heavy-tailed distributions naturally produce extreme outliers that completely distort traditional estimators. A single extreme measurement from the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Power</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Power}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6833em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Power</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span> distribution can make the standard deviation arbitrarily large. Real-world data can also contain corrupted measurements from instrument failures, recording errors, or transmission problems. Both natural extremes and data corruption create the same challenge: extracting reliable information when some measurements are too influential.</p>
<p>The breakdown point (<span class="citation" data-key="huber2009">Huber 2009</span>) is the fraction of a sample that can be replaced by arbitrarily large values without making an estimator arbitrarily large. The theoretical maximum is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">50\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em"></span><span class="mord">50%</span></span></span></span>; no estimator can guarantee reliable results when more than half the measurements are extreme or corrupted.</p>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> estimator achieves a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>29</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">29\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em"></span><span class="mord">29%</span></span></span></span> breakdown point, providing substantial protection against realistic contamination levels while maintaining good precision.</p>
<p><strong>Asymptotic breakdown points</strong> for dispersion estimators:</p>















<table><thead><tr><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">StdDev</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{StdDev}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em">StdDev</span></span></span></span></span></strong></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">MAD</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{MAD}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">MAD</span></span></span></span></span></strong></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span></strong></th></tr></thead><tbody><tr><td>0%</td><td>50%</td><td>29%</td></tr></tbody></table>
<h3 id="drift">Drift</h3>
<p>Drift measures estimator precision by quantifying how much estimates scatter across repeated samples. It is based on the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> of estimates and therefore has a breakdown point of approximately <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>29</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">29\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em"></span><span class="mord">29%</span></span></span></span>.</p>
<p>Drift is useful for comparing the precision of several estimators. To simplify the comparison, one of the estimators can be chosen as a baseline. A table of squared drift values, normalized by the baseline, shows the required sample size adjustment factor for switching from the baseline to another estimator. For example, if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> is the baseline and the rescaled drift square of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">MAD</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{MAD}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">MAD</span></span></span></span></span> is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.25</mn></mrow><annotation encoding="application/x-tex">1.25</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1.25</span></span></span></span>, this means that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">MAD</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{MAD}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">MAD</span></span></span></span></span> requires <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.25</mn></mrow><annotation encoding="application/x-tex">1.25</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1.25</span></span></span></span> times more data than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> to achieve the same precision. See <a href="/foundations#from-statistical-efficiency-to-drift">From Statistical Efficiency to Drift</a> for details.</p>
<p><strong>Squared Asymptotic Drift of Dispersion Estimators</strong> (values are approximated):</p>









































<table><thead><tr><th></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">StdDev</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{StdDev}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em">StdDev</span></span></span></span></span></strong></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">MAD</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{MAD}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">MAD</span></span></span></span></span></strong></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span></strong></th></tr></thead><tbody><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span></td><td>0.45</td><td>1.22</td><td>0.52</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Multiplic</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Multiplic}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0889em;vertical-align:-0.3944em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.6456em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Multiplic</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3944em"><span></span></span></span></span></span></span></span></span></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord">∞</span></span></span></span></td><td>2.26</td><td>1.81</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Exp</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Exp}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0778em;vertical-align:-0.3944em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6833em"><span style="top:-2.6456em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Exp</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3944em"><span></span></span></span></span></span></span></span></span></td><td>1.69</td><td>1.92</td><td>1.26</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Power</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Power}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6833em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Power</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord">∞</span></span></span></span></td><td>3.5</td><td>4.4</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Uniform</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Uniform}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Uniform</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span></td><td>0.18</td><td>0.90</td><td>0.43</td></tr></tbody></table>
<p>Rescaled to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> (sample size adjustment factors):</p>









































<table><thead><tr><th></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">StdDev</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{StdDev}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mop"><span class="mord mathrm" style="margin-right:0.01389em">StdDev</span></span></span></span></span></strong></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">MAD</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{MAD}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">MAD</span></span></span></span></span></strong></th><th><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span></strong></th></tr></thead><tbody><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span></td><td>0.87</td><td>2.35</td><td>1.0</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Multiplic</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Multiplic}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0889em;vertical-align:-0.3944em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.6456em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Multiplic</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3944em"><span></span></span></span></span></span></span></span></span></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord">∞</span></span></span></span></td><td>1.25</td><td>1.0</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Exp</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Exp}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0778em;vertical-align:-0.3944em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6833em"><span style="top:-2.6456em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Exp</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3944em"><span></span></span></span></span></span></span></span></span></td><td>1.34</td><td>1.52</td><td>1.0</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Power</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Power}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8833em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6833em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Power</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord">∞</span></span></span></span></td><td>0.80</td><td>1.0</td></tr><tr><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Uniform</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Uniform}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8944em;vertical-align:-0.2em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Uniform</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span></span></span></span></td><td>0.42</td><td>2.09</td><td>1.0</td></tr></tbody></table>
<p><span class="themed-image"><img src="/img/disp-drift-additive_light.png" alt class="theme-light"/><img src="/img/disp-drift-additive_dark.png" alt class="theme-dark"/></span></p>
<p><span class="themed-image"><img src="/img/disp-drift-multiplic_light.png" alt class="theme-light"/><img src="/img/disp-drift-multiplic_dark.png" alt class="theme-dark"/></span></p>
<p><span class="themed-image"><img src="/img/disp-drift-exp_light.png" alt class="theme-light"/><img src="/img/disp-drift-exp_dark.png" alt class="theme-dark"/></span></p>
<p><span class="themed-image"><img src="/img/disp-drift-power_light.png" alt class="theme-light"/><img src="/img/disp-drift-power_dark.png" alt class="theme-dark"/></span></p>
<p><span class="themed-image"><img src="/img/disp-drift-uniform_light.png" alt class="theme-light"/><img src="/img/disp-drift-uniform_dark.png" alt class="theme-dark"/></span></p>
<h2 id="tests">Tests</h2>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi mathvariant="normal">median</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>i</mi><mo>&lt;</mo><mi>j</mi><mo>≤</mo><mi>n</mi></mrow></msub><mo stretchy="false">∣</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>x</mi><mi>j</mi></msub><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x}) = \operatorname{median}_{1 \leq i &lt; j \leq n} \lvert x_i - x_j \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mop"><span class="mop"><span class="mord mathrm">median</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">∣</span></span></span></span></span>
<p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> test suite contains 30 correctness test cases stored in the repository (20 original + 10 unsorted), plus 1 performance test that should be implemented manually (see <a href="/methodology#test-framework">Test Framework</a>).</p>
<p><strong>Demo examples</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">n = 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">5</span></span></span></span>) — from manual introduction, validating properties:</p>
<ul>
<li><code>demo-1</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>6</mn><mo separator="true">,</mo><mn>8</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (0, 2, 4, 6, 8)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">8</span><span class="mclose">)</span></span></span></span>, expected output: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">4</span></span></span></span> (base case)</li>
<li><code>demo-2</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>10</mn><mo separator="true">,</mo><mn>12</mn><mo separator="true">,</mo><mn>14</mn><mo separator="true">,</mo><mn>16</mn><mo separator="true">,</mo><mn>18</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (10, 12, 14, 16, 18)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">12</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">14</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">18</span><span class="mclose">)</span></span></span></span> (= demo-1 + 10), expected output: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">4</span></span></span></span> (location invariance)</li>
<li><code>demo-3</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>8</mn><mo separator="true">,</mo><mn>12</mn><mo separator="true">,</mo><mn>16</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (0, 4, 8, 12, 16)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">12</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">16</span><span class="mclose">)</span></span></span></span> (= 2 × demo-1), expected output: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">8</span></span></span></span> (scale equivariance)</li>
</ul>
<p><strong>Natural sequences</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">n = 2, 3, 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span></span></span></span>):</p>
<ul>
<li><code>natural-2</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1, 2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span>, expected output: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span></li>
<li><code>natural-3</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1, 2, 3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span>, expected output: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span></li>
<li><code>natural-4</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1, 2, 3, 4)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mclose">)</span></span></span></span>, expected output: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.5</mn></mrow><annotation encoding="application/x-tex">1.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1.5</span></span></span></span> (smallest even size with rich structure)</li>
</ul>
<p><strong>Negative values</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">n = 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">3</span></span></span></span>) — sign handling validation:</p>
<ul>
<li><code>negative-3</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mo>−</mo><mn>3</mn><mo separator="true">,</mo><mo>−</mo><mn>2</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (-3, -2, -1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">−</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>, expected output: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span></li>
</ul>
<p><strong>Additive distribution</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>5</mn><mo separator="true">,</mo><mn>10</mn><mo separator="true">,</mo><mn>30</mn></mrow><annotation encoding="application/x-tex">n = 5, 10, 30</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">30</span></span></span></span>) — <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Additive</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder><mo stretchy="false">(</mo><mn>10</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Additive}}(10, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Additive</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>:</p>
<ul>
<li><code>additive-5</code>, <code>additive-10</code>, <code>additive-30</code>: random samples generated with seed 0</li>
</ul>
<p><strong>Uniform distribution</strong> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>5</mn><mo separator="true">,</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">n = 5, 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em"></span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">100</span></span></span></span>) — <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder accentunder="true"><mi mathvariant="normal">Uniform</mi><mo>⁡</mo><mo stretchy="true">‾</mo></munder><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\underline{\operatorname{Uniform}}(0, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord underline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em"><span style="top:-2.84em"><span class="pstrut" style="height:3em"></span><span class="underline-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop"><span class="mord mathrm">Uniform</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2em"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>:</p>
<ul>
<li><code>uniform-5</code>, <code>uniform-100</code>: random samples generated with seed 1</li>
</ul>
<p>The natural sequence cases validate the basic pairwise difference calculation. Constant samples and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span> are excluded because <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> requires <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\operatorname{Spread}(\mathbf{x}) &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mop"><span class="mord mathrm">Spread</span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span>.</p>
<p><strong>Algorithm stress tests</strong> — edge cases for fast algorithm implementation:</p>
<ul>
<li><code>duplicates-10</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1, 1, 1, 2, 2, 2, 3, 3, 3, 3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span> (many duplicates, stress tie-breaking)</li>
<li><code>parity-odd-7</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>5</mn><mo separator="true">,</mo><mn>6</mn><mo separator="true">,</mo><mn>7</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1, 2, 3, 4, 5, 6, 7)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">7</span><span class="mclose">)</span></span></span></span> (odd sample size, 21 differences)</li>
<li><code>parity-even-6</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>5</mn><mo separator="true">,</mo><mn>6</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1, 2, 3, 4, 5, 6)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">6</span><span class="mclose">)</span></span></span></span> (even sample size, 15 differences)</li>
<li><code>parity-odd-49</code>: 49-element sequence <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mn>49</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 2, \ldots, 49)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">49</span><span class="mclose">)</span></span></span></span> (large odd, 1176 differences)</li>
<li><code>parity-even-50</code>: 50-element sequence <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mn>50</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1, 2, \ldots, 50)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">50</span><span class="mclose">)</span></span></span></span> (large even, 1225 differences)</li>
</ul>
<p><strong>Extreme values</strong> — numerical stability and range tests:</p>
<ul>
<li><code>extreme-large-5</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mn>10</mn><mn>8</mn></msup><mo separator="true">,</mo><mn>2</mn><mo>⋅</mo><msup><mn>10</mn><mn>8</mn></msup><mo separator="true">,</mo><mn>3</mn><mo>⋅</mo><msup><mn>10</mn><mn>8</mn></msup><mo separator="true">,</mo><mn>4</mn><mo>⋅</mo><msup><mn>10</mn><mn>8</mn></msup><mo separator="true">,</mo><mn>5</mn><mo>⋅</mo><msup><mn>10</mn><mn>8</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (10^8, 2 \cdot 10^8, 3 \cdot 10^8, 4 \cdot 10^8, 5 \cdot 10^8)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> (very large values)</li>
<li><code>extreme-small-5</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup><mo separator="true">,</mo><mn>2</mn><mo>⋅</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup><mo separator="true">,</mo><mn>3</mn><mo>⋅</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup><mo separator="true">,</mo><mn>4</mn><mo>⋅</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup><mo separator="true">,</mo><mn>5</mn><mo>⋅</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>8</mn></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (10^{-8}, 2 \cdot 10^{-8}, 3 \cdot 10^{-8}, 4 \cdot 10^{-8}, 5 \cdot 10^{-8})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> (very small positive values)</li>
<li><code>extreme-wide-5</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>0.001</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>100</mn><mo separator="true">,</mo><mn>1000</mn><mo separator="true">,</mo><mn>1000000</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (0.001, 1, 100, 1000, 1000000)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">0.001</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">100</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1000000</span><span class="mclose">)</span></span></span></span> (wide range, tests precision)</li>
</ul>
<p><strong>Unsorted tests</strong> — verify sorting correctness (10 tests):</p>
<ul>
<li><code>unsorted-reverse-{n}</code> for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>i</mi><mi>n</mi><mrow><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>5</mn><mo separator="true">,</mo><mn>7</mn></mrow></mrow><annotation encoding="application/x-tex">n in {2, 3, 4, 5, 7}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal">nin</span><span class="mord"><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">7</span></span></span></span></span>: reverse sorted natural sequences (5 tests)</li>
<li><code>unsorted-shuffle-3</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>3</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (3, 1, 2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span> (rotated)</li>
<li><code>unsorted-shuffle-4</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>4</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (4, 2, 1, 3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span> (mixed order)</li>
<li><code>unsorted-shuffle-5</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>5</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (5, 1, 3, 2, 4)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">4</span><span class="mclose">)</span></span></span></span> (partial shuffle)</li>
<li><code>unsorted-duplicates-unsorted-10</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (2, 3, 1, 3, 2, 1, 2, 3, 1, 3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span> (duplicates mixed)</li>
<li><code>unsorted-extreme-wide-unsorted-5</code>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1000</mn><mo separator="true">,</mo><mn>0.001</mn><mo separator="true">,</mo><mn>1000000</mn><mo separator="true">,</mo><mn>100</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1000, 0.001, 1000000, 100, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">0.001</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1000000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">100</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> (wide range unsorted)</li>
</ul>
<p>These tests verify that implementations correctly sort input before computing pairwise differences. Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Spread</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Spread}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mop"><span class="mord mathrm">Spread</span></span></span></span></span> uses absolute differences, order-dependent bugs would manifest differently than in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Center</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\operatorname{Center}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mop"><span class="mord mathrm">Center</span></span></span></span></span>.</p>
<p><strong>Performance test</strong> — validates the fast <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> algorithm:</p>
<ul>
<li><strong>Input</strong>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mn>100000</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = (1, 2, 3, \ldots, 100000)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">100000</span><span class="mclose">)</span></span></span></span></li>
<li><strong>Expected output</strong>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>29290</mn></mrow><annotation encoding="application/x-tex">29290</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">29290</span></span></span></span></li>
<li><strong>Time constraint</strong>: Must complete in under 5 seconds</li>
<li><strong>Purpose</strong>: Ensures that the implementation uses the efficient algorithm rather than materializing all <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mi>n</mi><mn>2</mn></mfrac><mo fence="true">)</mo></mrow><mo>≈</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">\binom{n}{2} \approx 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em"></span><span class="mord"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">(</span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7454em"><span style="top:-2.355em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.144em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">5</span></span></span></span> billion pairwise differences</li>
</ul>
<p>This test case is not stored in the repository because it generates a large JSON file (approximately 1.5 MB). Each language implementation should manually implement this test with the hardcoded expected result.</p>
<h2 id="references">References</h2>
<div class="bib-entry"><div class="bib-title">Geometry and Statistics: Problems at the Interface</div><div class="bib-authors">Shamos, Michael Ian (1976)</div></div>
<div class="bib-entry"><div class="bib-title">Robust statistics</div><div class="bib-authors">Huber, Peter J (2009)</div><div class="bib-venue">International encyclopedia of statistical science</div></div>
<div class="bib-entry"><div class="bib-title">Algorithm 616: fast computation of the Hodges-Lehmann location estimator</div><div class="bib-authors">Monahan, John F (1984)</div><div class="bib-venue">ACM Transactions on Mathematical Software</div><div class="bib-doi"><a href="https://doi.org/10.1145/1271.319414" target="_blank">DOI: 10.1145/1271.319414</a></div></div>  <nav class="prev-next-nav" aria-label="Page navigation" data-astro-cid-fxft7bm5><div class="prev-next-container" data-astro-cid-fxft7bm5><a href="/center-bounds" class="prev-next-link prev" data-astro-cid-fxft7bm5><span class="prev-next-direction" data-astro-cid-fxft7bm5>Previous</span><span class="prev-next-title" data-astro-cid-fxft7bm5>CenterBounds</span></a><a href="/spread-bounds" class="prev-next-link next" data-astro-cid-fxft7bm5><span class="prev-next-direction" data-astro-cid-fxft7bm5>Next</span><span class="prev-next-title" data-astro-cid-fxft7bm5>SpreadBounds</span></a></div></nav> </article> </main> <!-- Expand button (visible when sidebar is collapsed) --> <button id="sidebar-expand" class="sidebar-expand" aria-label="Expand sidebar" data-astro-cid-mw7aashj> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-mw7aashj> <polyline points="13 17 18 12 13 7" data-astro-cid-mw7aashj></polyline> <polyline points="6 17 11 12 6 7" data-astro-cid-mw7aashj></polyline> </svg> </button> </div>  <header class="mobile-header" data-astro-cid-mw7aashj> <button id="menu-button" class="menu-button" aria-label="Toggle navigation menu" aria-expanded="false" data-astro-cid-4yyail6s> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-astro-cid-4yyail6s> <line x1="3" y1="6" x2="21" y2="6" data-astro-cid-4yyail6s></line> <line x1="3" y1="12" x2="21" y2="12" data-astro-cid-4yyail6s></line> <line x1="3" y1="18" x2="21" y2="18" data-astro-cid-4yyail6s></line> </svg> </button>  <a href="/" class="mobile-logo" data-astro-cid-mw7aashj>Pragmastat</a> <div class="mobile-header-right" data-astro-cid-mw7aashj> <a href="https://github.com/AndreyAkinshin/pragmastat" class="github-button" target="_blank" rel="noopener noreferrer" aria-label="GitHub repository" data-astro-cid-xtw5atjx> <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-astro-cid-xtw5atjx> <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" data-astro-cid-xtw5atjx></path> </svg> </a>  <div class="theme-switcher" data-astro-cid-dz5h74bc> <button class="theme-button" id="theme-button" aria-label="Toggle theme" aria-haspopup="true" data-astro-cid-dz5h74bc> <svg class="icon icon-system" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg> <svg class="icon icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg> <svg class="icon icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg> </button> <div class="theme-dropdown" id="theme-dropdown" data-astro-cid-dz5h74bc> <button class="theme-option" data-theme="system" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="10" data-astro-cid-dz5h74bc></circle> <path d="M12 2a10 10 0 0 1 0 20" fill="currentColor" stroke="none" data-astro-cid-dz5h74bc></path> </svg>
System
</button> <button class="theme-option" data-theme="light" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <circle cx="12" cy="12" r="5" data-astro-cid-dz5h74bc></circle> <line x1="12" y1="1" x2="12" y2="3" data-astro-cid-dz5h74bc></line> <line x1="12" y1="21" x2="12" y2="23" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" data-astro-cid-dz5h74bc></line> <line x1="1" y1="12" x2="3" y2="12" data-astro-cid-dz5h74bc></line> <line x1="21" y1="12" x2="23" y2="12" data-astro-cid-dz5h74bc></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" data-astro-cid-dz5h74bc></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" data-astro-cid-dz5h74bc></line> </svg>
Light
</button> <button class="theme-option" data-theme="dark" data-astro-cid-dz5h74bc> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-dz5h74bc> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-dz5h74bc></path> </svg>
Dark
</button> </div> </div>   </div> </header>  <div class="sidebar-overlay" id="sidebar-overlay" data-astro-cid-mw7aashj></div> <script type="module" src="/_astro/DocsLayout.astro_astro_type_script_index_0_lang.Drf88MQ-.js"></script>  </body></html> 