name: ci
run-name: "[ci] ${{ github.event.head_commit.message }}"

on:
  pull_request:
  push:
    branches:
      - '**'
  workflow_dispatch:
  workflow_call:
    inputs:
      release:
        description: 'Build in release mode'
        type: boolean
        default: false
    secrets:
      GRADLE_SIGNING_KEY:
        required: false
      GRADLE_SIGNING_PASSWORD:
        required: false

jobs:
  build-img:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      working-directory: img

    - name: Generate images
      run: mise run img:build

    - name: Upload image artifacts
      uses: actions/upload-artifact@v4
      with:
        name: img
        path: img/

  build-pdf:
    needs: build-img
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        name: img
        path: img/

    - name: Generate auxiliary files
      run: mise run gen:build${{ inputs.release && ':release' || '' }}

    - name: Install LaTeX packages and build PDF
      uses: docker://pandoc/latex:3.7
      env:
        GITHUB_WORKSPACE: ${{ github.workspace }}
        RELEASE_MODE: ${{ inputs.release }}
      with:
        entrypoint: /bin/sh
        args: -c "set -euo pipefail && tlmgr --version && tlmgr update --self && tlmgr install pgf caption textpos mdframed zref needspace csquotes multirow wrapfig colortbl pdflscape tabu varwidth threeparttable threeparttablex environ trimspaces ulem makecell biblatex logreq biber fvextra upquote lineno && cd \"$GITHUB_WORKSPACE/pdf\" && VERSION=$(cat ../manual/version.txt) && if [ \"$RELEASE_MODE\" = \"true\" ]; then SUFFIX=\"\"; else SUFFIX=\"-draft\"; fi && pandoc 'pragmastat.md' --pdf-engine=latexmk --pdf-engine-opt=-xelatex --pdf-engine-opt=-shell-escape --pdf-engine-opt=-interaction=batchmode --number-sections --citeproc -o \"pragmastat-v${VERSION}${SUFFIX}.pdf\""

    - name: Upload pdf artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pdf
        path: pdf/*.pdf

  build-web:
    needs: [build-img, build-pdf]
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        name: img
        path: img/

    - name: Download pdf artifacts
      uses: actions/download-artifact@v4
      with:
        name: pdf
        path: pdf/

    - name: Generate auxiliary files
      run: mise run gen:build${{ inputs.release && ':release' || '' }}

    - name: Initialize web tools
      run: mise run web:restore

    - name: Build website
      run: mise run web:build${{ inputs.release && ':release' || '' }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web
        path: web/public

  build-r:
    runs-on: ubuntu-24.04
    container: rocker/verse:4.5.1
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        tlmgr update --self
        tlmgr install amsfonts

    - name: Copy test data
      run: |
        mkdir -p r/pragmastat/tests/tests
        cp -r tests/* r/pragmastat/tests/tests/

    - name: Check package
      run: R CMD check --no-tests --no-check-dependencies r/pragmastat

    - name: Build package
      run: |
        cd r
        rm -rf pragmastat/src/*.o pragmastat/src/*.so pragmastat/src/*.dll 2>/dev/null || true
        R CMD build pragmastat

    - name: Test package
      run: cd r/pragmastat && Rscript -e "devtools::test()"

    - name: Upload r artifacts
      uses: actions/upload-artifact@v4
      with:
        name: r
        path: 'r/*.tar.gz'

  build-cs:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Build
      run: mise run cs:build${{ inputs.release && ':release' || '' }}

    - name: Test
      run: mise run cs:test

    - name: Pack
      run: mise run cs:pack

    - name: Upload cs artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cs
        path: cs/artifacts

  build-py:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest build twine ruff
      working-directory: py

    - name: Install package in development mode
      run: mise run py:restore

    - name: Check code (lint and format)
      run: mise run py:check

    - name: Run tests
      run: mise run py:test

    - name: Build and verify package
      run: mise run py:pack

    - name: Upload py artifacts
      uses: actions/upload-artifact@v4
      with:
        name: py
        path: py/dist/

  build-rs:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: rs/pragmastat/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Check package
      run: mise run rs:check

    - name: Run tests
      run: mise run rs:test

    - name: Build
      run: mise run rs:build${{ inputs.release && ':release' || '' }}

    - name: Package crate
      run: mise run rs:pack

    - name: Upload rs artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rs
        path: rs/pragmastat/target/package/*.crate

  build-ts:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ts/package-lock.json

    - name: Install dependencies
      run: mise run ts:restore

    - name: Check formatting and linting
      run: mise run ts:check

    - name: Run tests
      run: mise run ts:test

    - name: Build TypeScript
      run: mise run ts:build

    - name: Create tarball
      run: mise run ts:pack

    - name: Upload ts artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ts
        path: ts/*.tgz

  build-go:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Download dependencies
      run: mise run go:restore

    - name: Check formatting
      run: |
        if [ -n "$(go fmt ./...)" ]; then
          echo "Code is not formatted. Please run 'go fmt ./...'"
          exit 1
        fi
      working-directory: go

    - name: Run tests
      run: mise run go:test:verbose

    - name: Run tests with coverage
      run: go test -race -coverprofile=coverage.out -covermode=atomic ./...
      working-directory: go

    - name: Build
      run: mise run go:build

    - name: Upload go artifacts
      uses: actions/upload-artifact@v4
      with:
        name: go
        path: go/

  build-kt:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      continue-on-error: true
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: kt

    - name: Build, test, and publish to staging (release mode)
      if: inputs.release
      run: ./gradlew publish --info --stacktrace
      working-directory: kt
      env:
        GRADLE_SIGNING_KEY: ${{ secrets.GRADLE_SIGNING_KEY }}
        GRADLE_SIGNING_PASSWORD: ${{ secrets.GRADLE_SIGNING_PASSWORD }}

    - name: Build and test (non-release mode)
      if: ${{ !inputs.release }}
      run: mise run kt:build

    - name: Upload kt artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kt
        path: |
          kt/build/libs/
          kt/build/staging-deploy/
