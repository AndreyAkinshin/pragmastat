name: ci
run-name: "[ci] ${{ github.event.head_commit.message }}"

on:
  pull_request:
  push:
    branches:
      - '**'
  workflow_dispatch:
  workflow_call:
    inputs:
      release:
        description: 'Build in release mode'
        type: boolean
        default: false
    secrets:
      GRADLE_SIGNING_KEY:
        required: false
      GRADLE_SIGNING_PASSWORD:
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Manual (img + pdf + web)
  # ==========================================================================

  ci-manual:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    # --- Rust tools (for Typst → MDX conversion) ---
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust tools
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "tools -> target"

    # --- Image generation ---
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install image dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      working-directory: img

    - name: Generate images
      run: mise run img:build

    # --- PDF generation ---
    - name: Install Typst
      uses: typst-community/setup-typst@v4

    - name: Download fonts
      run: mise run pdf:restore

    - name: Build PDF
      run: mise run pdf:build

    # --- Web build ---
    - name: Install web dependencies
      run: mise run web:restore

    - name: Build website
      run: mise run web:build${{ inputs.release && ':release' || '' }}

    - name: Copy PDF to web output
      run: cp manual/pragmastat.pdf web/dist/

    # --- Upload artifacts (release only) ---
    - name: Upload web artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: web
        path: web/dist
        retention-days: 1

    - name: Upload pdf artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: pdf
        path: manual/pragmastat.pdf
        retention-days: 1

  # ==========================================================================
  # Language Builds (all run in parallel)
  # ==========================================================================

  ci-r:
    runs-on: ubuntu-24.04
    container: rocker/verse:4.5.1
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        tlmgr update --self
        tlmgr install amsfonts

    - name: Copy test data
      run: |
        mkdir -p r/pragmastat/tests/tests
        cp -r tests/* r/pragmastat/tests/tests/

    - name: Check package
      run: R CMD check --no-tests --no-check-dependencies r/pragmastat

    - name: Build package
      run: |
        cd r
        rm -rf pragmastat/src/*.o pragmastat/src/*.so pragmastat/src/*.dll 2>/dev/null || true
        R CMD build pragmastat

    - name: Test package
      run: cd r/pragmastat && Rscript -e "devtools::test()"

    - name: Upload r artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: r
        path: 'r/*.tar.gz'
        retention-days: 1

  ci-cs:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'

    - name: Check
      run: mise run cs:check

    - name: Build
      run: mise run cs:build${{ inputs.release && ':release' || '' }}

    - name: Test
      run: mise run cs:test

    - name: Pack
      run: |
        mkdir -p ./artifacts
        dotnet pack ./Pragmastat/Pragmastat.csproj --configuration Release --include-symbols --include-source -p:SymbolPackageFormat=snupkg --output ./artifacts
      working-directory: cs

    - name: Upload cs artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: cs
        path: cs/artifacts
        retention-days: 1

  ci-py:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install package and dependencies
      run: mise run py:restore

    - name: Check code (lint and format)
      run: mise run py:check

    - name: Run tests
      run: mise run py:test

    - name: Build package
      run: mise run py:pack

    - name: Upload py artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: py
        path: py/dist/
        retention-days: 1

  ci-rs:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Rust
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "rs/pragmastat -> target"

    - name: Check package
      run: mise run rs:check

    - name: Run tests
      run: mise run rs:test

    - name: Build
      run: mise run rs:build${{ inputs.release && ':release' || '' }}

    - name: Package crate
      run: mise run rs:pack

    - name: Upload rs artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: rs
        path: rs/pragmastat/target/package/*.crate
        retention-days: 1

  ci-ts:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: ts/pnpm-lock.yaml

    - name: Install dependencies
      run: mise run ts:restore

    - name: Check formatting and linting
      run: mise run ts:check

    - name: Run tests
      run: mise run ts:test

    - name: Build TypeScript
      run: mise run ts:build

    - name: Create tarball
      run: mise run ts:pack

    - name: Upload ts artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: ts
        path: ts/*.tgz
        retention-days: 1

  ci-go:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Download dependencies
      run: mise run go:restore

    - name: Check
      run: mise run go:check

    - name: Test
      run: mise run go:test

    - name: Build
      run: mise run go:build

    - name: Upload go artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: go
        path: go/
        retention-days: 1

  ci-kt:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Set up mise
      uses: jdx/mise-action@v2

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      continue-on-error: true
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: kt

    - name: Build, test, and publish to staging (release mode)
      if: inputs.release
      run: ./gradlew publish --info --stacktrace
      working-directory: kt
      env:
        GRADLE_SIGNING_KEY: ${{ secrets.GRADLE_SIGNING_KEY }}
        GRADLE_SIGNING_PASSWORD: ${{ secrets.GRADLE_SIGNING_PASSWORD }}

    - name: Build and test (non-release mode)
      if: ${{ !inputs.release }}
      run: mise run kt:build

    - name: Upload kt artifacts
      if: inputs.release
      uses: actions/upload-artifact@v4
      with:
        name: kt
        path: |
          kt/build/libs/
          kt/build/staging-deploy/
        retention-days: 1

  # ==========================================================================
  # Summary Gate — single status check for branch protection
  # ==========================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [ci-manual, ci-r, ci-cs, ci-py, ci-rs, ci-ts, ci-go, ci-kt]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.ci-manual.result }}" != "success" ]] || \
             [[ "${{ needs.ci-r.result }}" != "success" ]] || \
             [[ "${{ needs.ci-cs.result }}" != "success" ]] || \
             [[ "${{ needs.ci-py.result }}" != "success" ]] || \
             [[ "${{ needs.ci-rs.result }}" != "success" ]] || \
             [[ "${{ needs.ci-ts.result }}" != "success" ]] || \
             [[ "${{ needs.ci-go.result }}" != "success" ]] || \
             [[ "${{ needs.ci-kt.result }}" != "success" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
