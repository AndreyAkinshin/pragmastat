<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.152.2"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content='Andrey Akinshin'><meta name=description content="This manual presents a toolkit of statistical procedures that provide reliable results across diverse real-world distributions, with ready-to-use implementations and detailed explanations. The toolkit consists of renamed, recombined, and refined versions of existing methods. Written for software developers, mathematicians, and LLMs."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><title>Pragmastat: Pragmatic Statistical Toolkit</title><script>(()=>{localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")})()</script><link href=/css/styles.min.d72e881da49b461e7bde354236584913fbb81748c7b19b1d6fd738ff3fd34778.css rel=stylesheet type=text/css media=all></head><body class="flex flex-col min-h-screen px-1 xs:px-3 sm:px-5"><nav><div class="flex items-center justify-between mx-auto max-w-4xl h-12"><div class="flex items-center gap-5"><a href=/ title="Main page"><svg class="icon"><use xlink:href="/icons.min.73dbd563123d13b8d88c4f974db0234402fe94a8c0a82c09677420f2800331cc.svg#home"/></svg></a>
<a href=https://github.com/AndreyAkinshin/pragmastat title=GitHub><svg class="icon"><use xlink:href="/icons.min.73dbd563123d13b8d88c4f974db0234402fe94a8c0a82c09677420f2800331cc.svg#github"/></svg></a>
<a href=/pragmastat.pdf title=PDF><svg class="icon"><use xlink:href="/icons.min.73dbd563123d13b8d88c4f974db0234402fe94a8c0a82c09677420f2800331cc.svg#pdf"/></svg></a>
<a href=/pragmastat.md title=Markdown><svg class="icon"><use xlink:href="/icons.min.73dbd563123d13b8d88c4f974db0234402fe94a8c0a82c09677420f2800331cc.svg#md"/></svg></a></div><button id=theme-toggle type=button title="Toggle theme" class="w-12 h-12 content-center justify-self-end">
<svg id="theme-toggle-system-icon" class="hidden fill-current text-link hover:text-highlight w-6 h-6 pr-0 mb-0.5" viewBox="0 0 20 20"><use xlink:href="/icons.min.73dbd563123d13b8d88c4f974db0234402fe94a8c0a82c09677420f2800331cc.svg#system-theme"/></svg>
<svg id="theme-toggle-dark-icon" class="hidden fill-current text-link hover:text-highlight w-6 h-6 pr-0 mb-0.5" viewBox="0 0 20 20"><use xlink:href="/icons.min.73dbd563123d13b8d88c4f974db0234402fe94a8c0a82c09677420f2800331cc.svg#moon"/></svg>
<svg id="theme-toggle-light-icon" class="hidden fill-current text-link hover:text-highlight w-6 h-6 pr-0 mb-0.5" viewBox="0 0 20 20"><use xlink:href="/icons.min.73dbd563123d13b8d88c4f974db0234402fe94a8c0a82c09677420f2800331cc.svg#sun"/></svg></button></div></nav><div class="main container mx-auto max-w-4xl pt-3 pb-6 flex-grow"><h1 class="text-3xl text-center"><span class="hidden md:inline">Pragmastat: Pragmatic Statistical Toolkit</span>
<span class="inline md:hidden">Pragmastat:<br>Pragmatic Statistical Toolkit</span></h1><div class="my-2 text-center text-xl"><a href=https://aakinshin.net>Andrey Akinshin</a></div><div class="mt-2 mb-2 text-center text-lg"><a href=#py>Python</a> ·
<a href=#ts>TypeScript</a> ·
<a href=#r>R</a> ·
<a href=#cs>C#</a> ·
<a href=#kt>Kotlin</a> ·
<a href=#rs>Rust</a> ·
<a href=#go>Go</a></div><div class="mt-2 mb-6 text-center text-l">Version 3.2.2<br>DOI: <a href=https://doi.org/10.5281/zenodo.17236778>10.5281/zenodo.17236778</a></div><div class=markup><div style=display:none>$$
% Samples
\newcommand{\x}{\mathbf{x}}
\newcommand{\y}{\mathbf{y}}
\newcommand{\z}{\mathbf{z}}
\newcommand{\X}{\mathbf{X}}
\newcommand{\Y}{\mathbf{Y}}
\newcommand{\Z}{\mathbf{Z}}
% Help estimators
\newcommand{\Median}{\operatorname{Median}}
\newcommand{\Quantile}{\operatorname{Quantile}}
% Toolkit: One-sample estimators
\newcommand{\Center}{\operatorname{Center}}
\newcommand{\Spread}{\operatorname{Spread}}
\newcommand{\RelSpread}{\operatorname{RelSpread}}
% Toolkit: Two-sample estimators
\newcommand{\Shift}{\operatorname{Shift}}
\newcommand{\Ratio}{\operatorname{Ratio}}
\newcommand{\AvgSpread}{\operatorname{AvgSpread}}
\newcommand{\Disparity}{\operatorname{Disparity}}
% Functions
\newcommand{\PairwiseMargin}{\operatorname{PairwiseMargin}}
% Distributions
\newcommand{\Additive}{\underline{\operatorname{Additive}}}
\newcommand{\Multiplic}{\underline{\operatorname{Multiplic}}}
\newcommand{\Power}{\underline{\operatorname{Power}}}
\newcommand{\Exp}{\underline{\operatorname{Exp}}}
\newcommand{\Uniform}{\underline{\operatorname{Uniform}}}
% Misc
\newcommand{\Var}{\mathbb{V}} % Variance
\newcommand{\E}{\mathbb{E}} % Expected value
\newcommand{\eff}{\operatorname{eff}} % Efficiency
\newcommand{\misrate}{\textrm{misrate}}
\newcommand{\Drift}{\operatorname{Drift}}
\newcommand{\AvgDrift}{\operatorname{AvgDrift}}
\newcommand{\DispDrift}{\operatorname{DispDrift}}
% Traditional estimators
\newcommand{\Mean}{\operatorname{Mean}}
\newcommand{\StdDev}{\operatorname{StdDev}}
\newcommand{\MAD}{\operatorname{MAD}}
\newcommand{\RC}{\operatorname{RC}}
$$</div><p>This manual presents a toolkit of statistical procedures that
provide reliable results across diverse real-world distributions,
with ready-to-use implementations and detailed explanations.
The toolkit consists of renamed, recombined, and refined versions of existing methods.
Written for software developers, mathematicians, and LLMs.</p><p><div id=toc-container><h1 class="cursor-pointer select-none flex items-center gap-2" onclick=toggleToc()><span id=toc-arrow class="transform transition-transform duration-200">▼</span>
Table of Content</h1><div id=toc-content class="hidden toc"><nav id=TableOfContents><ul><li><a href=#1-introduction>§1. Introduction</a><ul><li><a href=#11-primer>§1.1. Primer</a></li><li><a href=#12-breaking-changes>§1.2. Breaking changes</a></li><li><a href=#13-definitions>§1.3. Definitions</a></li></ul></li><li><a href=#2-summary-estimators>§2. Summary Estimators</a><ul><li><a href=#21-center>§2.1. Center</a></li><li><a href=#22-spread>§2.2. Spread</a></li><li><a href=#23-relspread>§2.3. RelSpread</a></li><li><a href=#24-shift>§2.4. Shift</a></li><li><a href=#25-ratio>§2.5. Ratio</a></li><li><a href=#26-avgspread>§2.6. AvgSpread</a></li><li><a href=#27-disparity-robust-effect-size>§2.7. Disparity (&lsquo;robust effect size&rsquo;)</a></li></ul></li><li><a href=#3-distributions>§3. Distributions</a><ul><li><a href=#31-additive-normal>§3.1. Additive (&lsquo;Normal&rsquo;)</a></li><li><a href=#32-multiplic-lognormal>§3.2. Multiplic (&lsquo;LogNormal&rsquo;)</a></li><li><a href=#33-exponential>§3.3. Exponential</a></li><li><a href=#34-power-pareto>§3.4. Power (&lsquo;Pareto&rsquo;)</a></li><li><a href=#35-uniform>§3.5. Uniform</a></li></ul></li><li><a href=#4-summary-estimator-properties>§4. Summary Estimator Properties</a><ul><li><a href=#41-breakdown>§4.1. Breakdown</a></li><li><a href=#42-drift>§4.2. Drift</a></li><li><a href=#43-invariance>§4.3. Invariance</a></li></ul></li><li><a href=#5-methodology>§5. Methodology</a><ul><li><a href=#51-desiderata>§5.1. Desiderata</a></li><li><a href=#52-from-assumptions-to-conditions>§5.2. From Assumptions to Conditions</a></li><li><a href=#53-from-statistical-efficiency-to-drift>§5.3. From Statistical Efficiency to Drift</a></li></ul></li><li><a href=#6-algorithms>§6. Algorithms</a><ul><li><a href=#61-fast-center>§6.1. Fast Center</a></li><li><a href=#62-fast-spread>§6.2. Fast Spread</a></li><li><a href=#63-fast-shift>§6.3. Fast Shift</a></li></ul></li><li><a href=#7-studies>§7. Studies</a><ul><li><a href=#71-additive-normal-distribution>§7.1. Additive (&lsquo;Normal&rsquo;) Distribution</a><ul><li><a href=#711-asymptotic-spread-value>§7.1.1. Asymptotic Spread Value</a></li><li><a href=#712-lemma-average-estimator-drift-formula>§7.1.2. Lemma: Average Estimator Drift Formula</a></li><li><a href=#713-asymptotic-mean-drift>§7.1.3. Asymptotic Mean Drift</a></li><li><a href=#714-asymptotic-median-drift>§7.1.4. Asymptotic Median Drift</a></li><li><a href=#715-asymptotic-center-drift>§7.1.5. Asymptotic Center Drift</a></li><li><a href=#716-lemma-dispersion-estimator-drift-formula>§7.1.6. Lemma: Dispersion Estimator Drift Formula</a></li><li><a href=#717-asymptotic-stddev-drift>§7.1.7. Asymptotic StdDev Drift</a></li><li><a href=#718-asymptotic-mad-drift>§7.1.8. Asymptotic MAD Drift</a></li><li><a href=#719-asymptotic-spread-drift>§7.1.9. Asymptotic Spread Drift</a></li><li><a href=#7110-summary>§7.1.10. Summary</a></li></ul></li></ul></li><li><a href=#8-reference-implementations>§8. Reference Implementations</a><ul><li><a href=#81-python>§8.1. Python</a></li><li><a href=#82-typescript>§8.2. TypeScript</a></li><li><a href=#83-r>§8.3. R</a></li><li><a href=#84-c>§8.4. C#</a></li><li><a href=#85-kotlin>§8.5. Kotlin</a></li><li><a href=#86-rust>§8.6. Rust</a></li><li><a href=#87-go>§8.7. Go</a></li></ul></li><li><a href=#9-reference-tests>§9. Reference Tests</a><ul><li><a href=#91-motivation>§9.1. Motivation</a></li><li><a href=#92-center>§9.2. Center</a></li><li><a href=#93-spread>§9.3. Spread</a></li><li><a href=#94-relspread>§9.4. RelSpread</a></li><li><a href=#95-shift>§9.5. Shift</a></li><li><a href=#96-ratio>§9.6. Ratio</a></li><li><a href=#97-avgspread>§9.7. AvgSpread</a></li><li><a href=#98-disparity>§9.8. Disparity</a></li><li><a href=#99-test-framework>§9.9. Test Framework</a></li></ul></li><li><a href=#10-artifacts>§10. Artifacts</a></li></ul></nav></div></div><script>function toggleToc(){const e=document.getElementById("toc-content"),t=document.getElementById("toc-arrow");e.classList.contains("hidden")?(e.classList.remove("hidden"),t.classList.add("rotate-180")):(e.classList.add("hidden"),t.classList.remove("rotate-180"))}</script></p><h1 id=1-introduction>§1. Introduction</h1><h2 id=11-primer>§1.1. Primer</h2><p>Given two numeric samples $\x = (x_1, \ldots, x_n)$ and $\y = (y_1, \ldots, y_m)$, the toolkit provides the following primary procedures:</p><p>$\Center(\x) = \underset{1 \leq i \leq j \leq n}{\Median} \left((x_i + x_j)/2 \right)$ — robust average of $\x$</p><p>For $\x = (0, 2, 4, 6, 8)$:</p>$$
\begin{aligned}
\Center(\x) &= 4 \\
\Center(\x + 10) &= 14 \\
\Center(3\x) &= 12
\end{aligned}
$$<p>$\Spread(\x) = \underset{1 \leq i < j \leq n}{\Median} |x_i - x_j|$ — robust dispersion of $\x$</p><p>For $\x = (0, 2, 4, 6, 8)$:</p>$$
\begin{aligned}
\Spread(\x) &= 4 \\
\Spread(\x + 10) &= 4 \\
\Spread(2\x) &= 8
\end{aligned}
$$<p>$\RelSpread(\x) = \Spread(\x) / \left| \Center(\x) \right|$ — robust relative dispersion of $\x$</p><p>For $\x = (0, 2, 4, 6, 8)$:</p>$$
\begin{aligned}
\RelSpread(\x) &= 1 \\
\RelSpread(5\x) &= 1
\end{aligned}
$$<p>$\Shift(\x, \y) = \underset{1 \leq i \leq n, 1 \leq j \leq m}{\Median} \left(x_i - y_j \right)$ — robust signed difference ($\x-\y$)</p><p>For $\x = (0, 2, 4, 6, 8)$ and $\y = (10, 12, 14, 16, 18)$:</p>$$
\begin{aligned}
\Shift(\x, \y) &= -10 \\
\Shift(\x, \x) &= 0 \\
\Shift(\x + 7, \y + 3) &= -6 \\
\Shift(2\x, 2\y) &= -20 \\
\Shift(\y, \x) &= 10
\end{aligned}
$$<p>$\Ratio(\x, \y) = \underset{1 \leq i \leq n, 1 \leq j \leq m}{\Median} \left( x_i / y_j \right)$ — robust ratio ($\x/\y$)</p><p>For $\x = (1, 2, 4, 8, 16)$ and $\y = (2, 4, 8, 16, 32)$:</p>$$
\begin{aligned}
\Ratio(\x, \y) &= 0.5 \\
\Ratio(\x, \x) &= 1 \\
\Ratio(2\x, 5\y) &= 0.2
\end{aligned}
$$<p>$\AvgSpread(\x, \y) = (n\Spread(\x) + m\Spread(\y)) / (n + m)$ — robust average spread of $\x$ and $\y$</p><p>For $\x = (0, 3, 6, 9, 12)$ and $\y = (0, 2, 4, 6, 8)$:</p>$$
\begin{aligned}
\Spread(\x) &= 6 \\
\Spread(\y) &= 4 \\
\AvgSpread(\x, \y) &= 5 \\
\AvgSpread(\x, \x) &= 6 \\
\AvgSpread(2\x, 3\x) &= 15 \\
\AvgSpread(\y, \x) &= 5 \\
\AvgSpread(2\x, 2\y) &= 10
\end{aligned}
$$<p>$\Disparity(\x, \y) = \Shift(\x, \y) / \AvgSpread(\x, \y)$ — robust effect size between $\x$ and $\y$</p><p>For $\x = (0, 3, 6, 9, 12)$ and $\y = (0, 2, 4, 6, 8)$:</p>$$
\begin{aligned}
\Shift(\x, \y) &= 2 \\
\AvgSpread(\x, \y) &= 5 \\
\Disparity(\x, \y) &= 0.4 \\
\Disparity(\x + 5, \y + 5) &= 0.4 \\
\Disparity(2\x, 2\y) &= 0.4 \\
\Disparity(\y, \x) &= -0.4
\end{aligned}
$$<p>These procedures are designed to serve as default choices for routine analysis and comparison tasks in engineering contexts.
The toolkit has ready-to-use implementations for Python, TypeScript/JavaScript, R, C#, Kotlin, Rust, and Go.</p><h2 id=12-breaking-changes>§1.2. Breaking changes</h2><p>Statistical practice has evolved through decades of research and teaching,
creating a system where historical naming conventions became embedded in textbooks and standard practice.
Traditional statistics often names procedures after their discoverers or uses arbitrary symbols
that reveal nothing about their actual purpose or application context.
This approach forces practitioners to memorize meaningless mappings between historical figures and mathematical concepts.</p><p>The result is unnecessary friction for anyone learning or applying statistical methods.
Beginners face an inconsistent landscape of confusing names, fragile defaults,
and incompatible approaches with little guidance on selection or interpretation.
Modern practitioners would benefit from a more consistent system, which requires some renaming and redefining.
This manual offers a coherent system designed for clarity and practical use, breaking from tradition.
The following concepts were adopted from traditional textbooks via renaming or reworking:</p><ul><li>Estimators<ul><li>Average: $\Center$ (former &lsquo;Hodges-Lehmann location estimator&rsquo;)</li><li>Dispersion: $\Spread$ (former &lsquo;Shamos scale estimator&rsquo;)</li><li>Effect Size: $\Disparity$ (a robust alternative to &lsquo;Cohen&rsquo;s $d$&rsquo;)</li></ul></li><li>Estimator properties<ul><li>Precision: $\Drift$ (a robust alternative to statistical efficiency)</li></ul></li><li>Distributions<ul><li>$\Additive$ (former &lsquo;Normal&rsquo; or &lsquo;Gaussian&rsquo;)</li><li>$\Multiplic$ (former &lsquo;Log-Normal&rsquo; or &lsquo;Galton&rsquo;)</li><li>$\Power$ (former &lsquo;Pareto&rsquo;)</li></ul></li></ul><h2 id=13-definitions>§1.3. Definitions</h2><ul><li>$X$, $Y$: random variables, can be treated as generators of random real measurements<ul><li>$X \sim \underline{\operatorname{Distribution}}$ defines a distribution from which this variable comes</li></ul></li><li>$x_i, y_j$: specific individual measurements</li><li>$\x = (x_1, x_2, \ldots, x_n)$, $\y = (y_1, y_2, \ldots, y_m)$: samples of measurements of a given size<ul><li>Samples are non-empty: $n, m \geq 1$</li></ul></li><li>$x_{(1)}, x_{(2)}, \ldots, x_{(n)}$: sorted measurements of the sample (&lsquo;order statistics&rsquo;)</li><li>Asymptotic case: the sample size goes to infinity $n, m \to \infty$<ul><li>Can typically be treated as an approximation for large samples</li></ul></li><li>$\operatorname{Estimator}(\x)$: a function that estimates the property of a distribution from given measurements<ul><li>$\operatorname{Estimator}[X]$ shows the true property value of the distribution (asymptotic value)</li></ul></li><li>$\Median$: an estimator that finds the value splitting the distribution into two equal parts</li></ul>$$
\Median(\x) = \begin{cases}
x_{((n+1)/2)} & \text{if } n \text{ is odd} \\
\frac{x_{(n/2)} + x_{(n/2+1)}}{2} & \text{if } n \text{ is even}
\end{cases}
$$<h1 id=2-summary-estimators>§2. Summary Estimators</h1><p>The following sections introduce definitions of one-sample and two-sample summary estimators.
Later sections will evaluate properties of these estimators and applicability to different conditions.</p><h2 id=21-center>§2.1. Center</h2>$$
\Center(\x) = \underset{1 \leq i \leq j \leq n}{\Median} \left(\frac{x_i + x_j}{2} \right)
$$<ul><li>Measures average (central tendency, measure of location)</li><li>Equals the <em>Hodges-Lehmann estimator</em> (<a href=https://pragmastat.dev/references/hodges1963/>hodges1963</a>, <a href=https://pragmastat.dev/references/sen1963/>sen1963</a>), renamed to $\Center$ for clarity</li><li>Also known as &lsquo;pseudomedian&rsquo; because it is consistent with $\Median$ for symmetric distributions</li><li>Pragmatic alternative to $\Mean$ and $\Median$</li><li>Asymptotically, $\Center[X]$ is the $\Median$ of the arithmetic average of two random measurements from $X$</li><li>Straightforward implementations have $O(n^2 \log n)$ complexity; a fast $O(n \log n)$ version is provided in the Algorithms section.</li><li>Domain: any real numbers</li><li>Unit: the same as measurements</li></ul>$$
\Center(\x + k) = \Center(\x) + k
$$$$
\Center(k \cdot \x) = k \cdot \Center(\x)
$$<h2 id=22-spread>§2.2. Spread</h2>$$
\Spread(\x) = \underset{1 \leq i < j \leq n}{\Median} |x_i - x_j|
$$<ul><li>Measures dispersion (variability, scatter)</li><li>Corner case: for $n=1$, $\Spread(\x) = 0$</li><li>Equals the <em>Shamos scale estimator</em> (<a href=https://pragmastat.dev/references/shamos1976/>shamos1976</a>), renamed to $\Spread$ for clarity</li><li>Pragmatic alternative to the standard deviation and the median absolute deviation</li><li>Asymptotically, $\Spread[X]$ is the median of the absolute difference between two random measurements from distribution $X$</li><li>Straightforward implementations have $O(n^2 \log n)$ complexity; a fast $O(n \log n)$ version is provided in the Algorithms section.</li><li>Domain: any real numbers</li><li>Unit: the same as measurements</li></ul>$$
\Spread(\x + k) = \Spread(\x)
$$$$
\Spread(k \cdot \x) = |k| \cdot \Spread(\x)
$$$$
\Spread(\x) \geq 0
$$<h2 id=23-relspread>§2.3. RelSpread</h2>$$
\RelSpread(\x) = \frac{\Spread(\x)}{\left| \Center(\x) \right|}
$$<ul><li>Measures the relative dispersion of a sample to $\Center(\x)$</li><li>Pragmatic alternative to the <em>coefficient of variation</em></li><li>Domain: $\Center(\x) \neq 0$</li><li>Unit: relative</li></ul>$$
\RelSpread(k \cdot \x) = \RelSpread(\x)
$$$$
\RelSpread(\x) \geq 0
$$<h2 id=24-shift>§2.4. Shift</h2>$$
\Shift(\x, \y) = \underset{1 \leq i \leq n,\,\, 1 \leq j \leq m}{\Median} \left(x_i - y_j \right)
$$<ul><li>Measures the median of pairwise differences between elements of two samples</li><li>Equals the <em>Hodges-Lehmann estimator</em> for two samples (<a href=https://pragmastat.dev/references/hodges1963/>hodges1963</a>)</li><li>Asymptotically, $\Shift[X, Y]$ is the median of the difference of random measurements from $X$ and $Y$</li><li>Straightforward implementations have $O(mn \log(mn))$ complexity; a fast $O((m+n) \log L)$ version is provided in the Algorithms section.</li><li>Domain: any real numbers</li><li>Unit: the same as measurements</li></ul>$$
\Shift(\x, \x) = 0
$$$$
\Shift(\x + k_x, \y + k_y) = \Shift(\x, \y) + k_x\!-\!k_y
$$$$
\Shift(k \cdot \x, k \cdot \y) = k \cdot \Shift(\x, \y)
$$$$
\Shift(\x, \y) = -\Shift(\y, \x)
$$<h2 id=25-ratio>§2.5. Ratio</h2>$$
\Ratio(\x, \y) = \underset{1 \leq i \leq n, 1 \leq j \leq m}{\Median} \left( \dfrac{x_i}{y_j} \right)
$$<ul><li>Measures the median of pairwise ratios between elements of two samples</li><li>Asymptotically, $\Ratio[X, Y]$ is the median of the ratio of random measurements from $X$ and $Y$</li><li>Note: $\Ratio(\x, \y) \neq 1 / \Ratio(\y, \x)$ in general (example: $x=(1, 100)$, $y=(1, 10)$)</li><li>Practical Domain: $x_i, y_j > 0$ or $x_i, y_j < 0$. In practice, exclude values with $|y_j|$ near zero.</li><li>Unit: relative</li></ul>$$
\Ratio(\x, \x) = 1
$$$$
\Ratio(k_x \cdot \x, k_y \cdot \y) = \frac{k_x}{k_y} \cdot \Ratio(\x, \y)
$$<h2 id=26-avgspread>§2.6. AvgSpread</h2>$$
\AvgSpread(\x, \y) = \dfrac{n\Spread(\x) + m\Spread(\y)}{n + m}
$$<ul><li>Measures average dispersion across two samples</li><li>Pragmatic alternative to the &lsquo;pooled standard deviation&rsquo;</li><li>Note: $\AvgSpread(\x, \y) \neq \Spread(\x \cup \y)$ in general (defines a pooled scale, not the spread of the concatenated sample)</li><li>Domain: any real numbers</li><li>Unit: the same as measurements</li></ul>$$
\AvgSpread(\x, \x) = \Spread(\x)
$$$$
\AvgSpread(k_1 \cdot \x, k_2 \cdot \x) = \frac{ |k_1| + |k_2| }{2} \cdot \Spread(\x)
$$$$
\AvgSpread(\x, \y) = \AvgSpread(\y, \x)
$$$$
\AvgSpread(k \cdot \x, k \cdot \y) = |k| \cdot \AvgSpread(\x, \y)
$$<h2 id=27-disparity-robust-effect-size>§2.7. Disparity (&lsquo;robust effect size&rsquo;)</h2>$$
\Disparity(\x, \y) = \dfrac{\Shift(\x, \y)}{\AvgSpread(\x, \y)}
$$<ul><li>Measures a normalized $\Shift$ between $\x$ and $\y$ expressed in spread units</li><li>Expresses the &rsquo;effect size&rsquo;, renamed to $\Disparity$ for clarity</li><li>Pragmatic alternative to Cohen&rsquo;s d (note: exact estimates differ due to robust construction)</li><li>Domain: $\AvgSpread(\x, \y) > 0$</li><li>Unit: spread unit</li></ul>$$
\Disparity(\x + k, \y + k) = \Disparity(\x, \y)
$$$$
\Disparity(k\!\cdot\!\x, k\!\cdot\!\y) = \operatorname{sign}(k)\!\cdot\!\Disparity(\x, \y)
$$$$
\Disparity(\x, \y) = -\Disparity(\y, \x)
$$<h1 id=3-distributions>§3. Distributions</h1><p>This section defines the distributions used throughout the manual.</p><h2 id=31-additive-normal>§3.1. Additive (&lsquo;Normal&rsquo;)</h2>$$
\Additive(\mathrm{mean}, \mathrm{stdDev})
$$<ul><li>$\mathrm{mean}$: location parameter (center of the distribution), consistent with $\Center$</li><li>$\mathrm{stdDev}$: scale parameter (standard deviation), can be rescaled to $\Spread$</li></ul><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/distribution-additive_light.png target=_blank alt=distribution-additive><img class=rounded-lg src=/img/distribution-additive_light.png width=800>
</a><a class="img-dark hidden" href=/img/distribution-additive_dark.png target=_blank alt=distribution-additive><img class=rounded-lg src=/img/distribution-additive_dark.png width=800></a></div><ul><li><strong>Formation:</strong> the sum of many variables $X_1 + X_2 + \ldots + X_n$ under mild CLT (Central Limit Theorem) conditions (e.g., Lindeberg-Feller).</li><li><strong>Origin:</strong> historically called &lsquo;Normal&rsquo; or &lsquo;Gaussian&rsquo; distribution after Carl Friedrich Gauss and others.</li><li><strong>Rename Motivation:</strong> renamed to $\Additive$ to reflect its formation mechanism through addition.</li><li><strong>Properties:</strong> symmetric, bell-shaped, characterized by central limit theorem convergence.</li><li><strong>Applications:</strong> measurement errors, heights and weights in populations, test scores, temperature variations.</li><li><strong>Characteristics:</strong> symmetric around the mean, light tails, finite variance.</li><li><strong>Caution:</strong> no perfectly additive distributions exist in real data;
all real-world measurements contain some deviations.
Traditional estimators like $\Mean$ and $\StdDev$ lack robustness to outliers;
use them only when strong evidence supports small deviations from additivity with no extreme measurements.</li></ul><h2 id=32-multiplic-lognormal>§3.2. Multiplic (&lsquo;LogNormal&rsquo;)</h2>$$
\Multiplic(\mathrm{logMean}, \mathrm{logStdDev})
$$<ul><li>$\mathrm{logMean}$: mean of log values (location parameter; $e^{\mathrm{logMean}}$ equals the geometric mean)</li><li>$\mathrm{logStdDev}$: standard deviation of log values (scale parameter; controls multiplicative spread)</li></ul><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/distribution-multiplic_light.png target=_blank alt=distribution-multiplic><img class=rounded-lg src=/img/distribution-multiplic_light.png width=800>
</a><a class="img-dark hidden" href=/img/distribution-multiplic_dark.png target=_blank alt=distribution-multiplic><img class=rounded-lg src=/img/distribution-multiplic_dark.png width=800></a></div><ul><li><strong>Formation:</strong> the product of many positive variables $X_1 \cdot X_2 \cdot \ldots \cdot X_n$ with mild conditions (e.g., finite variance of $\log X$).</li><li><strong>Origin:</strong> historically called &lsquo;Log-Normal&rsquo; or &lsquo;Galton&rsquo; distribution after Francis Galton.</li><li><strong>Rename Motivation:</strong> renamed to $\Multiplic$ to reflect its formation mechanism through multiplication.</li><li><strong>Properties:</strong> logarithm of a $\Multiplic$ (&lsquo;LogNormal&rsquo;) variable follows an $\Additive$ (&lsquo;Normal&rsquo;) distribution.</li><li><strong>Applications:</strong> stock prices, file sizes, reaction times, income distributions, biological growth rates.</li><li><strong>Caution:</strong> no perfectly multiplic distributions exist in real data;
all real-world measurements contain some deviations.
Traditional estimators may struggle with the inherent skewness and heavy right tail.</li></ul><h2 id=33-exponential>§3.3. Exponential</h2>$$
\Exp(\mathrm{rate})
$$<ul><li>$\mathrm{rate}$: rate parameter ($\lambda > 0$, controls decay speed; mean = $1/\mathrm{rate}$)</li></ul><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/distribution-exponential_light.png target=_blank alt=distribution-exponential><img class=rounded-lg src=/img/distribution-exponential_light.png width=800>
</a><a class="img-dark hidden" href=/img/distribution-exponential_dark.png target=_blank alt=distribution-exponential><img class=rounded-lg src=/img/distribution-exponential_dark.png width=800></a></div><ul><li><strong>Formation:</strong> the waiting time between events in a Poisson process.</li><li><strong>Origin:</strong> naturally arises from memoryless processes where the probability
of an event occurring is constant over time.</li><li><strong>Properties:</strong> memoryless (past events do not affect future probabilities).</li><li><strong>Applications:</strong> time between failures, waiting times in queues, radioactive decay, customer service times.</li><li><strong>Characteristics:</strong> always positive, right-skewed with a light (exponential) tail.</li><li><strong>Caution:</strong> extreme skewness makes traditional location estimators like $\Mean$ unreliable;
robust estimators provide more stable results.</li></ul><h2 id=34-power-pareto>§3.4. Power (&lsquo;Pareto&rsquo;)</h2>$$
\Power(\mathrm{min}, \mathrm{shape})
$$<ul><li>$\mathrm{min}$: minimum value (lower bound, $\mathrm{min} > 0$)</li><li>$\mathrm{shape}$: shape parameter ($\alpha > 0$, controls tail heaviness; smaller values = heavier tails)</li></ul><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/distribution-power_light.png target=_blank alt=distribution-power><img class=rounded-lg src=/img/distribution-power_light.png width=800>
</a><a class="img-dark hidden" href=/img/distribution-power_dark.png target=_blank alt=distribution-power><img class=rounded-lg src=/img/distribution-power_dark.png width=800></a></div><ul><li><strong>Formation:</strong> follows a power-law relationship where large values are rare but possible.</li><li><strong>Origin:</strong> historically called &lsquo;Pareto&rsquo; distribution after Vilfredo Pareto&rsquo;s work on wealth distribution.</li><li><strong>Rename Motivation:</strong> renamed to $\Power$ to reflect its connection with power-law.</li><li><strong>Properties:</strong> exhibits scale invariance and extremely heavy tails.</li><li><strong>Applications:</strong> wealth distribution, city population sizes, word frequencies, earthquake magnitudes, website traffic.</li><li><strong>Characteristics:</strong> infinite variance for many parameter values; extreme outliers are common.</li><li><strong>Caution:</strong> traditional variance-based estimators completely fail;
robust estimators are essential for reliable analysis.</li></ul><h2 id=35-uniform>§3.5. Uniform</h2>$$
\Uniform(\mathrm{min}, \mathrm{max})
$$<ul><li>$\mathrm{min}$: lower bound of the support interval</li><li>$\mathrm{max}$: upper bound of the support interval ($\mathrm{max} > \mathrm{min}$)</li></ul><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/distribution-uniform_light.png target=_blank alt=distribution-uniform><img class=rounded-lg src=/img/distribution-uniform_light.png width=800>
</a><a class="img-dark hidden" href=/img/distribution-uniform_dark.png target=_blank alt=distribution-uniform><img class=rounded-lg src=/img/distribution-uniform_dark.png width=800></a></div><ul><li><strong>Formation:</strong> all values within a bounded interval have equal probability.</li><li><strong>Origin:</strong> represents complete uncertainty within known bounds.</li><li><strong>Properties:</strong> rectangular probability density, finite support with hard boundaries.</li><li><strong>Applications:</strong> random number generation, round-off errors, arrival times within known intervals.</li><li><strong>Characteristics:</strong> symmetric, bounded, no tail behavior.</li><li><strong>Note:</strong> traditional estimators work reasonably well due to symmetry and bounded nature.</li></ul><h1 id=4-summary-estimator-properties>§4. Summary Estimator Properties</h1><p>This section compares the toolkit&rsquo;s robust estimators against traditional statistical methods
to demonstrate their advantages and universally good properties.
While traditional estimators often work well under ideal conditions,
the toolkit&rsquo;s estimators maintain reliable performance across diverse real-world scenarios.</p><p>Average Estimators:</p><p><strong>Mean</strong> (arithmetic average):</p>$$
\Mean(\x) = \frac{1}{n} \sum_{i=1}^{n} x_i
$$<p><strong>Median</strong>:</p>$$
\Median(\x) = \begin{cases}
x_{((n+1)/2)} & \text{if } n \text{ is odd} \\
\frac{x_{(n/2)} + x_{(n/2+1)}}{2} & \text{if } n \text{ is even}
\end{cases}
$$<p><strong>Center</strong> (Hodges-Lehmann estimator):</p>$$
\Center(\x) = \underset{1 \leq i \leq j \leq n}{\Median} \left(\frac{x_i + x_j}{2} \right)
$$<p>Dispersion Estimators:</p><p><strong>Standard Deviation</strong>:</p>$$
\StdDev(\x) = \sqrt{\frac{1}{n-1} \sum_{i=1}^{n} (x_i - \Mean(\x))^2}
$$<p><strong>Median Absolute Deviation</strong> (around the median):</p>$$
\MAD(\x) = \Median(|x_i - \Median(\x)|)
$$<p><strong>Spread</strong> (Shamos scale estimator):</p>$$
\Spread(\x) = \underset{1 \leq i < j \leq n}{\Median} |x_i - x_j|
$$<h2 id=41-breakdown>§4.1. Breakdown</h2><p>Heavy-tailed distributions naturally produce extreme outliers that completely distort traditional estimators.
A single extreme measurement from the $\Power$ distribution can make the sample mean arbitrarily large.
Real-world data can also contain corrupted measurements from instrument failures, recording errors, or transmission problems.
Both natural extremes and data corruption create the same challenge:
extracting reliable information when some measurements are too influential.</p><p>The breakdown point is the fraction of a sample that can be replaced by arbitrarily large values
without making an estimator arbitrarily large.
The theoretical maximum is $50\%$; no estimator can guarantee reliable results
when more than half the measurements are extreme or corrupted.
In such cases, summary estimators are not applicable, and a more sophisticated approach is needed.</p><p>A $50\%$ breakdown point is rarely needed in practice, as more conservative values also cover practical needs.
Additionally, a high breakdown point corresponds to low precision
(information is lost by neglecting part of the data).
The optimal practical breakdown point should be between
$0\%$ (no robustness) and $50\%$ (low precision).</p><p>The $\Center$ and $\Spread$ estimators achieve $29\%$ breakdown points,
providing substantial protection against realistic contamination levels
while maintaining good precision.
Below is a comparison with traditional estimators.</p><p><strong>Asymptotic breakdown points</strong> for average estimators:</p><table><thead><tr><th>$\Mean$</th><th>$\Median$</th><th>$\Center$</th></tr></thead><tbody><tr><td>0%</td><td>50%</td><td>29%</td></tr></tbody></table><p><strong>Asymptotic breakdown points</strong> for dispersion estimators:</p><table><thead><tr><th>$\StdDev$</th><th>$\MAD$</th><th>$\Spread$</th></tr></thead><tbody><tr><td>0%</td><td>50%</td><td>29%</td></tr></tbody></table><h2 id=42-drift>§4.2. Drift</h2><p>Drift measures estimator precision by quantifying how much estimates scatter across repeated samples.
It is based on the $\Spread$ of estimates and therefore has a breakdown point of approximately $29\%$.</p><p>Drift is useful for comparing the precision of several estimators.
To simplify the comparison, one of the estimators can be chosen as a baseline.
A table of squared drift values, normalized by the baseline, shows the required sample size adjustment factor
for switching from the baseline to another estimator.
For example, if $\Center$ is the baseline and the rescaled drift square of $\Median$ is $1.5$,
this means that $\Median$ requires $1.5$ times more data than $\Center$ to achieve the same precision.
See the &ldquo;From Statistical Efficiency to Drift&rdquo; section for details.</p><p><strong>Squared Asymptotic Drift of Average Estimators</strong> (values are approximated):</p><table><thead><tr><th></th><th>$\Mean$</th><th>$\Median$</th><th>$\Center$</th></tr></thead><tbody><tr><td>$\Additive$</td><td>1.0</td><td>1.571</td><td>1.047</td></tr><tr><td>$\Multiplic$</td><td>3.95</td><td>1.40</td><td>1.7</td></tr><tr><td>$\Exp$</td><td>1.88</td><td>1.88</td><td>1.69</td></tr><tr><td>$\Power$</td><td>$\infty$</td><td>0.9</td><td>2.1</td></tr><tr><td>$\Uniform$</td><td>0.88</td><td>2.60</td><td>0.94</td></tr></tbody></table><p>Rescaled to $\Center$ (sample size adjustment factors):</p><table><thead><tr><th></th><th>$\Mean$</th><th>$\Median$</th><th>$\Center$</th></tr></thead><tbody><tr><td>$\Additive$</td><td>0.96</td><td>1.50</td><td>1.0</td></tr><tr><td>$\Multiplic$</td><td>2.32</td><td>0.82</td><td>1.0</td></tr><tr><td>$\Exp$</td><td>1.11</td><td>1.11</td><td>1.0</td></tr><tr><td>$\Power$</td><td>$\infty$</td><td>0.43</td><td>1.0</td></tr><tr><td>$\Uniform$</td><td>0.936</td><td>2.77</td><td>1.0</td></tr></tbody></table><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/avg-drift-additive_light.png target=_blank alt=avg-drift-additive><img class=rounded-lg src=/img/avg-drift-additive_light.png width=800>
</a><a class="img-dark hidden" href=/img/avg-drift-additive_dark.png target=_blank alt=avg-drift-additive><img class=rounded-lg src=/img/avg-drift-additive_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/avg-drift-multiplic_light.png target=_blank alt=avg-drift-multiplic><img class=rounded-lg src=/img/avg-drift-multiplic_light.png width=800>
</a><a class="img-dark hidden" href=/img/avg-drift-multiplic_dark.png target=_blank alt=avg-drift-multiplic><img class=rounded-lg src=/img/avg-drift-multiplic_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/avg-drift-exp_light.png target=_blank alt=avg-drift-exp><img class=rounded-lg src=/img/avg-drift-exp_light.png width=800>
</a><a class="img-dark hidden" href=/img/avg-drift-exp_dark.png target=_blank alt=avg-drift-exp><img class=rounded-lg src=/img/avg-drift-exp_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/avg-drift-power_light.png target=_blank alt=avg-drift-power><img class=rounded-lg src=/img/avg-drift-power_light.png width=800>
</a><a class="img-dark hidden" href=/img/avg-drift-power_dark.png target=_blank alt=avg-drift-power><img class=rounded-lg src=/img/avg-drift-power_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/avg-drift-uniform_light.png target=_blank alt=avg-drift-uniform><img class=rounded-lg src=/img/avg-drift-uniform_light.png width=800>
</a><a class="img-dark hidden" href=/img/avg-drift-uniform_dark.png target=_blank alt=avg-drift-uniform><img class=rounded-lg src=/img/avg-drift-uniform_dark.png width=800></a></div><hr><p><strong>Squared Asymptotic Drift of Dispersion Estimators</strong> (values are approximated):</p><table><thead><tr><th></th><th>$\StdDev$</th><th>$\MAD$</th><th>$\Spread$</th></tr></thead><tbody><tr><td>$\Additive$</td><td>0.45</td><td>1.22</td><td>0.52</td></tr><tr><td>$\Multiplic$</td><td>$\infty$</td><td>2.26</td><td>1.81</td></tr><tr><td>$\Exp$</td><td>1.69</td><td>1.92</td><td>1.26</td></tr><tr><td>$\Power$</td><td>$\infty$</td><td>3.5</td><td>4.4</td></tr><tr><td>$\Uniform$</td><td>0.18</td><td>0.90</td><td>0.43</td></tr></tbody></table><p>Rescaled to $\Spread$ (sample size adjustment factors):</p><table><thead><tr><th></th><th>$\StdDev$</th><th>$\MAD$</th><th>$\Spread$</th></tr></thead><tbody><tr><td>$\Additive$</td><td>0.87</td><td>2.35</td><td>1.0</td></tr><tr><td>$\Multiplic$</td><td>$\infty$</td><td>1.25</td><td>1.0</td></tr><tr><td>$\Exp$</td><td>1.34</td><td>1.52</td><td>1.0</td></tr><tr><td>$\Power$</td><td>$\infty$</td><td>0.80</td><td>1.0</td></tr><tr><td>$\Uniform$</td><td>0.42</td><td>2.09</td><td>1.0</td></tr></tbody></table><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/disp-drift-additive_light.png target=_blank alt=disp-drift-additive><img class=rounded-lg src=/img/disp-drift-additive_light.png width=800>
</a><a class="img-dark hidden" href=/img/disp-drift-additive_dark.png target=_blank alt=disp-drift-additive><img class=rounded-lg src=/img/disp-drift-additive_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/disp-drift-multiplic_light.png target=_blank alt=disp-drift-multiplic><img class=rounded-lg src=/img/disp-drift-multiplic_light.png width=800>
</a><a class="img-dark hidden" href=/img/disp-drift-multiplic_dark.png target=_blank alt=disp-drift-multiplic><img class=rounded-lg src=/img/disp-drift-multiplic_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/disp-drift-exp_light.png target=_blank alt=disp-drift-exp><img class=rounded-lg src=/img/disp-drift-exp_light.png width=800>
</a><a class="img-dark hidden" href=/img/disp-drift-exp_dark.png target=_blank alt=disp-drift-exp><img class=rounded-lg src=/img/disp-drift-exp_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/disp-drift-power_light.png target=_blank alt=disp-drift-power><img class=rounded-lg src=/img/disp-drift-power_light.png width=800>
</a><a class="img-dark hidden" href=/img/disp-drift-power_dark.png target=_blank alt=disp-drift-power><img class=rounded-lg src=/img/disp-drift-power_dark.png width=800></a></div><div class="flex my-7 justify-center"><a class="img-light hidden" href=/img/disp-drift-uniform_light.png target=_blank alt=disp-drift-uniform><img class=rounded-lg src=/img/disp-drift-uniform_light.png width=800>
</a><a class="img-dark hidden" href=/img/disp-drift-uniform_dark.png target=_blank alt=disp-drift-uniform><img class=rounded-lg src=/img/disp-drift-uniform_dark.png width=800></a></div><h2 id=43-invariance>§4.3. Invariance</h2><p>Invariance properties determine how estimators respond to data transformations.
These properties are crucial for analysis design and interpretation:</p><ul><li><strong>Location-invariant</strong> estimators are invariant to additive shifts: $T(\x+k)=T(\x)$</li><li><strong>Scale-invariant</strong> estimators are invariant to positive rescaling: $T(k \cdot \x)=T(\x)$ for $k>0$</li><li><strong>Equivariant</strong> estimators change predictably with transformations, maintaining relative relationships</li></ul><p>Choosing estimators with appropriate invariance properties ensures that results remain
meaningful across different measurement scales, units, and data transformations.
For example, when comparing datasets collected with different instruments or protocols,
location-invariant estimators eliminate the need for data centering,
while scale-invariant estimators eliminate the need for normalization.</p><p><strong>Location-invariance</strong>: An estimator $T$ is location-invariant if adding a constant to the measurements leaves the result unchanged:</p>$$
T(\x + k) = T(\x)
$$$$
T(\x + k, \y + k) = T(\x, \y)
$$<p><strong>Location-equivariance</strong>: An estimator $T$ is location-equivariant if it shifts with the data:</p>$$
T(\x + k) = T(\x) + k
$$$$
T(\x + k_1, \y + k_2) = T(\x, \y) + f(k_1, k_2)
$$<p><strong>Scale-invariance</strong>: An estimator $T$ is scale-invariant if multiplying by a positive constant leaves the result unchanged:</p>$$
T(k \cdot \x) = T(\x) \quad \text{for } k > 0
$$$$
T(k \cdot \x, k \cdot \y) = T(\x, \y) \quad \text{for } k > 0
$$<p><strong>Scale-equivariance</strong>: An estimator $T$ is scale-equivariant if it scales proportionally with the data:</p>$$
T(k \cdot \x) = k \cdot T(\x) \text{ or } |k| \cdot T(\x) \quad \text{for } k \neq 0
$$$$
T(k \cdot \x, k \cdot \y) = k \cdot T(\x, \y) \text{ or } |k| \cdot T(\x, \y) \quad \text{for } k \neq 0
$$<table><thead><tr><th></th><th>Location</th><th>Scale</th></tr></thead><tbody><tr><td>Center</td><td>Equivariant</td><td>Equivariant</td></tr><tr><td>Spread</td><td>Invariant</td><td>Equivariant</td></tr><tr><td>RelSpread</td><td>–</td><td>Invariant</td></tr><tr><td>Shift</td><td>Invariant</td><td>Equivariant</td></tr><tr><td>Ratio</td><td>–</td><td>Invariant</td></tr><tr><td>AvgSpread</td><td>Invariant</td><td>Equivariant</td></tr><tr><td>Disparity</td><td>Invariant</td><td>Invariant</td></tr></tbody></table><h1 id=5-methodology>§5. Methodology</h1><p>This chapter examines the methodological principles that guide the toolkit&rsquo;s design and application.</p><h2 id=51-desiderata>§5.1. Desiderata</h2><p>The toolkit consists of statistical <em>procedures</em> — practical methods that transform raw measurements into actionable insights and decisions.
When practitioners face real-world problems involving data analysis,
their success depends on selecting the right procedure for each specific situation.
Convenient and efficient procedures have the following <em>essential attributes</em>:</p><ul><li><strong>Usability.</strong>
Procedures should feel natural to practitioners and minimize opportunities for misuse.
They should be mathematically elegant yet accessible to readers with standard mathematical backgrounds.
Implementation should be straightforward across programming languages.
Like well-designed APIs, these procedures should follow intuitive design principles that reduce cognitive load.</li><li><strong>Reliability.</strong>
Procedures should deliver consistent, trustworthy results,
even in the presence of noise, data corruption, and extreme outliers.</li><li><strong>Applicability.</strong>
Procedures should perform well across diverse contexts and sample sizes.
They should handle the full spectrum of distributions commonly encountered in practice,
from ideal theoretical models to data that deviates significantly from any assumed distribution.</li></ul><p>This manual introduces a unified toolkit that aims to satisfy these properties and provide reliable rule-of-thumb procedures for everyday analytical tasks.</p><h2 id=52-from-assumptions-to-conditions>§5.2. From Assumptions to Conditions</h2><p>Traditional statistical practice starts with model assumptions,
then derives optimal procedures under those assumptions.
This approach prioritizes mathematical convenience over practical application.
Practitioners don&rsquo;t know the distribution in advance,
so they lack clear guidance on which procedure to choose by default.</p><p>Most traditional statistical procedures rely heavily on the $\Additive$ (&lsquo;Normal&rsquo;) distribution and fail on real data
because actual measurements contain outliers, exhibit skewness, or follow unknown distributions.
When assumptions fail, procedures designed for those assumptions also fail.</p><p>This toolkit starts with procedures and tests how they perform under different distributional conditions.
This approach reverses the traditional workflow: instead of deriving procedures from assumptions,
we evaluate how each procedure performs across various distributions.
This enables direct comparison and provides clear guidance on procedure selection
based on known characteristics of the data source.</p><p>This procedure-first approach eliminates the need for complex mathematical derivations.
All evaluations can be done numerically through Monte Carlo simulation.
Generate samples from each distribution, apply each procedure, and measure the results.
The numerical evidence directly shows which procedures work best under which conditions.</p><h2 id=53-from-statistical-efficiency-to-drift>§5.3. From Statistical Efficiency to Drift</h2><p>Statistical efficiency measures estimator precision.
When multiple estimators target the same quantity, efficiency determines which provides more reliable results.</p><p>Efficiency measures how tightly estimates cluster around the true value across repeated samples.
For an estimator $T$ applied to samples from distribution $X$,
absolute efficiency is defined relative to the optimal estimator $T^*$:</p>$$
\text{Efficiency}(T, X) = \frac{\text{Var}[T^*(X_1, \ldots, X_n)]}{\text{Var}[T(X_1, \ldots, X_n)]}
$$<p>Relative efficiency compares two estimators by taking the ratio of their variances:</p>$$
\text{RelativeEfficiency}(T_1, T_2, X) = \frac{\text{Var}[T_2(X_1, \ldots, X_n)]}{\text{Var}[T_1(X_1, \ldots, X_n)]}
$$<p>Under $\Additive$ (&lsquo;Normal&rsquo;) distributions, this approach works well.
The sample mean achieves optimal efficiency, while the median operates at roughly 64% efficiency.</p><p>However, this variance-based definition creates four critical limitations:</p><ul><li>Absolute efficiency requires knowing the optimal estimator, which is often difficult to determine.
For many distributions, deriving the minimum-variance unbiased estimator requires complex mathematical analysis.
Without this reference point, absolute efficiency cannot be computed.</li><li>Relative efficiency only compares estimator pairs, preventing systematic evaluation.
This limits understanding of how multiple estimators perform relative to each other.
Practitioners cannot rank estimators comprehensively or evaluate individual performance in isolation.</li><li>The approach depends on variance calculations that break down when variance becomes infinite
or when distributions have heavy tails.
Many real-world distributions, such as those with power-law tails, exhibit infinite variance.
When the variance is undefined, efficiency comparisons become impossible.</li><li>Variance is not robust to outliers, which can corrupt efficiency calculations.
A single extreme observation can greatly inflate variance estimates.
This sensitivity can make efficient estimators look inefficient and vice versa.</li></ul><p>The $\Drift$ concept provides a robust alternative.
Drift measures estimator precision using $\Spread$ instead of variance,
providing reliable comparisons across a wide range of distributions.</p><p>For an average estimator $T$, random variable $X$, and sample size $n$:</p>$$
\AvgDrift(T, X, n) = \frac{\sqrt{n}\,\Spread\big[T(X_1, \ldots, X_n)\big]}{\Spread[X]}
$$<p>This formula measures estimator variability compared to data variability.
$\Spread\big[T(X_1, \ldots, X_n)\big]$ captures the median absolute difference between estimates across repeated samples.
Multiplying by $\sqrt{n}$ removes sample size dependency, making drift values comparable across different sample sizes.
Dividing by $\Spread[X]$ creates a scale-free measure that provides consistent drift values
across different distribution parameters and measurement units.</p><p>Dispersion estimators use a parallel formulation:</p>$$
\DispDrift(T, X, n) = \sqrt{n}\,\RelSpread\big[T(X_1, \ldots, X_n)\big]
$$<p>Here $\RelSpread$ normalizes by the estimator&rsquo;s typical value for fair comparison.</p><p>Drift offers four key advantages:</p><ul><li>For estimators with $\sqrt{n}$ convergence rates, drift remains finite and comparable across distributions; for heavier tails, drift may diverge, flagging estimator instability.</li><li>It provides absolute precision measures rather than only pairwise comparisons.</li><li>The robust $\Spread$ foundation resists outlier distortion that corrupts variance-based calculations.</li><li>The $\sqrt{n}$ normalization makes drift values comparable across different sample sizes,
enabling direct comparison of estimator performance regardless of sample size.</li></ul><p>Under $\Additive$ (&lsquo;Normal&rsquo;) conditions, drift matches traditional efficiency.
The sample mean achieves drift near 1.0; the median achieves drift around 1.25.
This consistency validates drift as a proper generalization of efficiency
that extends to realistic data conditions where traditional efficiency fails.</p><p>When switching from one estimator to another while maintaining the same precision,
the required sample size adjustment follows:</p>$$
n_{\text{new}} = n_{\text{original}} \cdot \frac{\Drift^2(T_2, X)}{\Drift^2(T_1, X)}
$$<p>This applies when estimator $T_1$ has lower drift than $T_2$.</p><p>The ratio of squared drifts determines the data requirement change.
If $T_2$ has drift 1.5 times higher than $T_1$, then $T_2$ requires $(1.5)^2 = 2.25$ times more data
to match $T_1$&rsquo;s precision.
Conversely, switching to a more precise estimator allows smaller sample sizes.</p><p>For asymptotic analysis, $\Drift(T, X)$ denotes the limiting value as $n \to \infty$.
With a baseline estimator, rescaled drift values enable direct comparisons:</p>$$
\Drift_{\textrm{baseline}}(T, X) = \frac{\Drift(T, X)}{\Drift\big(T_{\textrm{baseline}}, X\big)}
$$<p>The standard drift definition assumes $\sqrt{n}$ convergence rates typical under $\Additive$ (&lsquo;Normal&rsquo;) conditions.
For broader applicability, drift generalizes to:</p>$$
\AvgDrift(T, X, n) = \frac{n^{\textrm{instability}}\,\Spread\big[T(X_1, \ldots, X_n)\big]}{\Spread[X]}
$$$$
\DispDrift(T, X, n) = n^{\textrm{instability}}\,\RelSpread\big[T(X_1, \ldots, X_n)\big]
$$<p>The instability parameter adapts to estimator convergence rates.
The toolkit uses $\textrm{instability} = 1/2$ throughout because this choice provides natural intuition
and mental representation for the $\Additive$ (&lsquo;Normal&rsquo;) distribution.
Rather than introduce additional complexity through variable instability parameters,
the fixed $\sqrt{n}$ scaling offers practical convenience while maintaining theoretical rigor
for the distribution classes most common in applications.</p><h1 id=6-algorithms>§6. Algorithms</h1><p>This chapter describes the core algorithms that power the robust estimators in the toolkit.
Both algorithms solve a fundamental computational challenge: how to efficiently find medians within large collections
of derived values without materializing the entire collection in memory.</p><h2 id=61-fast-center>§6.1. Fast Center</h2><p>The $\Center$ estimator computes the median of all pairwise averages from a sample.
Given a dataset $x = (x_1, x_2, \ldots, x_n)$, this estimator is defined as:</p>$$
\Center(\x) = \underset{1 \leq i \leq j \leq n}{\Median} \left(\frac{x_i + x_j}{2} \right)
$$<p>A direct implementation would generate all $\frac{n(n+1)}{2}$ pairwise averages and sort them.
With $n = 10,000$, this approach creates approximately 50 million values, requiring quadratic memory and $O(n^2 \log n)$ time.</p><p>The breakthrough came in 1984 when John Monahan developed an algorithm that reduces expected complexity
to $O(n \log n)$ while using only linear memory (see <a href=https://pragmastat.dev/references/monahan1984/>monahan1984</a>).
The algorithm exploits the inherent structure in pairwise sums rather than computing them explicitly.
After sorting the values $x_1 \leq x_2 \leq \cdots \leq x_n$,
the algorithm considers the implicit upper triangular matrix $M$ where $M_{i,j} = x_i + x_j$ for $i \leq j$.
This matrix has a crucial property: each row and column is sorted in non-decreasing order,
enabling efficient median selection without storing the matrix.</p><p>Rather than sorting all pairwise sums, the algorithm uses a selection approach similar to quickselect.
It maintains search bounds for each matrix row and iteratively narrows the search space.
For each row $i$, the algorithm tracks active column indices from $i+1$ to $n$,
defining which pairwise sums remain candidates for the median.
It selects a candidate sum as a pivot using randomized selection from active matrix elements,
then counts how many pairwise sums fall below the pivot.
Because both rows and columns are sorted, this counting takes only $O(n)$ time
using a two-pointer sweep from the matrix&rsquo;s upper-right corner.</p><p>The median corresponds to rank $k = \lfloor \frac{N+1}{2} \rfloor$ where $N = \frac{n(n+1)}{2}$.
If fewer than $k$ sums lie below the pivot, the median must be larger;
if more than $k$ sums lie below the pivot, the median must be smaller.
Based on this comparison, the algorithm eliminates portions of each row that cannot contain the median,
shrinking the active search space while preserving the true median.</p><p>Real data often contain repeated values, which can cause the selection process to stall.
When the algorithm detects no progress between iterations, it switches to a midrange strategy:
find the smallest and largest pairwise sums still in the search space,
then use their average as the next pivot.
If the minimum equals the maximum, all remaining candidates are identical and the algorithm terminates.
This tie-breaking mechanism ensures reliable convergence with discrete or duplicated data.</p><p>The algorithm achieves $O(n \log n)$ time complexity through linear partitioning
(each pivot evaluation requires only $O(n)$ operations) and logarithmic iterations
(randomized pivot selection leads to expected $O(\log n)$ iterations, similar to quickselect).
The algorithm maintains only row bounds and counters, using $O(n)$ additional space.
This matches the complexity of sorting a single array while avoiding the quadratic memory and time explosion
of computing all pairwise combinations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>Pragmastat.Algorithms</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>internal</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>FastCenter</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// ACM Algorithm 616: fast computation of the Hodges-Lehmann location estimator</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;remarks&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// Computes the median of all pairwise averages (xi + xj)/2 efficiently.</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// See: John F Monahan, &#34;Algorithm 616: fast computation of the Hodges-Lehmann location estimator&#34;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// (1984) DOI: 10.1145/1271.319414</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;/remarks&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;param name=&#34;values&#34;&gt;A sorted sample of values&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;param name=&#34;random&#34;&gt;Random number generator&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;param name=&#34;isSorted&#34;&gt;If values are sorted&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;returns&gt;Exact center value (Hodges-Lehmann estimator)&lt;/returns&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>Estimate</span><span class=p>(</span><span class=n>IReadOnlyList</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>values</span><span class=p>,</span> <span class=n>Random</span><span class=p>?</span> <span class=n>random</span> <span class=p>=</span> <span class=kc>null</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>isSorted</span> <span class=p>=</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=n>values</span><span class=p>.</span><span class=n>Count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=p>==</span> <span class=m>1</span><span class=p>)</span> <span class=k>return</span> <span class=n>values</span><span class=p>[</span><span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=p>==</span> <span class=m>2</span><span class=p>)</span> <span class=k>return</span> <span class=p>(</span><span class=n>values</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>+</span> <span class=n>values</span><span class=p>[</span><span class=m>1</span><span class=p>])</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>random</span> <span class=p>??=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!</span><span class=n>isSorted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>values</span> <span class=p>=</span> <span class=n>values</span><span class=p>.</span><span class=n>OrderBy</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>).</span><span class=n>ToList</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Calculate target median rank(s) among all pairwise sums</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>totalPairs</span> <span class=p>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>n</span> <span class=p>*</span> <span class=p>(</span><span class=n>n</span> <span class=p>+</span> <span class=m>1</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>medianRankLow</span> <span class=p>=</span> <span class=p>(</span><span class=n>totalPairs</span> <span class=p>+</span> <span class=m>1</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span> <span class=c1>// For odd totalPairs, this is the median</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>medianRankHigh</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=n>totalPairs</span> <span class=p>+</span> <span class=m>2</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span> <span class=c1>// For even totalPairs, average of ranks medianRankLow and medianRankHigh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Initialize search bounds for each row in the implicit matrix</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span><span class=p>[]</span> <span class=n>leftBounds</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>long</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span><span class=p>[]</span> <span class=n>rightBounds</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>long</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span><span class=p>[]</span> <span class=n>partitionCounts</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>long</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span> <span class=c1>// Row i can pair with columns [i+1..n] (1-based indexing)</span>
</span></span><span class=line><span class=cl>      <span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>n</span><span class=p>;</span> <span class=c1>// Initially, all columns are available</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Start with a good pivot: sum of middle elements (handles both odd and even n)</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>pivot</span> <span class=p>=</span> <span class=n>values</span><span class=p>[(</span><span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>]</span> <span class=p>+</span> <span class=n>values</span><span class=p>[</span><span class=n>n</span> <span class=p>/</span> <span class=m>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>activeSetSize</span> <span class=p>=</span> <span class=n>totalPairs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>previousCount</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// === PARTITION STEP ===</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Count pairwise sums less than current pivot</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>countBelowPivot</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>currentColumn</span> <span class=p>=</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>row</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>row</span> <span class=p>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>row</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>partitionCounts</span><span class=p>[</span><span class=n>row</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Move left from current column until we find sums &lt; pivot</span>
</span></span><span class=line><span class=cl>        <span class=c1>// This exploits the sorted nature of the matrix</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>currentColumn</span> <span class=p>&gt;=</span> <span class=n>row</span> <span class=p>&amp;&amp;</span> <span class=n>values</span><span class=p>[</span><span class=n>row</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>currentColumn</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>&gt;=</span> <span class=n>pivot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>currentColumn</span><span class=p>--;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Count elements in this row that are &lt; pivot</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>currentColumn</span> <span class=p>&gt;=</span> <span class=n>row</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>long</span> <span class=n>elementsBelow</span> <span class=p>=</span> <span class=n>currentColumn</span> <span class=p>-</span> <span class=n>row</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>partitionCounts</span><span class=p>[</span><span class=n>row</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>elementsBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>countBelowPivot</span> <span class=p>+=</span> <span class=n>elementsBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === CONVERGENCE CHECK ===</span>
</span></span><span class=line><span class=cl>      <span class=c1>// If no progress, we have ties - break them using midrange strategy</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>countBelowPivot</span> <span class=p>==</span> <span class=n>previousCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>minActiveSum</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>MaxValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>maxActiveSum</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>MinValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Find the range of sums still in the active search space</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=k>continue</span><span class=p>;</span> <span class=c1>// Skip empty rows</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>rowValue</span> <span class=p>=</span> <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>smallestInRow</span> <span class=p>=</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>rowValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>largestInRow</span> <span class=p>=</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>rowValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=n>minActiveSum</span> <span class=p>=</span> <span class=n>Min</span><span class=p>(</span><span class=n>minActiveSum</span><span class=p>,</span> <span class=n>smallestInRow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>maxActiveSum</span> <span class=p>=</span> <span class=n>Max</span><span class=p>(</span><span class=n>maxActiveSum</span><span class=p>,</span> <span class=n>largestInRow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pivot</span> <span class=p>=</span> <span class=p>(</span><span class=n>minActiveSum</span> <span class=p>+</span> <span class=n>maxActiveSum</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pivot</span> <span class=p>&lt;=</span> <span class=n>minActiveSum</span> <span class=p>||</span> <span class=n>pivot</span> <span class=p>&gt;</span> <span class=n>maxActiveSum</span><span class=p>)</span> <span class=n>pivot</span> <span class=p>=</span> <span class=n>maxActiveSum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// If all remaining values are identical, we&#39;re done</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>minActiveSum</span> <span class=p>==</span> <span class=n>maxActiveSum</span> <span class=p>||</span> <span class=n>activeSetSize</span> <span class=p>&lt;=</span> <span class=m>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>pivot</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === TARGET CHECK ===</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Check if we&#39;ve found the median rank(s)</span>
</span></span><span class=line><span class=cl>      <span class=kt>bool</span> <span class=n>atTargetRank</span> <span class=p>=</span> <span class=n>countBelowPivot</span> <span class=p>==</span> <span class=n>medianRankLow</span> <span class=p>||</span> <span class=n>countBelowPivot</span> <span class=p>==</span> <span class=n>medianRankHigh</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>atTargetRank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find the boundary values: largest &lt; pivot and smallest &gt;= pivot</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>largestBelowPivot</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>MinValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>smallestAtOrAbovePivot</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>MaxValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>long</span> <span class=n>countInRow</span> <span class=p>=</span> <span class=n>partitionCounts</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>rowValue</span> <span class=p>=</span> <span class=n>values</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=kt>long</span> <span class=n>totalInRow</span> <span class=p>=</span> <span class=n>n</span> <span class=p>-</span> <span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1>// Find largest sum in this row that&#39;s &lt; pivot</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>countInRow</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>lastBelowIndex</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=n>countInRow</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>lastBelowValue</span> <span class=p>=</span> <span class=n>rowValue</span> <span class=p>+</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>lastBelowIndex</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>largestBelowPivot</span> <span class=p>=</span> <span class=n>Max</span><span class=p>(</span><span class=n>largestBelowPivot</span><span class=p>,</span> <span class=n>lastBelowValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1>// Find smallest sum in this row that&#39;s &gt;= pivot</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>countInRow</span> <span class=p>&lt;</span> <span class=n>totalInRow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>long</span> <span class=n>firstAtOrAboveIndex</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=n>countInRow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>firstAtOrAboveValue</span> <span class=p>=</span> <span class=n>rowValue</span> <span class=p>+</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>firstAtOrAboveIndex</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>smallestAtOrAbovePivot</span> <span class=p>=</span> <span class=n>Min</span><span class=p>(</span><span class=n>smallestAtOrAbovePivot</span><span class=p>,</span> <span class=n>firstAtOrAboveValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Calculate final result based on whether we have odd or even number of pairs</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>medianRankLow</span> <span class=p>&lt;</span> <span class=n>medianRankHigh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Even total: average the two middle values</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=p>(</span><span class=n>smallestAtOrAbovePivot</span> <span class=p>+</span> <span class=n>largestBelowPivot</span><span class=p>)</span> <span class=p>/</span> <span class=m>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Odd total: return the single middle value</span>
</span></span><span class=line><span class=cl>          <span class=kt>bool</span> <span class=n>needLargest</span> <span class=p>=</span> <span class=n>countBelowPivot</span> <span class=p>==</span> <span class=n>medianRankLow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=p>(</span><span class=n>needLargest</span> <span class=p>?</span> <span class=n>largestBelowPivot</span> <span class=p>:</span> <span class=n>smallestAtOrAbovePivot</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === UPDATE BOUNDS ===</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Narrow the search space based on partition result</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>countBelowPivot</span> <span class=p>&lt;</span> <span class=n>medianRankLow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Too few values below pivot - eliminate smaller values, search higher</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>          <span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=n>partitionCounts</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Too many values below pivot - eliminate larger values, search lower</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>          <span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=n>partitionCounts</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === PREPARE NEXT ITERATION ===</span>
</span></span><span class=line><span class=cl>      <span class=n>previousCount</span> <span class=p>=</span> <span class=n>countBelowPivot</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Recalculate how many elements remain in the active search space</span>
</span></span><span class=line><span class=cl>      <span class=n>activeSetSize</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>rowSize</span> <span class=p>=</span> <span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>activeSetSize</span> <span class=p>+=</span> <span class=n>Max</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>rowSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Choose next pivot based on remaining active set size</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>activeSetSize</span> <span class=p>&gt;</span> <span class=m>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Use randomized row median strategy for efficiency</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Handle large activeSetSize by using double precision for random selection</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>randomFraction</span> <span class=p>=</span> <span class=n>random</span><span class=p>.</span><span class=n>NextDouble</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>targetIndex</span> <span class=p>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>randomFraction</span> <span class=p>*</span> <span class=n>activeSetSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>selectedRow</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Find which row contains the target index</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>cumulativeSize</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>long</span> <span class=n>rowSize</span> <span class=p>=</span> <span class=n>Max</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>targetIndex</span> <span class=p>&lt;</span> <span class=n>cumulativeSize</span> <span class=p>+</span> <span class=n>rowSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>selectedRow</span> <span class=p>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=n>cumulativeSize</span> <span class=p>+=</span> <span class=n>rowSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Use median element of the selected row as pivot</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>medianColumnInRow</span> <span class=p>=</span> <span class=p>(</span><span class=n>leftBounds</span><span class=p>[</span><span class=n>selectedRow</span><span class=p>]</span> <span class=p>+</span> <span class=n>rightBounds</span><span class=p>[</span><span class=n>selectedRow</span><span class=p>])</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot</span> <span class=p>=</span> <span class=n>values</span><span class=p>[</span><span class=n>selectedRow</span><span class=p>]</span> <span class=p>+</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>medianColumnInRow</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Few elements remain - use midrange strategy</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>minRemainingSum</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>MaxValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>maxRemainingSum</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>MinValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=k>continue</span><span class=p>;</span> <span class=c1>// Skip empty rows</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>rowValue</span> <span class=p>=</span> <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>minInRow</span> <span class=p>=</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>leftBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>rowValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>maxInRow</span> <span class=p>=</span> <span class=n>values</span><span class=p>[(</span><span class=kt>int</span><span class=p>)</span><span class=n>rightBounds</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>rowValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=n>minRemainingSum</span> <span class=p>=</span> <span class=n>Min</span><span class=p>(</span><span class=n>minRemainingSum</span><span class=p>,</span> <span class=n>minInRow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>maxRemainingSum</span> <span class=p>=</span> <span class=n>Max</span><span class=p>(</span><span class=n>maxRemainingSum</span><span class=p>,</span> <span class=n>maxInRow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pivot</span> <span class=p>=</span> <span class=p>(</span><span class=n>minRemainingSum</span> <span class=p>+</span> <span class=n>maxRemainingSum</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pivot</span> <span class=p>&lt;=</span> <span class=n>minRemainingSum</span> <span class=p>||</span> <span class=n>pivot</span> <span class=p>&gt;</span> <span class=n>maxRemainingSum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>pivot</span> <span class=p>=</span> <span class=n>maxRemainingSum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>minRemainingSum</span> <span class=p>==</span> <span class=n>maxRemainingSum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>pivot</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=62-fast-spread>§6.2. Fast Spread</h2><p>The $\Spread$ estimator computes the median of all pairwise absolute differences.
Given a sample $x = (x_1, x_2, \ldots, x_n)$, this estimator is defined as:</p>$$
\Spread(\x) = \underset{1 \leq i < j \leq n}{\Median} |x_i - x_j|
$$<p>Like $\Center$, computing $\Spread$ naively requires generating
all $\frac{n(n-1)}{2}$ pairwise differences, sorting them, and finding the median —
a quadratic approach that becomes computationally prohibitive for large datasets.</p><p>The same structural principles that accelerate $\Center$ computation also apply to pairwise differences,
yielding an exact $O(n \log n)$ algorithm.
After sorting the input to obtain $y_1 \leq y_2 \leq \cdots \leq y_n$,
all pairwise absolute differences $|x_i - x_j|$ with $i < j$ become positive differences $y_j - y_i$.
This allows considering the implicit upper triangular matrix $D$ where $D_{i,j} = y_j - y_i$ for $i < j$.
This matrix has a crucial structural property: for a fixed row $i$, differences increase monotonically,
while for a fixed column $j$, differences decrease as $i$ increases.
This sorted structure enables linear-time counting of elements below any threshold.</p><p>The algorithm applies Monahan&rsquo;s selection strategy, adapted for differences rather than sums.
For each row $i$, it tracks active column indices representing differences still under consideration,
initially spanning columns $i+1$ through $n$.
It chooses candidate differences from the active set using weighted random row selection,
maintaining expected logarithmic convergence while avoiding expensive pivot computations.
For any pivot value $p$, the number of differences falling below $p$ is counted using a single sweep;
the monotonic structure ensures this counting requires only $O(n)$ operations.
While counting, the largest difference below $p$ and the smallest difference at or above $p$ are maintained—
these boundary values become the exact answer when the target rank is reached.</p><p>The algorithm naturally handles both odd and even cases.
For an odd number of differences, it returns the single middle element when the count exactly hits the median rank.
For an even number of differences, it returns the average of the two middle elements;
boundary tracking during counting provides both values simultaneously.
Unlike approximation methods, this algorithm returns the precise median of all pairwise differences;
randomness affects only performance, not correctness.</p><p>The algorithm includes the same stall-handling mechanisms as the center algorithm.
It tracks whether the count below the pivot changes between iterations;
when progress stalls due to tied values, it computes the range of remaining active differences
and pivots to their midrange.
This midrange strategy ensures convergence even with highly discrete data or datasets with many identical values.</p><p>Several optimizations make the implementation practical for production use.
A global column pointer that never moves backward during counting exploits the matrix structure
to avoid redundant comparisons.
Exact boundary values are captured during each counting pass,
eliminating the need for additional searches when the target rank is reached.
Using only $O(n)$ additional space for row bounds and counters,
the algorithm achieves $O(n \log n)$ time complexity with minimal memory overhead,
making robust scale estimation practical for large datasets.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>Pragmastat.Algorithms</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>internal</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>FastSpread</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// Shamos &#34;Spread&#34;.  Expected O(n log n) time, O(n) extra space. Exact.</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>Estimate</span><span class=p>(</span><span class=n>IReadOnlyList</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>values</span><span class=p>,</span> <span class=n>Random</span><span class=p>?</span> <span class=n>random</span> <span class=p>=</span> <span class=kc>null</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>isSorted</span> <span class=p>=</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=n>values</span><span class=p>.</span><span class=n>Count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=p>&lt;=</span> <span class=m>1</span><span class=p>)</span> <span class=k>return</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=p>==</span> <span class=m>2</span><span class=p>)</span> <span class=k>return</span> <span class=n>Abs</span><span class=p>(</span><span class=n>values</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>values</span><span class=p>[</span><span class=m>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>random</span> <span class=p>??=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Prepare a sorted working copy.</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span><span class=p>[]</span> <span class=n>a</span> <span class=p>=</span> <span class=n>isSorted</span> <span class=p>?</span> <span class=n>CopySorted</span><span class=p>(</span><span class=n>values</span><span class=p>)</span> <span class=p>:</span> <span class=n>EnsureSorted</span><span class=p>(</span><span class=n>values</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Total number of pairwise differences with i &lt; j</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>N</span> <span class=p>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>n</span> <span class=p>*</span> <span class=p>(</span><span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>kLow</span> <span class=p>=</span> <span class=p>(</span><span class=n>N</span> <span class=p>+</span> <span class=m>1</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span> <span class=c1>// 1-based rank of lower middle</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>kHigh</span> <span class=p>=</span> <span class=p>(</span><span class=n>N</span> <span class=p>+</span> <span class=m>2</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span> <span class=c1>// 1-based rank of upper middle</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Per-row active bounds over columns j (0-based indices).</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Row i allows j in [i+1, n-1] initially.</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span><span class=p>[]</span> <span class=n>L</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span><span class=p>[]</span> <span class=n>R</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span><span class=p>[]</span> <span class=n>rowCounts</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>long</span><span class=p>[</span><span class=n>n</span><span class=p>];</span> <span class=c1>// # of elements in row i that are &lt; pivot (for current partition)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>Min</span><span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span> <span class=c1>// n means empty</span>
</span></span><span class=line><span class=cl>      <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=c1>// inclusive</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=c1>// mark empty</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// A reasonable initial pivot: a central gap</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>pivot</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>n</span> <span class=p>/</span> <span class=m>2</span><span class=p>]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[(</span><span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>prevCountBelow</span> <span class=p>=</span> <span class=p>-</span><span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// === PARTITION: count how many differences are &lt; pivot; also track boundary neighbors ===</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>countBelow</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>largestBelow</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>NegativeInfinity</span><span class=p>;</span> <span class=c1>// max difference &lt; pivot</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>smallestAtOrAbove</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>PositiveInfinity</span><span class=p>;</span> <span class=c1>// min difference &gt;= pivot</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=c1>// global two-pointer (non-decreasing across rows)</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>&lt;</span> <span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>)</span> <span class=n>j</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>j</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>&amp;&amp;</span> <span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;</span> <span class=n>pivot</span><span class=p>)</span> <span class=n>j</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>cntRow</span> <span class=p>=</span> <span class=n>j</span> <span class=p>-</span> <span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>cntRow</span> <span class=p>&lt;</span> <span class=m>0</span><span class=p>)</span> <span class=n>cntRow</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>rowCounts</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>cntRow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>countBelow</span> <span class=p>+=</span> <span class=n>cntRow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// boundary elements for this row</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>cntRow</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// last &lt; pivot in this row is (j-1)</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>candBelow</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>j</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>candBelow</span> <span class=p>&gt;</span> <span class=n>largestBelow</span><span class=p>)</span> <span class=n>largestBelow</span> <span class=p>=</span> <span class=n>candBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>candAtOrAbove</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>candAtOrAbove</span> <span class=p>&lt;</span> <span class=n>smallestAtOrAbove</span><span class=p>)</span> <span class=n>smallestAtOrAbove</span> <span class=p>=</span> <span class=n>candAtOrAbove</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === TARGET CHECK ===</span>
</span></span><span class=line><span class=cl>      <span class=c1>// If we&#39;ve split exactly at the middle, we can return using the boundaries we just found.</span>
</span></span><span class=line><span class=cl>      <span class=kt>bool</span> <span class=n>atTarget</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>countBelow</span> <span class=p>==</span> <span class=n>kLow</span><span class=p>)</span> <span class=p>||</span> <span class=c1>// lower middle is the largest &lt; pivot</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>countBelow</span> <span class=p>==</span> <span class=p>(</span><span class=n>kHigh</span> <span class=p>-</span> <span class=m>1</span><span class=p>));</span> <span class=c1>// upper middle is the smallest &gt;= pivot</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>atTarget</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>kLow</span> <span class=p>&lt;</span> <span class=n>kHigh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Even N: average the two central order stats.</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=m>0.5</span> <span class=p>*</span> <span class=p>(</span><span class=n>largestBelow</span> <span class=p>+</span> <span class=n>smallestAtOrAbove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Odd N: pick the single middle depending on which side we hit.</span>
</span></span><span class=line><span class=cl>          <span class=kt>bool</span> <span class=n>needLargest</span> <span class=p>=</span> <span class=p>(</span><span class=n>countBelow</span> <span class=p>==</span> <span class=n>kLow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>needLargest</span> <span class=p>?</span> <span class=n>largestBelow</span> <span class=p>:</span> <span class=n>smallestAtOrAbove</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === STALL HANDLING (ties / no progress) ===</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>countBelow</span> <span class=p>==</span> <span class=n>prevCountBelow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute min/max remaining difference in the ACTIVE set and pivot to their midrange.</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>minActive</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>PositiveInfinity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>maxActive</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>NegativeInfinity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>active</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>int</span> <span class=n>Li</span> <span class=p>=</span> <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>Ri</span> <span class=p>=</span> <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>Li</span> <span class=p>&gt;</span> <span class=n>Ri</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>rowMin</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>Li</span><span class=p>]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>rowMax</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>Ri</span><span class=p>]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>rowMin</span> <span class=p>&lt;</span> <span class=n>minActive</span><span class=p>)</span> <span class=n>minActive</span> <span class=p>=</span> <span class=n>rowMin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>rowMax</span> <span class=p>&gt;</span> <span class=n>maxActive</span><span class=p>)</span> <span class=n>maxActive</span> <span class=p>=</span> <span class=n>rowMax</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>active</span> <span class=p>+=</span> <span class=p>(</span><span class=n>Ri</span> <span class=p>-</span> <span class=n>Li</span> <span class=p>+</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=p>&lt;=</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// No active candidates left: the only consistent answer is the boundary implied by counts.</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Fall back to neighbors from this partition.</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>kLow</span> <span class=p>&lt;</span> <span class=n>kHigh</span><span class=p>)</span> <span class=k>return</span> <span class=m>0.5</span> <span class=p>*</span> <span class=p>(</span><span class=n>largestBelow</span> <span class=p>+</span> <span class=n>smallestAtOrAbove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=p>(</span><span class=n>countBelow</span> <span class=p>&gt;=</span> <span class=n>kLow</span><span class=p>)</span> <span class=p>?</span> <span class=n>largestBelow</span> <span class=p>:</span> <span class=n>smallestAtOrAbove</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>maxActive</span> <span class=p>&lt;=</span> <span class=n>minActive</span><span class=p>)</span> <span class=k>return</span> <span class=n>minActive</span><span class=p>;</span> <span class=c1>// all remaining equal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>mid</span> <span class=p>=</span> <span class=m>0.5</span> <span class=p>*</span> <span class=p>(</span><span class=n>minActive</span> <span class=p>+</span> <span class=n>maxActive</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot</span> <span class=p>=</span> <span class=p>(</span><span class=n>mid</span> <span class=p>&gt;</span> <span class=n>minActive</span> <span class=p>&amp;&amp;</span> <span class=n>mid</span> <span class=p>&lt;=</span> <span class=n>maxActive</span><span class=p>)</span> <span class=p>?</span> <span class=n>mid</span> <span class=p>:</span> <span class=n>maxActive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>prevCountBelow</span> <span class=p>=</span> <span class=n>countBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === SHRINK ACTIVE WINDOW ===</span>
</span></span><span class=line><span class=cl><span class=c1>// --- SHRINK ACTIVE WINDOW (fixed) ---</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>countBelow</span> <span class=p>&lt;</span> <span class=n>kLow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Need larger differences: discard all strictly below pivot.</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// First j with a[j] - a[i] &gt;= pivot is j = i + 1 + cntRow (may be n =&gt; empty row)</span>
</span></span><span class=line><span class=cl>          <span class=kt>int</span> <span class=n>newL</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=m>1</span> <span class=p>+</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>rowCounts</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>newL</span> <span class=p>&gt;</span> <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>newL</span><span class=p>;</span> <span class=c1>// do NOT clamp; allow L[i] == n to mean empty</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=c1>// mark empty</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Too many below: keep only those strictly below pivot.</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Last j with a[j] - a[i] &lt; pivot is j = i + cntRow  (not cntRow-1!)</span>
</span></span><span class=line><span class=cl>          <span class=kt>int</span> <span class=n>newR</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>rowCounts</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>newR</span> <span class=p>&lt;</span> <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>newR</span><span class=p>;</span> <span class=c1>// shrink downward to the true last-below</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;</span> <span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=c1>// empty row if none remain</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>prevCountBelow</span> <span class=p>=</span> <span class=n>countBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// === CHOOSE NEXT PIVOT FROM ACTIVE SET (weighted random row, then row median) ===</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>activeSize</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;=</span> <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=n>activeSize</span> <span class=p>+=</span> <span class=p>(</span><span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>activeSize</span> <span class=p>&lt;=</span> <span class=m>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Few candidates left: return midrange of remaining exactly.</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>minRem</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>PositiveInfinity</span><span class=p>,</span> <span class=n>maxRem</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>NegativeInfinity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>lo</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>L</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=kt>double</span> <span class=n>hi</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>lo</span> <span class=p>&lt;</span> <span class=n>minRem</span><span class=p>)</span> <span class=n>minRem</span> <span class=p>=</span> <span class=n>lo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>hi</span> <span class=p>&gt;</span> <span class=n>maxRem</span><span class=p>)</span> <span class=n>maxRem</span> <span class=p>=</span> <span class=n>hi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>activeSize</span> <span class=p>&lt;=</span> <span class=m>0</span><span class=p>)</span> <span class=c1>// safety net; fall back to boundary from last partition</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>kLow</span> <span class=p>&lt;</span> <span class=n>kHigh</span><span class=p>)</span> <span class=k>return</span> <span class=m>0.5</span> <span class=p>*</span> <span class=p>(</span><span class=n>largestBelow</span> <span class=p>+</span> <span class=n>smallestAtOrAbove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=p>(</span><span class=n>countBelow</span> <span class=p>&gt;=</span> <span class=n>kLow</span><span class=p>)</span> <span class=p>?</span> <span class=n>largestBelow</span> <span class=p>:</span> <span class=n>smallestAtOrAbove</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>kLow</span> <span class=p>&lt;</span> <span class=n>kHigh</span><span class=p>)</span> <span class=k>return</span> <span class=m>0.5</span> <span class=p>*</span> <span class=p>(</span><span class=n>minRem</span> <span class=p>+</span> <span class=n>maxRem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>Abs</span><span class=p>((</span><span class=n>kLow</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>-</span> <span class=n>countBelow</span><span class=p>)</span> <span class=p>&lt;=</span> <span class=n>Abs</span><span class=p>(</span><span class=n>countBelow</span> <span class=p>-</span> <span class=n>kLow</span><span class=p>))</span> <span class=p>?</span> <span class=n>minRem</span> <span class=p>:</span> <span class=n>maxRem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>t</span> <span class=p>=</span> <span class=n>NextIndex</span><span class=p>(</span><span class=n>random</span><span class=p>,</span> <span class=n>activeSize</span><span class=p>);</span> <span class=c1>// 0..activeSize-1</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>acc</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>row</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(;</span> <span class=n>row</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>row</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>L</span><span class=p>[</span><span class=n>row</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>R</span><span class=p>[</span><span class=n>row</span><span class=p>])</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=kt>long</span> <span class=n>size</span> <span class=p>=</span> <span class=n>R</span><span class=p>[</span><span class=n>row</span><span class=p>]</span> <span class=p>-</span> <span class=n>L</span><span class=p>[</span><span class=n>row</span><span class=p>]</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>t</span> <span class=p>&lt;</span> <span class=n>acc</span> <span class=p>+</span> <span class=n>size</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>acc</span> <span class=p>+=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Median column of the selected row</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>col</span> <span class=p>=</span> <span class=p>(</span><span class=n>L</span><span class=p>[</span><span class=n>row</span><span class=p>]</span> <span class=p>+</span> <span class=n>R</span><span class=p>[</span><span class=n>row</span><span class=p>])</span> <span class=p>&gt;&gt;</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot</span> <span class=p>=</span> <span class=n>a</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=p>-</span> <span class=n>a</span><span class=p>[</span><span class=n>row</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// --- Helpers ---</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>CopySorted</span><span class=p>(</span><span class=n>IReadOnlyList</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>a</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=n>values</span><span class=p>.</span><span class=n>Count</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>a</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>v</span> <span class=p>=</span> <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=kt>double</span><span class=p>.</span><span class=n>IsNaN</span><span class=p>(</span><span class=n>v</span><span class=p>))</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentException</span><span class=p>(</span><span class=s>&#34;NaN not allowed.&#34;</span><span class=p>,</span> <span class=n>nameof</span><span class=p>(</span><span class=n>values</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Array</span><span class=p>.</span><span class=n>Sort</span><span class=p>(</span><span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>EnsureSorted</span><span class=p>(</span><span class=n>IReadOnlyList</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Trust caller; still copy to array for fast indexed access.</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>a</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=n>values</span><span class=p>.</span><span class=n>Count</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>a</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>v</span> <span class=p>=</span> <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=kt>double</span><span class=p>.</span><span class=n>IsNaN</span><span class=p>(</span><span class=n>v</span><span class=p>))</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentException</span><span class=p>(</span><span class=s>&#34;NaN not allowed.&#34;</span><span class=p>,</span> <span class=n>nameof</span><span class=p>(</span><span class=n>values</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kt>long</span> <span class=n>NextIndex</span><span class=p>(</span><span class=n>Random</span> <span class=n>rng</span><span class=p>,</span> <span class=kt>long</span> <span class=n>limitExclusive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Uniform 0..limitExclusive-1 even for large ranges.</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Use rejection sampling for correctness.</span>
</span></span><span class=line><span class=cl>    <span class=kt>ulong</span> <span class=n>uLimit</span> <span class=p>=</span> <span class=p>(</span><span class=kt>ulong</span><span class=p>)</span><span class=n>limitExclusive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>uLimit</span> <span class=p>&lt;=</span> <span class=kt>int</span><span class=p>.</span><span class=n>MaxValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>rng</span><span class=p>.</span><span class=n>Next</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>uLimit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>ulong</span> <span class=n>u</span> <span class=p>=</span> <span class=p>((</span><span class=kt>ulong</span><span class=p>)(</span><span class=kt>uint</span><span class=p>)</span><span class=n>rng</span><span class=p>.</span><span class=n>Next</span><span class=p>()</span> <span class=p>&lt;&lt;</span> <span class=m>32</span><span class=p>)</span> <span class=p>|</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)</span><span class=n>rng</span><span class=p>.</span><span class=n>Next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=kt>ulong</span> <span class=n>r</span> <span class=p>=</span> <span class=n>u</span> <span class=p>%</span> <span class=n>uLimit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>u</span> <span class=p>-</span> <span class=n>r</span> <span class=p>&lt;=</span> <span class=kt>ulong</span><span class=p>.</span><span class=n>MaxValue</span> <span class=p>-</span> <span class=p>(</span><span class=kt>ulong</span><span class=p>.</span><span class=n>MaxValue</span> <span class=p>%</span> <span class=n>uLimit</span><span class=p>))</span> <span class=k>return</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=63-fast-shift>§6.3. Fast Shift</h2><p>The $\Shift$ estimator measures the median of all pairwise differences between elements of two samples.
Given samples $\x = (x_1, x_2, \ldots, x_n)$ and $\y = (y_1, y_2, \ldots, y_m)$, this estimator is defined as:</p>$$
\Shift(\x, \y) = \underset{1 \leq i \leq n,\,\, 1 \leq j \leq m}{\Median} \left(x_i - y_j \right)
$$<p>This definition represents a special case of a more general problem:
computing arbitrary quantiles of all pairwise differences.
For samples of size $n$ and $m$, the total number of pairwise differences is $n \times m$.
A naive approach would materialize all differences, sort them, and extract the desired quantile.
With $n = m = 10,000$, this approach creates 100 million values,
requiring quadratic memory and $O(nm \log(nm))$ time.</p><p>The presented algorithm avoids materializing pairwise differences by exploiting the sorted structure of the samples.
After sorting both samples to obtain $x_1 \leq x_2 \leq \cdots \leq x_n$ and $y_1 \leq y_2 \leq \cdots \leq y_m$,
the key insight is that it&rsquo;s possible to count how many pairwise differences fall below any threshold
without computing them explicitly.
This counting operation enables a binary search over the continuous space of possible difference values,
iteratively narrowing the search range until it converges to the exact quantile.</p><p>The algorithm operates through a value-space search rather than index-space selection.
It maintains a search interval $[\text{searchMin}, \text{searchMax}]$, initialized to the range
of all possible differences: $[x_1 - y_m, x_n - y_1]$.
At each iteration, it selects a candidate value within this interval and counts
how many pairwise differences are less than or equal to this threshold.
For the median (quantile $p = 0.5$), if fewer than half the differences lie below the threshold,
the median must be larger; if more than half lie below, the median must be smaller.
Based on this comparison, the search space is reduced by eliminating portions
that cannot contain the target quantile.</p><p>The counting operation achieves linear complexity via a two-pointer sweep.
For a given threshold $t$, the number of pairs $(i,j)$ satisfying $x_i - y_j \leq t$ is counted.
This is equivalent to counting pairs where $y_j \geq x_i - t$.
For each row $i$ in the implicit matrix of differences, a column pointer
advances through the sorted $y$ array while $x_i - y_j > t$, stopping at the first position
where $x_i - y_j \leq t$.
All subsequent positions in that row satisfy the condition,
contributing $(m - j)$ pairs to the count for row $i$.
Because both samples are sorted, the column pointer advances monotonically and never backtracks across rows,
making each counting pass $O(n + m)$ regardless of the total number of differences.</p><p>During each counting pass, the algorithm tracks boundary values:
the largest difference at or below the threshold and the smallest difference above it.
When the count exactly matches the target rank (or the two middle ranks for even-length samples),
these boundary values provide the exact answer without additional searches.
For Type-7 quantile computation, which interpolates between order statistics,
the algorithm collects the necessary boundary values in a single pass
and performs linear interpolation: $(1 - w) \cdot \text{lower} + w \cdot \text{upper}$.</p><p>Real datasets often contain discrete or repeated values that can cause search stagnation.
The algorithm detects when the search interval stops shrinking between iterations,
indicating that multiple pairwise differences share the same value.
When the closest difference below the threshold equals the closest above,
all remaining candidates are identical and the algorithm terminates immediately.
Otherwise, it uses the boundary values from the counting pass to snap the search interval
to actual difference values, ensuring reliable convergence even with highly discrete data.</p><p>The binary search employs numerically stable midpoint calculations and terminates
when the search interval collapses to a single value or when boundary tracking confirms convergence.
Iteration limits are included as a safety mechanism,
though convergence typically occurs much earlier due to the exponential narrowing of the search space.</p><p>The algorithm naturally generalizes to multiple quantiles by computing each one independently.
For $k$ quantiles with samples of size $n$ and $m$, the total complexity is $O(k(n + m) \log L)$,
where $L$ represents the convergence precision.
This is dramatically more efficient than the naive $O(nm \log(nm))$ approach,
especially for large $n$ and $m$ with small $k$.
The algorithm requires only $O(1)$ additional space beyond the input arrays,
making it practical for large-scale statistical analysis
where memory constraints prohibit materializing quadratic data structures.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>Pragmastat.Algorithms</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Collections.Generic</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>FastShift</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// Computes quantiles of all pairwise differences { x_i - y_j }.</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// Time: O((m + n) * log(precision)) per quantile. Space: O(1).</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;param name=&#34;p&#34;&gt;Probabilities in [0, 1].&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>  <span class=cs>/// &lt;param name=&#34;assumeSorted&#34;&gt;If false, collections will be sorted.&lt;/param&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>static</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>Estimate</span><span class=p>(</span><span class=n>IReadOnlyList</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>x</span><span class=p>,</span> <span class=n>IReadOnlyList</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>y</span><span class=p>,</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>p</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>assumeSorted</span> <span class=p>=</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>x</span> <span class=p>==</span> <span class=kc>null</span> <span class=p>||</span> <span class=n>y</span> <span class=p>==</span> <span class=kc>null</span> <span class=p>||</span> <span class=n>p</span> <span class=p>==</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentNullException</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>Count</span> <span class=p>==</span> <span class=m>0</span> <span class=p>||</span> <span class=n>y</span><span class=p>.</span><span class=n>Count</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentException</span><span class=p>(</span><span class=s>&#34;x and y must be non-empty.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>double</span> <span class=n>pk</span> <span class=k>in</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=kt>double</span><span class=p>.</span><span class=n>IsNaN</span><span class=p>(</span><span class=n>pk</span><span class=p>)</span> <span class=p>||</span> <span class=n>pk</span> <span class=p>&lt;</span> <span class=m>0.0</span> <span class=p>||</span> <span class=n>pk</span> <span class=p>&gt;</span> <span class=m>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentOutOfRangeException</span><span class=p>(</span><span class=n>nameof</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=s>&#34;Probabilities must be within [0, 1].&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>double</span><span class=p>[]</span> <span class=n>xs</span><span class=p>,</span> <span class=n>ys</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>assumeSorted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>xs</span> <span class=p>=</span> <span class=n>x</span> <span class=k>as</span> <span class=kt>double</span><span class=p>[]</span> <span class=p>??</span> <span class=n>x</span><span class=p>.</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>ys</span> <span class=p>=</span> <span class=n>y</span> <span class=k>as</span> <span class=kt>double</span><span class=p>[]</span> <span class=p>??</span> <span class=n>y</span><span class=p>.</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>xs</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>OrderBy</span><span class=p>(</span><span class=n>v</span> <span class=p>=&gt;</span> <span class=n>v</span><span class=p>).</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>ys</span> <span class=p>=</span> <span class=n>y</span><span class=p>.</span><span class=n>OrderBy</span><span class=p>(</span><span class=n>v</span> <span class=p>=&gt;</span> <span class=n>v</span><span class=p>).</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>m</span> <span class=p>=</span> <span class=n>xs</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=n>ys</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>total</span> <span class=p>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>m</span> <span class=p>*</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Type-7 quantile: h = 1 + (n-1)*p, then interpolate between floor(h) and ceil(h)</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>requiredRanks</span> <span class=p>=</span> <span class=k>new</span> <span class=n>SortedSet</span><span class=p>&lt;</span><span class=kt>long</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>interpolationParams</span> <span class=p>=</span> <span class=k>new</span> <span class=p>(</span><span class=kt>long</span> <span class=n>lowerRank</span><span class=p>,</span> <span class=kt>long</span> <span class=n>upperRank</span><span class=p>,</span> <span class=kt>double</span> <span class=n>weight</span><span class=p>)[</span><span class=n>p</span><span class=p>.</span><span class=n>Length</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>h</span> <span class=p>=</span> <span class=m>1.0</span> <span class=p>+</span> <span class=p>(</span><span class=n>total</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>*</span> <span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>lowerRank</span> <span class=p>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Floor</span><span class=p>(</span><span class=n>h</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kt>long</span> <span class=n>upperRank</span> <span class=p>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Ceiling</span><span class=p>(</span><span class=n>h</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>weight</span> <span class=p>=</span> <span class=n>h</span> <span class=p>-</span> <span class=n>lowerRank</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>lowerRank</span> <span class=p>&lt;</span> <span class=m>1</span><span class=p>)</span> <span class=n>lowerRank</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>upperRank</span> <span class=p>&gt;</span> <span class=n>total</span><span class=p>)</span> <span class=n>upperRank</span> <span class=p>=</span> <span class=n>total</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>interpolationParams</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=n>lowerRank</span><span class=p>,</span> <span class=n>upperRank</span><span class=p>,</span> <span class=n>weight</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>requiredRanks</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>lowerRank</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>requiredRanks</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>upperRank</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>rankValues</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Dictionary</span><span class=p>&lt;</span><span class=kt>long</span><span class=p>,</span> <span class=kt>double</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>long</span> <span class=n>rank</span> <span class=k>in</span> <span class=n>requiredRanks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>rankValues</span><span class=p>[</span><span class=n>rank</span><span class=p>]</span> <span class=p>=</span> <span class=n>SelectKthPairwiseDiff</span><span class=p>(</span><span class=n>xs</span><span class=p>,</span> <span class=n>ys</span><span class=p>,</span> <span class=n>rank</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=n>p</span><span class=p>.</span><span class=n>Length</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>var</span> <span class=p>(</span><span class=n>lowerRank</span><span class=p>,</span> <span class=n>upperRank</span><span class=p>,</span> <span class=n>weight</span><span class=p>)</span> <span class=p>=</span> <span class=n>interpolationParams</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>lower</span> <span class=p>=</span> <span class=n>rankValues</span><span class=p>[</span><span class=n>lowerRank</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>upper</span> <span class=p>=</span> <span class=n>rankValues</span><span class=p>[</span><span class=n>upperRank</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>weight</span> <span class=p>==</span> <span class=m>0.0</span> <span class=p>?</span> <span class=n>lower</span> <span class=p>:</span> <span class=p>(</span><span class=m>1.0</span> <span class=p>-</span> <span class=n>weight</span><span class=p>)</span> <span class=p>*</span> <span class=n>lower</span> <span class=p>+</span> <span class=n>weight</span> <span class=p>*</span> <span class=n>upper</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Binary search in [min_diff, max_diff] that snaps to actual discrete values.</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Avoids materializing all m*n differences.</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>SelectKthPairwiseDiff</span><span class=p>(</span><span class=kt>double</span><span class=p>[]</span> <span class=n>x</span><span class=p>,</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>y</span><span class=p>,</span> <span class=kt>long</span> <span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>m</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=n>y</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>total</span> <span class=p>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>m</span> <span class=p>*</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>k</span> <span class=p>&lt;</span> <span class=m>1</span> <span class=p>||</span> <span class=n>k</span> <span class=p>&gt;</span> <span class=n>total</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentOutOfRangeException</span><span class=p>(</span><span class=n>nameof</span><span class=p>(</span><span class=n>k</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>searchMin</span> <span class=p>=</span> <span class=n>x</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>-</span> <span class=n>y</span><span class=p>[</span><span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>searchMax</span> <span class=p>=</span> <span class=n>x</span><span class=p>[</span><span class=n>m</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>y</span><span class=p>[</span><span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kt>double</span><span class=p>.</span><span class=n>IsNaN</span><span class=p>(</span><span class=n>searchMin</span><span class=p>)</span> <span class=p>||</span> <span class=kt>double</span><span class=p>.</span><span class=n>IsNaN</span><span class=p>(</span><span class=n>searchMax</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidOperationException</span><span class=p>(</span><span class=s>&#34;NaN in input values.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>const</span> <span class=kt>int</span> <span class=n>maxIterations</span> <span class=p>=</span> <span class=m>128</span><span class=p>;</span> <span class=c1>// Sufficient for double precision convergence</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>prevMin</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>NegativeInfinity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>prevMax</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>PositiveInfinity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>iter</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>iter</span> <span class=p>&lt;</span> <span class=n>maxIterations</span> <span class=p>&amp;&amp;</span> <span class=n>searchMin</span> <span class=p>!=</span> <span class=n>searchMax</span><span class=p>;</span> <span class=n>iter</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>double</span> <span class=n>mid</span> <span class=p>=</span> <span class=n>Midpoint</span><span class=p>(</span><span class=n>searchMin</span><span class=p>,</span> <span class=n>searchMax</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>CountAndNeighbors</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>mid</span><span class=p>,</span> <span class=k>out</span> <span class=kt>long</span> <span class=n>countLessOrEqual</span><span class=p>,</span> <span class=k>out</span> <span class=kt>double</span> <span class=n>closestBelow</span><span class=p>,</span> <span class=k>out</span> <span class=kt>double</span> <span class=n>closestAbove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>closestBelow</span> <span class=p>==</span> <span class=n>closestAbove</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>closestBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// No progress means we&#39;re stuck between two discrete values</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>searchMin</span> <span class=p>==</span> <span class=n>prevMin</span> <span class=p>&amp;&amp;</span> <span class=n>searchMax</span> <span class=p>==</span> <span class=n>prevMax</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>countLessOrEqual</span> <span class=p>&gt;=</span> <span class=n>k</span> <span class=p>?</span> <span class=n>closestBelow</span> <span class=p>:</span> <span class=n>closestAbove</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>prevMin</span> <span class=p>=</span> <span class=n>searchMin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>prevMax</span> <span class=p>=</span> <span class=n>searchMax</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>countLessOrEqual</span> <span class=p>&gt;=</span> <span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>searchMax</span> <span class=p>=</span> <span class=n>closestBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>searchMin</span> <span class=p>=</span> <span class=n>closestAbove</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>searchMin</span> <span class=p>!=</span> <span class=n>searchMax</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidOperationException</span><span class=p>(</span><span class=s>&#34;Convergence failure (pathological input).&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>searchMin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Two-pointer algorithm: counts pairs where x[i] - y[j] &lt;= threshold, and tracks</span>
</span></span><span class=line><span class=cl>  <span class=c1>// the closest actual differences on either side of threshold.</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>CountAndNeighbors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span><span class=p>[]</span> <span class=n>x</span><span class=p>,</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>y</span><span class=p>,</span> <span class=kt>double</span> <span class=n>threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>out</span> <span class=kt>long</span> <span class=n>countLessOrEqual</span><span class=p>,</span> <span class=k>out</span> <span class=kt>double</span> <span class=n>closestBelow</span><span class=p>,</span> <span class=k>out</span> <span class=kt>double</span> <span class=n>closestAbove</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>m</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>Length</span><span class=p>,</span> <span class=n>n</span> <span class=p>=</span> <span class=n>y</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>count</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>maxBelow</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>NegativeInfinity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>minAbove</span> <span class=p>=</span> <span class=kt>double</span><span class=p>.</span><span class=n>PositiveInfinity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=n>j</span> <span class=p>&lt;</span> <span class=n>n</span> <span class=p>&amp;&amp;</span> <span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>y</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>threshold</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>j</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>count</span> <span class=p>+=</span> <span class=p>(</span><span class=n>n</span> <span class=p>-</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>diff</span> <span class=p>=</span> <span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>y</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>diff</span> <span class=p>&gt;</span> <span class=n>maxBelow</span><span class=p>)</span> <span class=n>maxBelow</span> <span class=p>=</span> <span class=n>diff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>diff</span> <span class=p>=</span> <span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>y</span><span class=p>[</span><span class=n>j</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>diff</span> <span class=p>&lt;</span> <span class=n>minAbove</span><span class=p>)</span> <span class=n>minAbove</span> <span class=p>=</span> <span class=n>diff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Fallback to actual min/max if no boundaries found (shouldn&#39;t happen in normal operation)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kt>double</span><span class=p>.</span><span class=n>IsNegativeInfinity</span><span class=p>(</span><span class=n>maxBelow</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=n>maxBelow</span> <span class=p>=</span> <span class=n>x</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>-</span> <span class=n>y</span><span class=p>[</span><span class=n>n</span> <span class=p>-</span> <span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kt>double</span><span class=p>.</span><span class=n>IsPositiveInfinity</span><span class=p>(</span><span class=n>minAbove</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=n>minAbove</span> <span class=p>=</span> <span class=n>x</span><span class=p>[</span><span class=n>m</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>y</span><span class=p>[</span><span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>countLessOrEqual</span> <span class=p>=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>closestBelow</span> <span class=p>=</span> <span class=n>maxBelow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>closestAbove</span> <span class=p>=</span> <span class=n>minAbove</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>Midpoint</span><span class=p>(</span><span class=kt>double</span> <span class=n>a</span><span class=p>,</span> <span class=kt>double</span> <span class=n>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>a</span> <span class=p>+</span> <span class=p>(</span><span class=n>b</span> <span class=p>-</span> <span class=n>a</span><span class=p>)</span> <span class=p>*</span> <span class=m>0.5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=7-studies>§7. Studies</h1><p>This section analyzes the estimators&rsquo; properties using mathematical proofs.
Most proofs are adapted from various textbooks and research papers, but only essential references are provided.</p><p>Unlike the main part of the manual, the studies require knowledge of classic statistical methods.
Well-known facts and commonly accepted notation are used without special introduction.
The studies provide detailed analyses of estimator properties for practitioners
interested in rigorous proofs and numerical simulation results.</p><h2 id=71-additive-normal-distribution>§7.1. Additive (&lsquo;Normal&rsquo;) Distribution</h2><p>The $\Additive$ (&lsquo;Normal&rsquo;) distribution has two parameters: the mean and the standard deviation,
written as $\Additive(\mathrm{mean}, \mathrm{stdDev})$.</p><h3 id=711-asymptotic-spread-value>§7.1.1. Asymptotic Spread Value</h3><p>Consider two independent draws $X$ and $Y$ from the $\Additive(\mathrm{mean}, \mathrm{stdDev})$ distribution.
The goal is to find the median of their absolute difference $|X-Y|$.
Define the difference $D = X - Y$.
By linearity of expectation, $E[D] = 0$. By independence, $\mathrm{Var}[D] = 2 \cdot \mathrm{stdDev}^2$.
Thus $D$ has distribution $\Additive(0, \sqrt{2} \cdot \mathrm{stdDev})$,
and the problem reduces to finding the median of $|D|$.
The location parameter $\mathrm{mean}$ disappears, as expected,
because absolute differences are invariant to shifts.</p><p>Let $\tau=\sqrt{2} \cdot \mathrm{stdDev}$, so that $D\sim \Additive(0,\tau)$.
The random variable $|D|$ then follows the Half-$\Additive$ (&lsquo;Folded Normal&rsquo;) distribution with scale $\tau$.
Its cumulative distribution function for $z\ge 0$ becomes</p>$$
F_{|D|}(z) = \Pr(|D|\le z) = 2\Phi\!\left(\frac{z}{\tau}\right) - 1,
$$<p>where $\Phi$ denotes the standard $\Additive$ (&lsquo;Normal&rsquo;) CDF.</p><p>The median $m$ is the point at which this cdf equals $1/2$.
Setting $F_{|D|}(m)=1/2$ gives</p>$$
2\Phi\!\left(\frac{m}{\tau}\right)-1 = \tfrac{1}{2}
\quad\Longrightarrow\quad
\Phi\!\left(\frac{m}{\tau}\right)=\tfrac{3}{4}.
$$<p>Applying the inverse cdf yields $m/\tau=z_{0.75}$.
Substituting back $\tau=\sqrt{2} \cdot \mathrm{stdDev}$ produces</p>$$
\Median(|X-Y|) = \sqrt{2} \cdot z_{0.75} \cdot \mathrm{stdDev}.
$$<p>Define $z_{0.75} := \Phi^{-1}(0.75) \approx 0.6744897502$. Numerically,
the median absolute difference is approximately $\sqrt{2} \cdot z_{0.75} \cdot \mathrm{stdDev} \approx 0.9538725524 \cdot \mathrm{stdDev}$.
This expression depends only on the scale parameter $\mathrm{stdDev}$, not on the mean,
reflecting the translation invariance of the problem.</p><h3 id=712-lemma-average-estimator-drift-formula>§7.1.2. Lemma: Average Estimator Drift Formula</h3><p>For average estimators $T_n$ with asymptotic standard deviation $a \cdot \mathrm{stdDev} / \sqrt{n}$ around the mean $\mu$,
define $\RelSpread[T_n] := \Spread[T_n] / \Spread[X]$.
In the $\Additive$ (&lsquo;Normal&rsquo;) case, $\Spread[X] = \sqrt{2} \cdot z_{0.75} \cdot \mathrm{stdDev}$.</p><p>For any average estimator $T_n$ with asymptotic distribution $T_n \sim \text{approx } \Additive(\mu, (a \cdot \mathrm{stdDev})^2 / n)$, the drift calculation follows:</p><ul><li>The spread of two independent estimates: $\Spread[T_n] = \sqrt{2} \cdot z_{0.75} \cdot a \cdot \mathrm{stdDev} / \sqrt{n}$</li><li>The relative spread: $\RelSpread[T_n] = a / \sqrt{n}$</li><li>The asymptotic drift: $\Drift(T,X) = a$</li></ul><h3 id=713-asymptotic-mean-drift>§7.1.3. Asymptotic Mean Drift</h3><p>For the sample mean $\Mean(\x) = \frac{1}{n}\sum_{i=1}^n x_i$ applied to samples
from $\Additive(\mathrm{mean}, \mathrm{stdDev})$,
the sampling distribution of $\Mean$ is also additive with mean $\mathrm{mean}$
and standard deviation $\mathrm{stdDev}/\sqrt{n}$.</p><p>Using the lemma with $a = 1$ (since the standard deviation is $\mathrm{stdDev}/\sqrt{n}$):</p>$$
\Drift(\Mean, X) = 1
$$<p>$\Mean$ achieves unit drift under the $\Additive$ (&lsquo;Normal&rsquo;) distribution, serving as the natural baseline for comparison.
$\Mean$ is the optimal estimator under the $\Additive$ (&lsquo;Normal&rsquo;) distribution: no other estimator achieves lower $\Drift$.</p><h3 id=714-asymptotic-median-drift>§7.1.4. Asymptotic Median Drift</h3><p>For the sample median $\Median(\x)$ applied to samples from $\Additive(\mathrm{mean}, \mathrm{stdDev})$,
the asymptotic sampling distribution of $\Median$ is approximately $\Additive$ (&lsquo;Normal&rsquo;)
with mean $\mathrm{mean}$ and standard deviation $\sqrt{\pi/2} \cdot \mathrm{stdDev}/\sqrt{n}$.</p><p>This result follows from the asymptotic theory of order statistics.
For the median of a sample from a continuous distribution with density $f$ and cumulative distribution $F$,
the asymptotic variance is $1/(4n[f(F^{-1}(0.5))]^2)$.
For the $\Additive$ (&lsquo;Normal&rsquo;) distribution with standard deviation $\mathrm{stdDev}$,
the density at the median (which equals the mean) is $1/(\mathrm{stdDev}\sqrt{2\pi})$.
Thus the asymptotic variance becomes $\pi \cdot \mathrm{stdDev}^2/(2n)$.</p><p>Using the lemma with $a = \sqrt{\pi/2}$:</p>$$
\Drift(\Median, X) = \sqrt{\frac{\pi}{2}}
$$<p>Numerically, $\sqrt{\pi/2} \approx 1.2533$, so the median has approximately 25% higher drift than the mean
under the $\Additive$ (&lsquo;Normal&rsquo;) distribution.</p><h3 id=715-asymptotic-center-drift>§7.1.5. Asymptotic Center Drift</h3><p>For the sample center $\Center(\x) = \underset{1 \leq i \leq j \leq n}{\Median} \left(\frac{x_i + x_j}{2}\right)$ applied to samples from $\Additive(\mathrm{mean}, \mathrm{stdDev})$,
its asymptotic sampling distribution must be determined.</p><p>The center estimator computes all pairwise averages (including $i=j$) and takes their median.
For the $\Additive$ (&lsquo;Normal&rsquo;) distribution, asymptotic theory shows that the center estimator
is asymptotically $\Additive$ (&lsquo;Normal&rsquo;) with mean $\mathrm{mean}$.</p><p>The exact asymptotic variance of the center estimator for the $\Additive$ (&lsquo;Normal&rsquo;) distribution is:</p>$$
\mathrm{Var}[\Center(X_{1:n})] = \frac{\pi \cdot \mathrm{stdDev}^2}{3n}
$$<p>This gives an asymptotic standard deviation of:</p>$$
\mathrm{StdDev}[\Center(X_{1:n})] = \sqrt{\frac{\pi}{3}} \cdot \frac{\mathrm{stdDev}}{\sqrt{n}}
$$<p>Using the lemma with $a = \sqrt{\pi/3}$:</p>$$
\Drift(\Center, X) = \sqrt{\frac{\pi}{3}}
$$<p>Numerically, $\sqrt{\pi/3} \approx 1.0233$,
so the center estimator achieves a drift very close to 1 under the $\Additive$ (&lsquo;Normal&rsquo;) distribution,
performing nearly as well as the mean while offering greater robustness to outliers.</p><h3 id=716-lemma-dispersion-estimator-drift-formula>§7.1.6. Lemma: Dispersion Estimator Drift Formula</h3><p>For dispersion estimators $T_n$ with asymptotic center $b \cdot \mathrm{stdDev}$
and standard deviation $a \cdot \mathrm{stdDev} / \sqrt{n}$,
define $\RelSpread[T_n] := \Spread[T_n] / (b \cdot \mathrm{stdDev})$.</p><p>For any dispersion estimator $T_n$ with asymptotic distribution $T_n \sim \text{approx } \Additive(b \cdot \mathrm{stdDev}, (a \cdot \mathrm{stdDev})^2 / n)$, the drift calculation follows:</p><ul><li>The spread of two independent estimates: $\Spread[T_n] = \sqrt{2} \cdot z_{0.75} \cdot a \cdot \mathrm{stdDev} / \sqrt{n}$</li><li>The relative spread: $\RelSpread[T_n] = \sqrt{2} \cdot z_{0.75} \cdot a / (b\sqrt{n})$</li><li>The asymptotic drift: $\Drift(T,X) = \sqrt{2} \cdot z_{0.75} \cdot a / b$</li></ul><p>Note: The $\sqrt{2}$ factor comes from the standard deviation of the difference $D = T_1 - T_2$
of two independent estimates,
and the $z_{0.75}$ factor converts this standard deviation to the median absolute difference.</p><h3 id=717-asymptotic-stddev-drift>§7.1.7. Asymptotic StdDev Drift</h3><p>For the sample standard deviation $\StdDev(\x) = \sqrt{\frac{1}{n-1}\sum_{i=1}^n (x_i - \Mean(\x))^2}$
applied to samples from $\Additive(\mathrm{mean}, \mathrm{stdDev})$,
the sampling distribution of $\StdDev$ is approximately $\Additive$ (&lsquo;Normal&rsquo;) for large $n$
with mean $\mathrm{stdDev}$ and standard deviation $\mathrm{stdDev}/\sqrt{2n}$.</p><p>Applying the lemma with $a = 1/\sqrt{2}$ and $b = 1$:</p>$$
\Spread[\StdDev(X_{1:n})] = \sqrt{2} \cdot z_{0.75} \cdot \frac{1}{\sqrt{2}} \cdot \frac{\mathrm{stdDev}}{\sqrt{n}} = z_{0.75} \cdot \frac{\mathrm{stdDev}}{\sqrt{n}}
$$<p>For the dispersion drift, we use the relative spread formula:</p>$$
\RelSpread[\StdDev(X_{1:n})] = \frac{\Spread[\StdDev(X_{1:n})]}{\Center[\StdDev(X_{1:n})]}
$$<p>Since $\Center[\StdDev(X_{1:n})] \approx \mathrm{stdDev}$ asymptotically:</p>$$
\RelSpread[\StdDev(X_{1:n})] = \frac{z_{0.75} \cdot \mathrm{stdDev}/\sqrt{n}}{\mathrm{stdDev}} = \frac{z_{0.75}}{\sqrt{n}}
$$<p>Therefore:</p>$$
\Drift(\StdDev, X) = \lim_{n \to \infty} \sqrt{n} \cdot \RelSpread[\StdDev(X_{1:n})] = z_{0.75}
$$<p>Numerically, $z_{0.75} \approx 0.67449$.</p><h3 id=718-asymptotic-mad-drift>§7.1.8. Asymptotic MAD Drift</h3><p>For the median absolute deviation $\MAD(\x) = \Median(|x_i - \Median(\x)|)$
applied to samples from $\Additive(\mathrm{mean}, \mathrm{stdDev})$,
the asymptotic distribution is approximately $\Additive$ (&lsquo;Normal&rsquo;).</p><p>For the $\Additive$ (&lsquo;Normal&rsquo;) distribution, the population MAD equals $z_{0.75} \cdot \mathrm{stdDev}$.
The asymptotic standard deviation of the sample MAD is:</p>$$
\mathrm{StdDev}[\MAD(X_{1:n})] = c_{\mathrm{mad}} \cdot \frac{\mathrm{stdDev}}{\sqrt{n}}
$$<p>where $c_{\mathrm{mad}} \approx 0.78$.</p><p>Applying the lemma with $a = c_{\mathrm{mad}}$ and $b = z_{0.75}$:</p>$$
\Spread[\MAD(X_{1:n})] = \sqrt{2} \cdot z_{0.75} \cdot c_{\mathrm{mad}} \cdot \frac{\mathrm{stdDev}}{\sqrt{n}}
$$<p>Since $\Center[\MAD(X_{1:n})] \approx z_{0.75} \cdot \mathrm{stdDev}$ asymptotically:</p>$$
\RelSpread[\MAD(X_{1:n})] = \frac{\sqrt{2} \cdot z_{0.75} \cdot c_{\mathrm{mad}} \cdot \mathrm{stdDev}/\sqrt{n}}{z_{0.75} \cdot \mathrm{stdDev}} = \frac{\sqrt{2} \cdot c_{\mathrm{mad}}}{\sqrt{n}}
$$<p>Therefore:</p>$$
\Drift(\MAD, X) = \lim_{n \to \infty} \sqrt{n} \cdot \RelSpread[\MAD(X_{1:n})] = \sqrt{2} \cdot c_{\mathrm{mad}}
$$<p>Numerically, $\sqrt{2} \cdot c_{\mathrm{mad}} \approx \sqrt{2} \cdot 0.78 \approx 1.10$.</p><h3 id=719-asymptotic-spread-drift>§7.1.9. Asymptotic Spread Drift</h3><p>For the sample spread $\Spread(\x) = \underset{1 \leq i < j \leq n}{\Median} |x_i - x_j|$
applied to samples from $\Additive(\mathrm{mean}, \mathrm{stdDev})$,
the asymptotic distribution is approximately $\Additive$ (&lsquo;Normal&rsquo;).</p><p>The spread estimator computes all pairwise absolute differences and takes their median.
For the $\Additive$ (&lsquo;Normal&rsquo;) distribution, the population spread equals $\sqrt{2} \cdot z_{0.75} \cdot \mathrm{stdDev}$
as derived in the Asymptotic Spread Value section.</p><p>The asymptotic standard deviation of the sample spread for the $\Additive$ (&lsquo;Normal&rsquo;) distribution is:</p>$$
\mathrm{StdDev}[\Spread(X_{1:n})] = c_{\mathrm{spr}} \cdot \frac{\mathrm{stdDev}}{\sqrt{n}}
$$<p>where $c_{\mathrm{spr}} \approx 0.72$.</p><p>Applying the lemma with $a = c_{\mathrm{spr}}$ and $b = \sqrt{2} \cdot z_{0.75}$:</p>$$
\Spread[\Spread(X_{1:n})] = \sqrt{2} \cdot z_{0.75} \cdot c_{\mathrm{spr}} \cdot \frac{\mathrm{stdDev}}{\sqrt{n}}
$$<p>Since $\Center[\Spread(X_{1:n})] \approx \sqrt{2} \cdot z_{0.75} \cdot \mathrm{stdDev}$ asymptotically:</p>$$
\RelSpread[\Spread(X_{1:n})] = \frac{\sqrt{2} \cdot z_{0.75} \cdot c_{\mathrm{spr}} \cdot \mathrm{stdDev}/\sqrt{n}}{\sqrt{2} \cdot z_{0.75} \cdot \mathrm{stdDev}} = \frac{c_{\mathrm{spr}}}{\sqrt{n}}
$$<p>Therefore:</p>$$
\Drift(\Spread, X) = \lim_{n \to \infty} \sqrt{n} \cdot \RelSpread[\Spread(X_{1:n})] = c_{\mathrm{spr}}
$$<p>Numerically, $c_{\mathrm{spr}} \approx 0.72$.</p><h3 id=7110-summary>§7.1.10. Summary</h3><p><strong>Summary for average estimators:</strong></p><table><thead><tr><th>Estimator</th><th>$\Drift(E, X)$</th><th>$\Drift^2(E, X)$</th><th>$1/\Drift^2(E, X)$</th></tr></thead><tbody><tr><td>$\Mean$</td><td>$1$</td><td>$1$</td><td>$1$</td></tr><tr><td>$\Median$</td><td>$\approx 1.253$</td><td>$\pi/2 \approx 1.571$</td><td>$2/\pi \approx 0.637$</td></tr><tr><td>$\Center$</td><td>$\approx 1.023$</td><td>$\pi/3 \approx 1.047$</td><td>$3/\pi \approx 0.955$</td></tr></tbody></table><p>The squared drift values indicate the sample size adjustment needed when switching estimators.
For instance, switching from $\Mean$ to $\Median$ while maintaining the same precision
requires increasing the sample size by a factor of $\pi/2 \approx 1.571$ (about 57% more observations).
Similarly, switching from $\Mean$ to $\Center$ requires only about 5% more observations.</p><p>The inverse squared drift (rightmost column) equals the classical statistical efficiency relative to the $\Mean$.
The $\Mean$ achieves optimal performance (unit efficiency) for the $\Additive$ (&lsquo;Normal&rsquo;) distribution,
as expected from classical theory.
The $\Center$ maintains 95.5% efficiency while offering greater robustness to outliers,
making it an attractive alternative when some contamination is possible.
The $\Median$, while most robust, operates at only 63.7% efficiency
under purely $\Additive$ (&lsquo;Normal&rsquo;) conditions.</p><p><strong>Summary for dispersion estimators:</strong></p><p>For the $\Additive$ (&lsquo;Normal&rsquo;) distribution, the asymptotic drift values reveal the relative precision of different dispersion estimators:</p><table><thead><tr><th>Estimator</th><th>$\Drift(E, X)$</th><th>$\Drift^2(E, X)$</th><th>$1/\Drift^2(E, X)$</th></tr></thead><tbody><tr><td>$\StdDev$</td><td>$\approx 0.67$</td><td>$\approx 0.45$</td><td>$\approx 2.22$</td></tr><tr><td>$\MAD$</td><td>$\approx 1.10$</td><td>$\approx 1.22$</td><td>$\approx 0.82$</td></tr><tr><td>$\Spread$</td><td>$\approx 0.72$</td><td>$\approx 0.52$</td><td>$\approx 1.92$</td></tr></tbody></table><p>The squared drift values indicate the sample size adjustment needed when switching estimators.
For instance, switching from $\StdDev$ to $\MAD$ while maintaining the same precision
requires increasing the sample size by a factor of $1.22/0.45 \approx 2.71$ (more than doubling the observations).
Similarly, switching from $\StdDev$ to $\Spread$ requires a factor of $0.52/0.45 \approx 1.16$.</p><p>The $\StdDev$ achieves optimal performance for the $\Additive$ (&lsquo;Normal&rsquo;) distribution.
The $\MAD$ requires about 2.7 times more data to match the $\StdDev$ precision
while offering greater robustness to outliers.
The $\Spread$ requires about 1.16 times more data to match the $\StdDev$ precision under purely $\Additive$ (&lsquo;Normal&rsquo;) conditions while maintaining robustness.</p><h1 id=8-reference-implementations>§8. Reference Implementations</h1><p><span id=py></span></p><h2 id=81-python>§8.1. Python</h2><p>Install from PyPI:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install <span class=nv>pragmastat</span><span class=o>==</span>3.2.2
</span></span></code></pre></div><p>Source code: <a href=https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/py>https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/py</a></p><p>Pragmastat on PyPI: <a href=https://pypi.org/project/pragmastat/>https://pypi.org/project/pragmastat/</a></p><p>Demo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pragmastat</span> <span class=kn>import</span> <span class=n>center</span><span class=p>,</span> <span class=n>spread</span><span class=p>,</span> <span class=n>rel_spread</span><span class=p>,</span> <span class=n>shift</span><span class=p>,</span> <span class=n>ratio</span><span class=p>,</span> <span class=n>avg_spread</span><span class=p>,</span> <span class=n>disparity</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>center</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>  <span class=c1># 4</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>center</span><span class=p>([</span><span class=n>v</span> <span class=o>+</span> <span class=mi>10</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]))</span>  <span class=c1># 14</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>center</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>3</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]))</span>  <span class=c1># 12</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>  <span class=c1># 4</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>spread</span><span class=p>([</span><span class=n>v</span> <span class=o>+</span> <span class=mi>10</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]))</span>  <span class=c1># 4</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>spread</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]))</span>  <span class=c1># 8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>rel_spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>  <span class=c1># 1</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>rel_spread</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>5</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]))</span>  <span class=c1># 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>18</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>  <span class=c1># -10</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span>  <span class=c1># 0</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>shift</span><span class=p>([</span><span class=n>v</span> <span class=o>+</span> <span class=mi>7</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>],</span> <span class=p>[</span><span class=n>v</span> <span class=o>+</span> <span class=mi>3</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>y</span><span class=p>]))</span>  <span class=c1># -6</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>shift</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>],</span> <span class=p>[</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>y</span><span class=p>]))</span>  <span class=c1># -20</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span>  <span class=c1># 10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>  <span class=c1># 0.5</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span>  <span class=c1># 1</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>ratio</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>],</span> <span class=p>[</span><span class=n>v</span> <span class=o>*</span> <span class=mi>5</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>y</span><span class=p>]))</span>  <span class=c1># 0.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>12</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>  <span class=c1># 6</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>y</span><span class=p>))</span>  <span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>  <span class=c1># 5</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span>  <span class=c1># 6</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>],</span> <span class=p>[</span><span class=n>v</span> <span class=o>*</span> <span class=mi>3</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>]))</span>  <span class=c1># 15</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span>  <span class=c1># 5</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>],</span> <span class=p>[</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>y</span><span class=p>]))</span>  <span class=c1># 10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>  <span class=c1># 2</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>  <span class=c1># 5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>  <span class=c1># 0.4</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>([</span><span class=n>v</span> <span class=o>+</span> <span class=mi>5</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>],</span> <span class=p>[</span><span class=n>v</span> <span class=o>+</span> <span class=mi>5</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>y</span><span class=p>]))</span>  <span class=c1># 0.4</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>([</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>x</span><span class=p>],</span> <span class=p>[</span><span class=n>v</span> <span class=o>*</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>y</span><span class=p>]))</span>  <span class=c1># 0.4</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span>  <span class=c1># -0.4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p><span id=ts></span></p><h2 id=82-typescript>§8.2. TypeScript</h2><p>Install from npm:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npm i pragmastat@3.2.2
</span></span></code></pre></div><p>Source code: <a href=https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/ts>https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/ts</a></p><p>Pragmastat on npm: <a href=https://www.npmjs.com/package/pragmastat>https://www.npmjs.com/package/pragmastat</a></p><p>Demo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>center</span><span class=p>,</span> <span class=nx>spread</span><span class=p>,</span> <span class=nx>relSpread</span><span class=p>,</span> <span class=nx>shift</span><span class=p>,</span> <span class=nx>ratio</span><span class=p>,</span> <span class=nx>avgSpread</span><span class=p>,</span> <span class=nx>disparity</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;../src&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>main() {</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>center</span><span class=p>(</span><span class=nx>x</span><span class=p>));</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>center</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>+</span> <span class=mi>10</span><span class=p>)));</span> <span class=c1>// 14
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>center</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>3</span><span class=p>)));</span> <span class=c1>// 12
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>spread</span><span class=p>(</span><span class=nx>x</span><span class=p>));</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>spread</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>+</span> <span class=mi>10</span><span class=p>)));</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>spread</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)));</span> <span class=c1>// 8
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>relSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>));</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>relSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>5</span><span class=p>)));</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>y</span> <span class=o>=</span> <span class=p>[</span><span class=mi>10</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>18</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>shift</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>));</span> <span class=c1>// -10
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>shift</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>x</span><span class=p>));</span> <span class=c1>// 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>shift</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>+</span> <span class=mi>7</span><span class=p>),</span> <span class=nx>y</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)));</span> <span class=c1>// -6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>shift</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>),</span> <span class=nx>y</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)));</span> <span class=c1>// -20
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>shift</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span> <span class=nx>x</span><span class=p>));</span> <span class=c1>// 10
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>x</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>y</span> <span class=o>=</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>ratio</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>));</span> <span class=c1>// 0.5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>ratio</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>x</span><span class=p>));</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>ratio</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>),</span> <span class=nx>y</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>5</span><span class=p>)));</span> <span class=c1>// 0.2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>x</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>12</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>y</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>spread</span><span class=p>(</span><span class=nx>x</span><span class=p>));</span> <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>spread</span><span class=p>(</span><span class=nx>y</span><span class=p>));</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>avgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>));</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>avgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>x</span><span class=p>));</span> <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>avgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>),</span> <span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>3</span><span class=p>)));</span> <span class=c1>// 15
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>avgSpread</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span> <span class=nx>x</span><span class=p>));</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>avgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>),</span> <span class=nx>y</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)));</span> <span class=c1>// 10
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>shift</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>));</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>avgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>));</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>disparity</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>));</span> <span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>disparity</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>+</span> <span class=mi>5</span><span class=p>),</span> <span class=nx>y</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)));</span> <span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>disparity</span><span class=p>(</span><span class=nx>x</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>),</span> <span class=nx>y</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)));</span> <span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>disparity</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span> <span class=nx>x</span><span class=p>));</span> <span class=c1>// -0.4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>main</span><span class=p>();</span>
</span></span></code></pre></div><p><span id=r></span></p><h2 id=83-r>§8.3. R</h2><p>Install from GitHub:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-r data-lang=r><span class=line><span class=cl><span class=nf>install.packages</span><span class=p>(</span><span class=s>&#34;remotes&#34;</span><span class=p>)</span> <span class=c1># If &#39;remotes&#39; is not installed</span>
</span></span><span class=line><span class=cl><span class=n>remotes</span><span class=o>::</span><span class=nf>install_github</span><span class=p>(</span><span class=s>&#34;AndreyAkinshin/pragmastat&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>subdir</span> <span class=o>=</span> <span class=s>&#34;r/pragmastat&#34;</span><span class=p>,</span> <span class=n>ref</span> <span class=o>=</span> <span class=s>&#34;v3.2.2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>pragmastat</span><span class=p>)</span>
</span></span></code></pre></div><p>Source code: <a href=https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/r>https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/r</a></p><p>Demo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-r data-lang=r><span class=line><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>pragmastat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>&lt;-</span> <span class=nf>c</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>center</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>center</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=m>10</span><span class=p>))</span> <span class=c1># 14</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>center</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>3</span><span class=p>))</span> <span class=c1># 12</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>spread</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=m>10</span><span class=p>))</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>spread</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>2</span><span class=p>))</span> <span class=c1># 8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>rel_spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>rel_spread</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>5</span><span class=p>))</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>&lt;-</span> <span class=nf>c</span><span class=p>(</span><span class=m>10</span><span class=p>,</span> <span class=m>12</span><span class=p>,</span> <span class=m>14</span><span class=p>,</span> <span class=m>16</span><span class=p>,</span> <span class=m>18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1># -10</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>shift</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=m>7</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=m>3</span><span class=p>))</span> <span class=c1># -6</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>shift</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=o>*</span> <span class=m>2</span><span class=p>))</span> <span class=c1># -20</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>shift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1># 10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>&lt;-</span> <span class=nf>c</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>8</span><span class=p>,</span> <span class=m>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>&lt;-</span> <span class=nf>c</span><span class=p>(</span><span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>8</span><span class=p>,</span> <span class=m>16</span><span class=p>,</span> <span class=m>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1># 0.5</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>ratio</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=o>*</span> <span class=m>5</span><span class=p>))</span> <span class=c1># 0.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>&lt;-</span> <span class=nf>c</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>3</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>9</span><span class=p>,</span> <span class=m>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>&lt;-</span> <span class=nf>c</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1># 6</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>spread</span><span class=p>(</span><span class=n>y</span><span class=p>))</span> <span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>avg_spread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1># 5</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>avg_spread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1># 6</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>avg_spread</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>x</span> <span class=o>*</span> <span class=m>3</span><span class=p>))</span> <span class=c1># 15</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>avg_spread</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1># 5</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>avg_spread</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=o>*</span> <span class=m>2</span><span class=p>))</span> <span class=c1># 10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>avg_spread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1># 5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>disparity</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1># 0.4</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>disparity</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=m>5</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=m>5</span><span class=p>))</span> <span class=c1># 0.4</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>disparity</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=o>*</span> <span class=m>2</span><span class=p>))</span> <span class=c1># 0.4</span>
</span></span><span class=line><span class=cl><span class=nf>print</span><span class=p>(</span><span class=nf>disparity</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1># -0.4</span>
</span></span></code></pre></div><p><span id=cs></span></p><h2 id=84-c>§8.4. C#</h2><p>Install from NuGet via .NET CLI:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet add package Pragmastat --version 3.2.2
</span></span></code></pre></div><p>Install from NuGet via Package Manager Console:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps1 data-lang=ps1><span class=line><span class=cl><span class=n>NuGet</span><span class=p>\</span><span class=nb>Install-Package</span> <span class=n>Pragmastat</span> <span class=n>-Version</span> <span class=mf>3.2</span><span class=p>.</span><span class=py>2</span>
</span></span></code></pre></div><p>Source code: <a href=https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/cs>https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/cs</a></p><p>Pragmastat on NuGet: <a href=https://www.nuget.org/packages/Pragmastat/>https://www.nuget.org/packages/Pragmastat/</a></p><p>Demo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>static</span> <span class=n>System</span><span class=p>.</span><span class=n>Console</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>Pragmastat.Demo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>x</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Sample</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>Center</span><span class=p>());</span> <span class=c1>// 4</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>((</span><span class=n>x</span> <span class=p>+</span> <span class=m>10</span><span class=p>).</span><span class=n>Center</span><span class=p>());</span> <span class=c1>// 14</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>((</span><span class=n>x</span> <span class=p>*</span> <span class=m>3</span><span class=p>).</span><span class=n>Center</span><span class=p>());</span> <span class=c1>// 12</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>Spread</span><span class=p>());</span> <span class=c1>// 4</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>((</span><span class=n>x</span> <span class=p>+</span> <span class=m>10</span><span class=p>).</span><span class=n>Spread</span><span class=p>());</span> <span class=c1>// 4</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>((</span><span class=n>x</span> <span class=p>*</span> <span class=m>2</span><span class=p>).</span><span class=n>Spread</span><span class=p>());</span> <span class=c1>// 8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>RelSpread</span><span class=p>());</span> <span class=c1>// 1</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>((</span><span class=n>x</span> <span class=p>*</span> <span class=m>5</span><span class=p>).</span><span class=n>RelSpread</span><span class=p>());</span> <span class=c1>// 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>y</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Sample</span><span class=p>(</span><span class=m>10</span><span class=p>,</span> <span class=m>12</span><span class=p>,</span> <span class=m>14</span><span class=p>,</span> <span class=m>16</span><span class=p>,</span> <span class=m>18</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>));</span> <span class=c1>// -10</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span> <span class=c1>// 0</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Shift</span><span class=p>(</span><span class=n>x</span> <span class=p>+</span> <span class=m>7</span><span class=p>,</span> <span class=n>y</span> <span class=p>+</span> <span class=m>3</span><span class=p>));</span> <span class=c1>// -6</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Shift</span><span class=p>(</span><span class=n>x</span> <span class=p>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=p>*</span> <span class=m>2</span><span class=p>));</span> <span class=c1>// -20</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Shift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span> <span class=c1>// 10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Sample</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>8</span><span class=p>,</span> <span class=m>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Sample</span><span class=p>(</span><span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>8</span><span class=p>,</span> <span class=m>16</span><span class=p>,</span> <span class=m>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>));</span> <span class=c1>// 0.5</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span> <span class=c1>// 1</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Ratio</span><span class=p>(</span><span class=n>x</span> <span class=p>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=p>*</span> <span class=m>5</span><span class=p>));</span> <span class=c1>// 0.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Sample</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>3</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>9</span><span class=p>,</span> <span class=m>12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Sample</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>2</span><span class=p>,</span> <span class=m>4</span><span class=p>,</span> <span class=m>6</span><span class=p>,</span> <span class=m>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>Spread</span><span class=p>());</span> <span class=c1>// 6</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>y</span><span class=p>.</span><span class=n>Spread</span><span class=p>());</span> <span class=c1>// 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>AvgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>));</span> <span class=c1>// 5</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>AvgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span> <span class=c1>// 6</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>AvgSpread</span><span class=p>(</span><span class=n>x</span> <span class=p>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>x</span> <span class=p>*</span> <span class=m>3</span><span class=p>));</span> <span class=c1>// 15</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>AvgSpread</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span> <span class=c1>// 5</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>AvgSpread</span><span class=p>(</span><span class=n>x</span> <span class=p>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=p>*</span> <span class=m>2</span><span class=p>));</span> <span class=c1>// 10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>));</span> <span class=c1>// 2</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>AvgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>));</span> <span class=c1>// 5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Disparity</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>));</span> <span class=c1>// 0.4</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Disparity</span><span class=p>(</span><span class=n>x</span> <span class=p>+</span> <span class=m>5</span><span class=p>,</span> <span class=n>y</span> <span class=p>+</span> <span class=m>5</span><span class=p>));</span> <span class=c1>// 0.4</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Disparity</span><span class=p>(</span><span class=n>x</span> <span class=p>*</span> <span class=m>2</span><span class=p>,</span> <span class=n>y</span> <span class=p>*</span> <span class=m>2</span><span class=p>));</span> <span class=c1>// 0.4</span>
</span></span><span class=line><span class=cl>    <span class=n>WriteLine</span><span class=p>(</span><span class=n>Toolkit</span><span class=p>.</span><span class=n>Disparity</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span> <span class=c1>// -0.4</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><span id=kt></span></p><h2 id=85-kotlin>§8.5. Kotlin</h2><p>Install from Maven Central Repository via Apache Maven:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>dev.pragmastat<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>pragmastat<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.2.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>Install from Maven Central Repository via Gradle:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>implementation</span><span class=w> </span><span class=err>&#39;</span><span class=n>dev</span><span class=p>.</span><span class=na>pragmastat</span><span class=p>:</span><span class=n>pragmastat</span><span class=p>:</span><span class=n>3</span><span class=p>.</span><span class=na>2</span><span class=p>.</span><span class=na>2</span><span class=err>&#39;</span><span class=w>
</span></span></span></code></pre></div><p>Install from Maven Central Repository via Gradle (Kotlin):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>implementation</span><span class=p>(</span><span class=s2>&#34;dev.pragmastat:pragmastat:3.2.2&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Source code: <a href=https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/kt>https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/kt</a></p><p>Pragmastat on Maven Central Repository: <a href=https://central.sonatype.com/artifact/dev.pragmastat/pragmastat/overview>https://central.sonatype.com/artifact/dev.pragmastat/pragmastat/overview</a></p><p>Demo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>package</span> <span class=nn>dev.pragmastat.demo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>import</span> <span class=nn>dev.pragmastat.*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>x</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>0.0</span><span class=p>,</span> <span class=m>2.0</span><span class=p>,</span> <span class=m>4.0</span><span class=p>,</span> <span class=m>6.0</span><span class=p>,</span> <span class=m>8.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>center</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>center</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>+</span> <span class=m>10</span> <span class=p>}))</span> <span class=c1>// 14
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>center</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>3</span> <span class=p>}))</span> <span class=c1>// 12
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>+</span> <span class=m>10</span> <span class=p>}))</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>}))</span> <span class=c1>// 8
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>relSpread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>relSpread</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>5</span> <span class=p>}))</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>y</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>10.0</span><span class=p>,</span> <span class=m>12.0</span><span class=p>,</span> <span class=m>14.0</span><span class=p>,</span> <span class=m>16.0</span><span class=p>,</span> <span class=m>18.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1>// -10
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1>// 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>+</span> <span class=m>7</span> <span class=p>},</span> <span class=n>y</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>+</span> <span class=m>3</span> <span class=p>}))</span> <span class=c1>// -6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>},</span> <span class=n>y</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>}))</span> <span class=c1>// -20
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1>// 10
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>1.0</span><span class=p>,</span> <span class=m>2.0</span><span class=p>,</span> <span class=m>4.0</span><span class=p>,</span> <span class=m>8.0</span><span class=p>,</span> <span class=m>16.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>2.0</span><span class=p>,</span> <span class=m>4.0</span><span class=p>,</span> <span class=m>8.0</span><span class=p>,</span> <span class=m>16.0</span><span class=p>,</span> <span class=m>32.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1>// 0.5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>},</span> <span class=n>y</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>5</span> <span class=p>}))</span> <span class=c1>// 0.2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>0.0</span><span class=p>,</span> <span class=m>3.0</span><span class=p>,</span> <span class=m>6.0</span><span class=p>,</span> <span class=m>9.0</span><span class=p>,</span> <span class=m>12.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=m>0.0</span><span class=p>,</span> <span class=m>2.0</span><span class=p>,</span> <span class=m>4.0</span><span class=p>,</span> <span class=m>6.0</span><span class=p>,</span> <span class=m>8.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=n>y</span><span class=p>))</span> <span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>avgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>avgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>avgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>},</span> <span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>3</span> <span class=p>}))</span> <span class=c1>// 15
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>avgSpread</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>avgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>},</span> <span class=n>y</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>}))</span> <span class=c1>// 10
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>avgSpread</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>println</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span> <span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>+</span> <span class=m>5</span> <span class=p>},</span> <span class=n>y</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>+</span> <span class=m>5</span> <span class=p>}))</span> <span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>},</span> <span class=n>y</span><span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=p>*</span> <span class=m>2</span> <span class=p>}))</span> <span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>println</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>))</span> <span class=c1>// -0.4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p><span id=rs></span></p><h2 id=86-rust>§8.6. Rust</h2><p>Install from crates.io via cargo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cargo add pragmastat@3.2.2
</span></span></code></pre></div><p>Install from crates.io via <code>Cargo.toml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>pragmastat</span> <span class=p>=</span> <span class=s2>&#34;3.2.2&#34;</span>
</span></span></code></pre></div><p>Source code: <a href=https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/rs>https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/rs</a></p><p>Pragmastat on crates.io: <a href=https://crates.io/crates/pragmastat>https://crates.io/crates/pragmastat</a></p><p>Demo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>pragmastat</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>print</span><span class=p>(</span><span class=n>result</span>: <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>f64</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>add</span><span class=p>(</span><span class=n>x</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>f64</span><span class=p>],</span><span class=w> </span><span class=n>val</span>: <span class=kt>f64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>f64</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=p>.</span><span class=n>iter</span><span class=p>().</span><span class=n>map</span><span class=p>(</span><span class=o>|</span><span class=n>v</span><span class=o>|</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>val</span><span class=p>).</span><span class=n>collect</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>multiply</span><span class=p>(</span><span class=n>x</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>f64</span><span class=p>],</span><span class=w> </span><span class=n>val</span>: <span class=kt>f64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>f64</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span><span class=p>.</span><span class=n>iter</span><span class=p>().</span><span class=n>map</span><span class=p>(</span><span class=o>|</span><span class=n>v</span><span class=o>|</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>val</span><span class=p>).</span><span class=n>collect</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mf>0.0</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>,</span><span class=w> </span><span class=mf>4.0</span><span class=p>,</span><span class=w> </span><span class=mf>6.0</span><span class=p>,</span><span class=w> </span><span class=mf>8.0</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>center</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>center</span><span class=p>(</span><span class=o>&amp;</span><span class=n>add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>10.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 14
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>center</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>3.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 12
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>10.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 8
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>rel_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>rel_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>5.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mf>10.0</span><span class=p>,</span><span class=w> </span><span class=mf>12.0</span><span class=p>,</span><span class=w> </span><span class=mf>14.0</span><span class=p>,</span><span class=w> </span><span class=mf>16.0</span><span class=p>,</span><span class=w> </span><span class=mf>18.0</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=c1>// -10
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=o>&amp;</span><span class=n>add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>7.0</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=mf>3.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// -6
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// -20
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 10
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mf>1.0</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>,</span><span class=w> </span><span class=mf>4.0</span><span class=p>,</span><span class=w> </span><span class=mf>8.0</span><span class=p>,</span><span class=w> </span><span class=mf>16.0</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mf>2.0</span><span class=p>,</span><span class=w> </span><span class=mf>4.0</span><span class=p>,</span><span class=w> </span><span class=mf>8.0</span><span class=p>,</span><span class=w> </span><span class=mf>16.0</span><span class=p>,</span><span class=w> </span><span class=mf>32.0</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=c1>// 0.5
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>ratio</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=mf>5.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 0.2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mf>0.0</span><span class=p>,</span><span class=w> </span><span class=mf>3.0</span><span class=p>,</span><span class=w> </span><span class=mf>6.0</span><span class=p>,</span><span class=w> </span><span class=mf>9.0</span><span class=p>,</span><span class=w> </span><span class=mf>12.0</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mf>0.0</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>,</span><span class=w> </span><span class=mf>4.0</span><span class=p>,</span><span class=w> </span><span class=mf>6.0</span><span class=p>,</span><span class=w> </span><span class=mf>8.0</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=c1>// 4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 6
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>3.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 15
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 10
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>shift</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>avg_spread</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=c1>// 5
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>));</span><span class=w> </span><span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=o>&amp;</span><span class=n>add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>5.0</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=mf>5.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=n>multiply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=mf>2.0</span><span class=p>)));</span><span class=w> </span><span class=c1>// 0.4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=n>disparity</span><span class=p>(</span><span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>));</span><span class=w> </span><span class=c1>// -0.4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><span id=go></span></p><h2 id=87-go>§8.7. Go</h2><p>Install from GitHub:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get github.com/AndreyAkinshin/pragmastat/go/v3@v3.2.2
</span></span></code></pre></div><p>Source code: <a href=https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/go>https://github.com/AndreyAkinshin/pragmastat/tree/v3.2.2/go</a></p><p>Demo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>pragmastat</span><span class=w> </span><span class=s>&#34;github.com/AndreyAkinshin/pragmastat/go/v3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nx>must</span><span class=p>[</span><span class=nx>T</span><span class=w> </span><span class=kt>any</span><span class=p>](</span><span class=nx>val</span><span class=w> </span><span class=nx>T</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=nx>T</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nb>print</span><span class=p>(</span><span class=nx>val</span><span class=w> </span><span class=kt>float64</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nf>must</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nx>x</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>,</span><span class=w> </span><span class=nx>val</span><span class=w> </span><span class=kt>float64</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>result</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>float64</span><span class=p>,</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>x</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=p>,</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>x</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>,</span><span class=w> </span><span class=nx>val</span><span class=w> </span><span class=kt>float64</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>result</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>float64</span><span class=p>,</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>x</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=p>,</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>x</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>v</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>x</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Center</span><span class=p>(</span><span class=nx>x</span><span class=p>))</span><span class=w>              </span><span class=c1>// 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Center</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>)))</span><span class=w>     </span><span class=c1>// 14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Center</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>)))</span><span class=w> </span><span class=c1>// 12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Spread</span><span class=p>(</span><span class=nx>x</span><span class=p>))</span><span class=w>              </span><span class=c1>// 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Spread</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>)))</span><span class=w>     </span><span class=c1>// 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Spread</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)))</span><span class=w> </span><span class=c1>// 8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>RelSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>))</span><span class=w>              </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>RelSpread</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>)))</span><span class=w> </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>y</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>{</span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>12</span><span class=p>,</span><span class=w> </span><span class=mi>14</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=mi>18</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Shift</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>y</span><span class=p>))</span><span class=w>                           </span><span class=c1>// -10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Shift</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>x</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Shift</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>),</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>)))</span><span class=w>           </span><span class=c1>// -6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Shift</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=nf>multiply</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)))</span><span class=w> </span><span class=c1>// -20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Shift</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=nx>x</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>x</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>y</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>{</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=mi>32</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Ratio</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>y</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 0.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Ratio</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>x</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Ratio</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=nf>multiply</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>)))</span><span class=w> </span><span class=c1>// 0.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>x</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=p>,</span><span class=w> </span><span class=mi>12</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>y</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=kt>float64</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Spread</span><span class=p>(</span><span class=nx>x</span><span class=p>))</span><span class=w> </span><span class=c1>// 6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Spread</span><span class=p>(</span><span class=nx>y</span><span class=p>))</span><span class=w> </span><span class=c1>// 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>AvgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>y</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>AvgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>x</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>AvgSpread</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>)))</span><span class=w> </span><span class=c1>// 15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>AvgSpread</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=nx>x</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>AvgSpread</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=nf>multiply</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)))</span><span class=w> </span><span class=c1>// 10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Shift</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>y</span><span class=p>))</span><span class=w>     </span><span class=c1>// 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>AvgSpread</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>y</span><span class=p>))</span><span class=w> </span><span class=c1>// 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Disparity</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>y</span><span class=p>))</span><span class=w>                           </span><span class=c1>// 0.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Disparity</span><span class=p>(</span><span class=nf>add</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>),</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>)))</span><span class=w>           </span><span class=c1>// 0.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Disparity</span><span class=p>(</span><span class=nf>multiply</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=nf>multiply</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)))</span><span class=w> </span><span class=c1>// 0.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>print</span><span class=p>(</span><span class=nx>pragmastat</span><span class=p>.</span><span class=nf>Disparity</span><span class=p>(</span><span class=nx>y</span><span class=p>,</span><span class=w> </span><span class=nx>x</span><span class=p>))</span><span class=w>                           </span><span class=c1>// -0.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=9-reference-tests>§9. Reference Tests</h1><h2 id=91-motivation>§9.1. Motivation</h2><p>The toolkit maintains seven implementations across different programming languages: Python, TypeScript, R, C#, Kotlin, Rust, and Go.
Each implementation must produce identical numerical results for all estimators.
Maintaining correctness across this diverse set of languages requires a rigorous reference test suite.</p><p>Reference tests serve three critical purposes:</p><ul><li><strong>Cross-language validation.</strong> All implementations must pass identical test cases, ensuring consistent behavior regardless of language choice.</li><li><strong>Regression prevention.</strong> Changes to any implementation can be validated against the reference outputs to detect unintended modifications.</li><li><strong>Implementation guidance.</strong> The test cases provide concrete examples that guide developers in implementing the toolkit in new languages.</li></ul><p>The test design follows established quality assurance principles:</p><ul><li><strong>Minimal sufficiency.</strong> The test set should be as small as possible while still providing high confidence in correctness.
Smaller test suites reduce CI execution time and simplify maintenance.</li><li><strong>Comprehensive coverage.</strong> Tests must cover both typical use cases and edge cases that expose potential implementation errors.</li><li><strong>Deterministic reproducibility.</strong> All random test cases use fixed seeds to ensure identical results across all platforms and implementations.</li></ul><p>The test suite balances three categories:</p><ul><li><strong>Canonical cases</strong> use deterministic, easily verified inputs like natural number sequences.
These provide intuitive examples where correct outputs can be validated by inspection.</li><li><strong>Edge cases</strong> test boundary conditions such as single-element samples, zero values, and minimum viable sample sizes.
These expose off-by-one errors, division by zero, and other common implementation mistakes.</li><li><strong>Fuzzy tests</strong> use controlled random number generation to explore the input space beyond hand-crafted examples.
Random tests catch issues that might not be apparent from simple deterministic cases.</li></ul><p>The C# implementation serves as the reference generator.
All test cases are defined programmatically, executed to produce expected outputs, and serialized to JSON.
Other implementations load these JSON files and verify that their estimators produce matching results within a given numerical tolerance.</p><h2 id=92-center>§9.2. Center</h2>$$
\Center(\x) = \underset{1 \leq i \leq j \leq n}{\Median} \left(\frac{x_i + x_j}{2} \right)
$$<p>The $\Center$ test suite contains 38 correctness test cases stored in the repository (24 original + 14 unsorted), plus 1 performance test that should be implemented manually (see §Test Framework).</p><p><strong>Demo examples</strong> ($n = 5$) — from manual introduction, validating properties:</p><ul><li><code>demo-1</code>: $\x = (0, 2, 4, 6, 8)$, expected output: $4$ (base case)</li><li><code>demo-2</code>: $\x = (10, 12, 14, 16, 18)$ (= demo-1 + 10), expected output: $14$ (location equivariance)</li><li><code>demo-3</code>: $\x = (0, 6, 12, 18, 24)$ (= 3 × demo-1), expected output: $12$ (scale equivariance)</li></ul><p><strong>Natural sequences</strong> ($n = 1, 2, 3, 4$) — canonical happy path examples:</p><ul><li><code>natural-1</code>: $\x = (1)$, expected output: $1$</li><li><code>natural-2</code>: $\x = (1, 2)$, expected output: $1.5$</li><li><code>natural-3</code>: $\x = (1, 2, 3)$, expected output: $2$</li><li><code>natural-4</code>: $\x = (1, 2, 3, 4)$, expected output: $2.5$ (smallest even size with rich structure)</li></ul><p><strong>Negative values</strong> ($n = 3$) — sign handling validation:</p><ul><li><code>negative-3</code>: $\x = (-3, -2, -1)$, expected output: $-2$</li></ul><p><strong>Zero values</strong> ($n = 1, 2$) — edge case testing with zeros:</p><ul><li><code>zeros-1</code>: $\x = (0)$, expected output: $0$</li><li><code>zeros-2</code>: $\x = (0, 0)$, expected output: $0$</li></ul><p><strong>Additive distribution</strong> ($n = 5, 10, 30$) — fuzzy testing with $\Additive(10, 1)$:</p><ul><li><code>additive-5</code>, <code>additive-10</code>, <code>additive-30</code>: random samples generated with seed 0</li></ul><p><strong>Uniform distribution</strong> ($n = 5, 100$) — fuzzy testing with $\Uniform(0, 1)$:</p><ul><li><code>uniform-5</code>, <code>uniform-100</code>: random samples generated with seed 1</li></ul><p>The random samples validate that $\Center$ performs correctly on realistic distributions at various sample sizes.
The progression from small ($n = 5$) to large ($n = 100$) samples helps identify issues that only manifest at specific scales.</p><p><strong>Algorithm stress tests</strong> — edge cases for fast algorithm implementation:</p><ul><li><code>duplicates-5</code>: $\x = (3, 3, 3, 3, 3)$ (all identical, stress stall handling)</li><li><code>duplicates-10</code>: $\x = (1, 1, 1, 2, 2, 2, 3, 3, 3, 3)$ (many duplicates, stress tie-breaking)</li><li><code>parity-odd-7</code>: $\x = (1, 2, 3, 4, 5, 6, 7)$ (odd sample size for odd total pairs)</li><li><code>parity-even-6</code>: $\x = (1, 2, 3, 4, 5, 6)$ (even sample size for even total pairs)</li><li><code>parity-odd-49</code>: 49-element sequence $(1, 2, \ldots, 49)$ (large odd, 1225 pairs)</li><li><code>parity-even-50</code>: 50-element sequence $(1, 2, \ldots, 50)$ (large even, 1275 pairs)</li></ul><p><strong>Extreme values</strong> — numerical stability and range tests:</p><ul><li><code>extreme-large-5</code>: $\x = (1e8, 2e8, 3e8, 4e8, 5e8)$ (very large values)</li><li><code>extreme-small-5</code>: $\x = (1e{-}8, 2e{-}8, 3e{-}8, 4e{-}8, 5e{-}8)$ (very small positive values)</li><li><code>extreme-wide-5</code>: $\x = (0.001, 1, 100, 1000, 1000000)$ (wide range, tests precision)</li></ul><p><strong>Unsorted tests</strong> — verify sorting correctness (14 tests):</p><ul><li><code>unsorted-reverse-{n}</code> for $n \in \{2, 3, 4, 5, 7\}$: reverse sorted natural sequences (5 tests)</li><li><code>unsorted-shuffle-3</code>: $\x = (2, 1, 3)$ (middle element first)</li><li><code>unsorted-shuffle-4</code>: $\x = (3, 1, 4, 2)$ (interleaved)</li><li><code>unsorted-shuffle-5</code>: $\x = (5, 2, 4, 1, 3)$ (complex shuffle)</li><li><code>unsorted-last-first-5</code>: $\x = (5, 1, 2, 3, 4)$ (last moved to first)</li><li><code>unsorted-first-last-5</code>: $\x = (2, 3, 4, 5, 1)$ (first moved to last)</li><li><code>unsorted-duplicates-mixed-5</code>: $\x = (3, 3, 3, 3, 3)$ (all identical, any order)</li><li><code>unsorted-duplicates-unsorted-10</code>: $\x = (3, 1, 2, 3, 1, 3, 2, 1, 3, 2)$ (duplicates mixed)</li><li><code>unsorted-extreme-large-unsorted-5</code>: $\x = (5e8, 1e8, 4e8, 2e8, 3e8)$ (large values unsorted)</li><li><code>unsorted-parity-odd-reverse-7</code>: $\x = (7, 6, 5, 4, 3, 2, 1)$ (odd size reverse)</li></ul><p>These tests ensure implementations correctly sort input data before computing pairwise averages.
The variety of shuffle patterns (reverse, rotation, interleaving, single element displacement) catches common sorting bugs.</p><p><strong>Performance test</strong> — validates the fast $O(n \log n)$ algorithm:</p><ul><li><strong>Input</strong>: $\x = (1, 2, 3, \ldots, 100000)$</li><li><strong>Expected output</strong>: $50000.5$</li><li><strong>Time constraint</strong>: Must complete in under 5 seconds</li><li><strong>Purpose</strong>: Ensures that the implementation uses the efficient algorithm rather than materializing all $\binom{n+1}{2} \approx 5$ billion pairwise averages</li></ul><p>This test case is not stored in the repository because it generates a large JSON file (approximately 1.5 MB).
Each language implementation should manually implement this test with the hardcoded expected result.</p><h2 id=93-spread>§9.3. Spread</h2>$$
\Spread(\x) = \underset{1 \leq i < j \leq n}{\Median} |x_i - x_j|
$$<p>The $\Spread$ test suite contains 38 correctness test cases stored in the repository (24 original + 14 unsorted), plus 1 performance test that should be implemented manually (see §Test Framework).</p><p><strong>Demo examples</strong> ($n = 5$) — from manual introduction, validating properties:</p><ul><li><code>demo-1</code>: $\x = (0, 2, 4, 6, 8)$, expected output: $4$ (base case)</li><li><code>demo-2</code>: $\x = (10, 12, 14, 16, 18)$ (= demo-1 + 10), expected output: $4$ (location invariance)</li><li><code>demo-3</code>: $\x = (0, 4, 8, 12, 16)$ (= 2 × demo-1), expected output: $8$ (scale equivariance)</li></ul><p><strong>Natural sequences</strong> ($n = 1, 2, 3, 4$):</p><ul><li><code>natural-1</code>: $\x = (1)$, expected output: $0$ (single element has zero dispersion)</li><li><code>natural-2</code>: $\x = (1, 2)$, expected output: $1$</li><li><code>natural-3</code>: $\x = (1, 2, 3)$, expected output: $1$</li><li><code>natural-4</code>: $\x = (1, 2, 3, 4)$, expected output: $1.5$ (smallest even size with rich structure)</li></ul><p><strong>Negative values</strong> ($n = 3$) — sign handling validation:</p><ul><li><code>negative-3</code>: $\x = (-3, -2, -1)$, expected output: $1$</li></ul><p><strong>Zero values</strong> ($n = 1, 2$):</p><ul><li><code>zeros-1</code>: $\x = (0)$, expected output: $0$</li><li><code>zeros-2</code>: $\x = (0, 0)$, expected output: $0$</li></ul><p><strong>Additive distribution</strong> ($n = 5, 10, 30$) — $\Additive(10, 1)$:</p><ul><li><code>additive-5</code>, <code>additive-10</code>, <code>additive-30</code>: random samples generated with seed 0</li></ul><p><strong>Uniform distribution</strong> ($n = 5, 100$) — $\Uniform(0, 1)$:</p><ul><li><code>uniform-5</code>, <code>uniform-100</code>: random samples generated with seed 1</li></ul><p>The natural sequence cases validate the basic pairwise difference calculation.
The zero cases confirm that constant samples correctly produce zero spread.</p><p><strong>Algorithm stress tests</strong> — edge cases for fast algorithm implementation:</p><ul><li><code>duplicates-5</code>: $\x = (3, 3, 3, 3, 3)$ (all identical, expected output: $0$)</li><li><code>duplicates-10</code>: $\x = (1, 1, 1, 2, 2, 2, 3, 3, 3, 3)$ (many duplicates, stress tie-breaking)</li><li><code>parity-odd-7</code>: $\x = (1, 2, 3, 4, 5, 6, 7)$ (odd sample size, 21 differences)</li><li><code>parity-even-6</code>: $\x = (1, 2, 3, 4, 5, 6)$ (even sample size, 15 differences)</li><li><code>parity-odd-49</code>: 49-element sequence $(1, 2, \ldots, 49)$ (large odd, 1176 differences)</li><li><code>parity-even-50</code>: 50-element sequence $(1, 2, \ldots, 50)$ (large even, 1225 differences)</li></ul><p><strong>Extreme values</strong> — numerical stability and range tests:</p><ul><li><code>extreme-large-5</code>: $\x = (1e8, 2e8, 3e8, 4e8, 5e8)$ (very large values)</li><li><code>extreme-small-5</code>: $\x = (1e{-}8, 2e{-}8, 3e{-}8, 4e{-}8, 5e{-}8)$ (very small positive values)</li><li><code>extreme-wide-5</code>: $\x = (0.001, 1, 100, 1000, 1000000)$ (wide range, tests precision)</li></ul><p><strong>Unsorted tests</strong> — verify sorting correctness (14 tests):</p><ul><li><code>unsorted-reverse-{n}</code> for $n \in \{2, 3, 4, 5, 7\}$: reverse sorted natural sequences (5 tests)</li><li><code>unsorted-shuffle-3</code>: $\x = (3, 1, 2)$ (rotated)</li><li><code>unsorted-shuffle-4</code>: $\x = (4, 2, 1, 3)$ (mixed order)</li><li><code>unsorted-shuffle-5</code>: $\x = (5, 1, 3, 2, 4)$ (partial shuffle)</li><li><code>unsorted-last-first-5</code>: $\x = (5, 1, 2, 3, 4)$ (last moved to first)</li><li><code>unsorted-first-last-5</code>: $\x = (2, 3, 4, 5, 1)$ (first moved to last)</li><li><code>unsorted-duplicates-mixed-5</code>: $\x = (3, 3, 3, 3, 3)$ (all identical)</li><li><code>unsorted-duplicates-unsorted-10</code>: $\x = (2, 3, 1, 3, 2, 1, 2, 3, 1, 3)$ (duplicates mixed)</li><li><code>unsorted-extreme-wide-unsorted-5</code>: $\x = (1000, 0.001, 1000000, 100, 1)$ (wide range unsorted)</li><li><code>unsorted-negative-unsorted-5</code>: $\x = (-1, -5, -2, -4, -3)$ (negative unsorted)</li></ul><p>These tests verify that implementations correctly sort input before computing pairwise differences.
Since $\Spread$ uses absolute differences, order-dependent bugs would manifest differently than in $\Center$.</p><p><strong>Performance test</strong> — validates the fast $O(n \log n)$ algorithm:</p><ul><li><strong>Input</strong>: $\x = (1, 2, 3, \ldots, 100000)$</li><li><strong>Expected output</strong>: $29290$</li><li><strong>Time constraint</strong>: Must complete in under 5 seconds</li><li><strong>Purpose</strong>: Ensures that the implementation uses the efficient algorithm rather than materializing all $\binom{n}{2} \approx 5$ billion pairwise differences</li></ul><p>This test case is not stored in the repository because it generates a large JSON file (approximately 1.5 MB).
Each language implementation should manually implement this test with the hardcoded expected result.</p><h2 id=94-relspread>§9.4. RelSpread</h2>$$
\RelSpread(\x) = \frac{\Spread(\x)}{\left| \Center(\x) \right|}
$$<p>The $\RelSpread$ test suite contains 25 test cases (15 original + 10 unsorted) focusing on relative dispersion.</p><p><strong>Demo examples</strong> ($n = 5$) — from manual introduction, validating properties:</p><ul><li><code>demo-1</code>: $\x = (0, 2, 4, 6, 8)$, expected output: $1$ (base case)</li><li><code>demo-2</code>: $\x = (0, 10, 20, 30, 40)$ (= 5 × demo-1), expected output: $1$ (scale invariance)</li></ul><p><strong>Natural sequences</strong> ($n = 1, 2, 3, 4$):</p><ul><li><code>natural-1</code>: $\x = (1)$, expected output: $0$</li><li><code>natural-2</code>: $\x = (1, 2)$, expected output: $\approx 0.667$</li><li><code>natural-3</code>: $\x = (1, 2, 3)$, expected output: $0.5$</li><li><code>natural-4</code>: $\x = (1, 2, 3, 4)$, expected output: $0.6$ (validates composite with even size)</li></ul><p><strong>Negative values</strong> ($n = 3$) — validates absolute value in denominator:</p><ul><li><code>negative-3</code>: $\x = (-3, -2, -1)$, expected output: $0.5$</li></ul><p><strong>Uniform distribution</strong> ($n = 5, 10, 20, 30, 100$) — $\Uniform(0, 1)$:</p><ul><li><code>uniform-5</code>, <code>uniform-10</code>, <code>uniform-20</code>, <code>uniform-30</code>, <code>uniform-100</code>: random samples generated with seed 0</li></ul><p>The uniform distribution tests span multiple sample sizes to verify that $\RelSpread$ correctly normalizes dispersion.
The absence of zero-value tests reflects the domain constraint requiring $\Center(\x) \neq 0$.</p><p><strong>Composite estimator stress tests</strong> — edge cases specific to division operation:</p><ul><li><code>composite-small-center</code>: $\x = (0.001, 0.002, 0.003, 0.004, 0.005)$ (small center, tests division stability)</li><li><code>composite-large-spread</code>: $\x = (1, 100, 200, 300, 1000)$ (large spread relative to center)</li><li><code>composite-extreme-ratio</code>: $\x = (1, 1.0001, 1.0002, 1.0003, 1.0004)$ (tiny spread, tests precision)</li></ul><p><strong>Unsorted tests</strong> — verify sorting for composite estimator (10 tests):</p><ul><li><code>unsorted-reverse-{n}</code> for $n \in \{3, 4, 5\}$: reverse sorted natural sequences (3 tests)</li><li><code>unsorted-shuffle-4</code>: $\x = (4, 1, 3, 2)$ (mixed order)</li><li><code>unsorted-shuffle-5</code>: $\x = (5, 3, 1, 4, 2)$ (complex shuffle)</li><li><code>unsorted-negative-unsorted-3</code>: $\x = (-1, -3, -2)$ (negative unsorted)</li><li><code>unsorted-demo-unsorted-5</code>: $\x = (8, 0, 4, 2, 6)$ (demo case unsorted)</li><li><code>unsorted-composite-small-unsorted</code>: $\x = (0.005, 0.001, 0.003, 0.002, 0.004)$ (small center unsorted)</li><li><code>unsorted-composite-large-unsorted</code>: $\x = (1000, 1, 300, 100, 200)$ (large spread unsorted)</li><li><code>unsorted-extreme-ratio-unsorted-4</code>: $\x = (1.0003, 1, 1.0002, 1.0001)$ (extreme ratio unsorted)</li></ul><p>Since $\RelSpread$ combines both $\Center$ and $\Spread$, these tests verify that sorting works correctly for composite estimators.</p><h2 id=95-shift>§9.5. Shift</h2>$$
\Shift(\x, \y) = \underset{1 \leq i \leq n,\,\, 1 \leq j \leq m}{\Median} \left(x_i - y_j \right)
$$<p>The $\Shift$ test suite contains 60 correctness test cases stored in the repository (42 original + 18 unsorted), plus 1 performance test that should be implemented manually (see §Test Framework).</p><p><strong>Demo examples</strong> ($n = m = 5$) — from manual introduction, validating properties:</p><ul><li><code>demo-1</code>: $\x = (0, 2, 4, 6, 8)$, $\y = (10, 12, 14, 16, 18)$, expected output: $-10$ (base case)</li><li><code>demo-2</code>: $\x = (0, 2, 4, 6, 8)$, $\y = (0, 2, 4, 6, 8)$, expected output: $0$ (identity property)</li><li><code>demo-3</code>: $\x = (7, 9, 11, 13, 15)$, $\y = (13, 15, 17, 19, 21)$ (= demo-1 + [7,3]), expected output: $-6$ (location equivariance)</li><li><code>demo-4</code>: $\x = (0, 4, 8, 12, 16)$, $\y = (20, 24, 28, 32, 36)$ (= 2 × demo-1), expected output: $-20$ (scale equivariance)</li><li><code>demo-5</code>: $\x = (10, 12, 14, 16, 18)$, $\y = (0, 2, 4, 6, 8)$ (= reversed demo-1), expected output: $10$ (anti-symmetry)</li></ul><p><strong>Natural sequences</strong> ($[n, m] \in \{1, 2, 3\} \times \{1, 2, 3\}$) — 9 combinations:</p><ul><li><code>natural-1-1</code>: $\x = (1)$, $\y = (1)$, expected output: $0$</li><li><code>natural-1-2</code>: $\x = (1)$, $\y = (1, 2)$, expected output: $-0.5$</li><li><code>natural-1-3</code>: $\x = (1)$, $\y = (1, 2, 3)$, expected output: $-1$</li><li><code>natural-2-1</code>: $\x = (1, 2)$, $\y = (1)$, expected output: $0.5$</li><li><code>natural-2-2</code>: $\x = (1, 2)$, $\y = (1, 2)$, expected output: $0$</li><li><code>natural-2-3</code>: $\x = (1, 2)$, $\y = (1, 2, 3)$, expected output: $-0.5$</li><li><code>natural-3-1</code>: $\x = (1, 2, 3)$, $\y = (1)$, expected output: $1$</li><li><code>natural-3-2</code>: $\x = (1, 2, 3)$, $\y = (1, 2)$, expected output: $0.5$</li><li><code>natural-3-3</code>: $\x = (1, 2, 3)$, $\y = (1, 2, 3)$, expected output: $0$</li></ul><p><strong>Negative values</strong> ($[n, m] = [2, 2]$) — sign handling validation:</p><ul><li><code>negative-2-2</code>: $\x = (-2, -1)$, $\y = (-2, -1)$, expected output: $0$</li></ul><p><strong>Mixed-sign values</strong> ($[n, m] = [2, 2]$) — validates anti-symmetry across zero:</p><ul><li><code>mixed-2-2</code>: $\x = (-1, 1)$, $\y = (-1, 1)$, expected output: $0$</li></ul><p><strong>Zero values</strong> ($[n, m] \in \{1, 2\} \times \{1, 2\}$) — 4 combinations:</p><ul><li><code>zeros-1-1</code>, <code>zeros-1-2</code>, <code>zeros-2-1</code>, <code>zeros-2-2</code>: all produce output $0$</li></ul><p><strong>Additive distribution</strong> ($[n, m] \in \{5, 10, 30\} \times \{5, 10, 30\}$) — 9 combinations with $\Additive(10, 1)$:</p><ul><li><code>additive-5-5</code>, <code>additive-5-10</code>, <code>additive-5-30</code></li><li><code>additive-10-5</code>, <code>additive-10-10</code>, <code>additive-10-30</code></li><li><code>additive-30-5</code>, <code>additive-30-10</code>, <code>additive-30-30</code></li><li>Random generation: $\x$ uses seed 0, $\y$ uses seed 1</li></ul><p><strong>Uniform distribution</strong> ($[n, m] \in \{5, 100\} \times \{5, 100\}$) — 4 combinations with $\Uniform(0, 1)$:</p><ul><li><code>uniform-5-5</code>, <code>uniform-5-100</code>, <code>uniform-100-5</code>, <code>uniform-100-100</code></li><li>Random generation: $\x$ uses seed 2, $\y$ uses seed 3</li></ul><p>The natural sequences validate anti-symmetry ($\Shift(\x, \y) = -\Shift(\y, \x)$) and the identity property ($\Shift(\x, \x) = 0$).
The asymmetric size combinations test the two-sample algorithm with unbalanced inputs.</p><p><strong>Algorithm stress tests</strong> — edge cases for fast binary search algorithm:</p><ul><li><code>duplicates-5-5</code>: $\x = (3, 3, 3, 3, 3)$, $\y = (3, 3, 3, 3, 3)$ (all identical, expected output: $0$)</li><li><code>duplicates-10-10</code>: $\x = (1, 1, 2, 2, 3, 3, 4, 4, 5, 5)$, $\y = (1, 1, 2, 2, 3, 3, 4, 4, 5, 5)$ (many duplicates)</li><li><code>parity-odd-7-7</code>: $\x = (1, 2, 3, 4, 5, 6, 7)$, $\y = (1, 2, 3, 4, 5, 6, 7)$ (odd sizes, 49 differences, expected output: $0$)</li><li><code>parity-even-6-6</code>: $\x = (1, 2, 3, 4, 5, 6)$, $\y = (1, 2, 3, 4, 5, 6)$ (even sizes, 36 differences, expected output: $0$)</li><li><code>parity-asymmetric-7-6</code>: $\x = (1, 2, 3, 4, 5, 6, 7)$, $\y = (1, 2, 3, 4, 5, 6)$ (mixed parity, 42 differences)</li><li><code>parity-large-49-50</code>: $\x = (1, 2, \ldots, 49)$, $\y = (1, 2, \ldots, 50)$ (large asymmetric, 2450 differences)</li></ul><p><strong>Extreme asymmetry</strong> — tests with very unbalanced sample sizes:</p><ul><li><code>asymmetry-1-100</code>: $\x = (50)$, $\y = (1, 2, \ldots, 100)$ (single vs many, 100 differences)</li><li><code>asymmetry-2-50</code>: $\x = (10, 20)$, $\y = (1, 2, \ldots, 50)$ (tiny vs medium, 100 differences)</li><li><code>asymmetry-constant-varied</code>: $\x = (5, 5, 5, 5, 5)$, $\y = (1, 2, 3, 4, 5, 6, 7, 8, 9, 10)$ (constant vs varied)</li></ul><p><strong>Unsorted tests</strong> — verify independent sorting of each sample (18 tests):</p><ul><li><code>unsorted-x-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4), (5,5)\}$: X unsorted (reversed), Y sorted (3 tests)</li><li><code>unsorted-y-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4), (5,5)\}$: X sorted, Y unsorted (reversed) (3 tests)</li><li><code>unsorted-both-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4), (5,5)\}$: both unsorted (reversed) (3 tests)</li><li><code>unsorted-reverse-3-3</code>: $\x = (3, 2, 1)$, $\y = (3, 2, 1)$ (both reversed)</li><li><code>unsorted-x-shuffle-3-3</code>: $\x = (2, 1, 3)$, $\y = (1, 2, 3)$ (X shuffled, Y sorted)</li><li><code>unsorted-y-shuffle-3-3</code>: $\x = (1, 2, 3)$, $\y = (3, 1, 2)$ (X sorted, Y shuffled)</li><li><code>unsorted-both-shuffle-4-4</code>: $\x = (3, 1, 4, 2)$, $\y = (4, 2, 1, 3)$ (both shuffled)</li><li><code>unsorted-duplicates-mixed-5-5</code>: $\x = (3, 3, 3, 3, 3)$, $\y = (3, 3, 3, 3, 3)$ (all identical)</li><li><code>unsorted-x-unsorted-duplicates</code>: $\x = (2, 1, 3, 2, 1)$, $\y = (1, 1, 2, 2, 3)$ (X has unsorted duplicates)</li><li><code>unsorted-y-unsorted-duplicates</code>: $\x = (1, 1, 2, 2, 3)$, $\y = (3, 2, 1, 3, 2)$ (Y has unsorted duplicates)</li><li><code>unsorted-asymmetric-unsorted-2-5</code>: $\x = (2, 1)$, $\y = (5, 2, 4, 1, 3)$ (asymmetric sizes, both unsorted)</li><li><code>unsorted-negative-unsorted-3-3</code>: $\x = (-1, -3, -2)$, $\y = (-2, -3, -1)$ (negative unsorted)</li></ul><p>These tests are critical for two-sample estimators because they verify that $\x$ and $\y$ are sorted <strong>independently</strong>.
The variety includes cases where only one sample is unsorted, ensuring implementations don&rsquo;t incorrectly assume pre-sorted input or sort samples together.</p><p><strong>Performance test</strong> — validates the fast $O((m+n) \log L)$ binary search algorithm:</p><ul><li><strong>Input</strong>: $\x = (1, 2, 3, \ldots, 100000)$, $\y = (1, 2, 3, \ldots, 100000)$</li><li><strong>Expected output</strong>: $0$</li><li><strong>Time constraint</strong>: Must complete in under 5 seconds</li><li><strong>Purpose</strong>: Ensures that the implementation uses the efficient algorithm rather than materializing all $mn = 10$ billion pairwise differences</li></ul><p>This test case is not stored in the repository because it generates a large JSON file (approximately 1.5 MB).
Each language implementation should manually implement this test with the hardcoded expected result.</p><h2 id=96-ratio>§9.6. Ratio</h2>$$
\Ratio(\x, \y) = \underset{1 \leq i \leq n, 1 \leq j \leq m}{\Median} \left( \dfrac{x_i}{y_j} \right)
$$<p>The $\Ratio$ test suite contains 37 test cases (25 original + 12 unsorted), excluding zero values due to division constraints.</p><p><strong>Demo examples</strong> ($n = m = 5$) — from manual introduction, validating properties:</p><ul><li><code>demo-1</code>: $\x = (1, 2, 4, 8, 16)$, $\y = (2, 4, 8, 16, 32)$, expected output: $0.5$ (base case)</li><li><code>demo-2</code>: $\x = (1, 2, 4, 8, 16)$, $\y = (1, 2, 4, 8, 16)$, expected output: $1$ (identity property)</li><li><code>demo-3</code>: $\x = (2, 4, 8, 16, 32)$, $\y = (10, 20, 40, 80, 160)$ (= [2×demo-1.x, 5×demo-1.y]), expected output: $0.2$ (scale property)</li></ul><p><strong>Natural sequences</strong> ($[n, m] \in \{1, 2, 3\} \times \{1, 2, 3\}$) — 9 combinations:</p><ul><li><code>natural-1-1</code>: $\x = (1)$, $\y = (1)$, expected output: $1$</li><li><code>natural-1-2</code>: $\x = (1)$, $\y = (1, 2)$, expected output: $\approx 0.667$</li><li><code>natural-1-3</code>: $\x = (1)$, $\y = (1, 2, 3)$, expected output: $0.5$</li><li><code>natural-2-1</code>: $\x = (1, 2)$, $\y = (1)$, expected output: $1.5$</li><li><code>natural-2-2</code>: $\x = (1, 2)$, $\y = (1, 2)$, expected output: $1$</li><li><code>natural-2-3</code>: $\x = (1, 2)$, $\y = (1, 2, 3)$, expected output: $\approx 0.833$</li><li><code>natural-3-1</code>: $\x = (1, 2, 3)$, $\y = (1)$, expected output: $2$</li><li><code>natural-3-2</code>: $\x = (1, 2, 3)$, $\y = (1, 2)$, expected output: $1.5$</li><li><code>natural-3-3</code>: $\x = (1, 2, 3)$, $\y = (1, 2, 3)$, expected output: $1$</li></ul><p><strong>Additive distribution</strong> ($[n, m] \in \{5, 10, 30\} \times \{5, 10, 30\}$) — 9 combinations with $\Additive(10, 1)$:</p><ul><li><code>additive-5-5</code>, <code>additive-5-10</code>, <code>additive-5-30</code></li><li><code>additive-10-5</code>, <code>additive-10-10</code>, <code>additive-10-30</code></li><li><code>additive-30-5</code>, <code>additive-30-10</code>, <code>additive-30-30</code></li><li>Random generation: $\x$ uses seed 0, $\y$ uses seed 1</li></ul><p><strong>Uniform distribution</strong> ($[n, m] \in \{5, 100\} \times \{5, 100\}$) — 4 combinations with $\Uniform(0, 1)$:</p><ul><li><code>uniform-5-5</code>, <code>uniform-5-100</code>, <code>uniform-100-5</code>, <code>uniform-100-100</code></li><li>Random generation: $\x$ uses seed 2, $\y$ uses seed 3</li></ul><p>The natural sequences verify the identity property ($\Ratio(\x, \x) = 1$) and validate ratio calculations with simple integer inputs.
Note that implementations should handle the practical constraint of avoiding division by values near zero.</p><p><strong>Unsorted tests</strong> — verify independent sorting for ratio calculation (12 tests):</p><ul><li><code>unsorted-x-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: X unsorted (reversed), Y sorted (2 tests)</li><li><code>unsorted-y-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: X sorted, Y unsorted (reversed) (2 tests)</li><li><code>unsorted-both-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: both unsorted (reversed) (2 tests)</li><li><code>unsorted-demo-unsorted-x</code>: $\x = (16, 1, 8, 2, 4)$, $\y = (2, 4, 8, 16, 32)$ (demo-1 with X unsorted)</li><li><code>unsorted-demo-unsorted-y</code>: $\x = (1, 2, 4, 8, 16)$, $\y = (32, 2, 16, 4, 8)$ (demo-1 with Y unsorted)</li><li><code>unsorted-demo-both-unsorted</code>: $\x = (8, 1, 16, 4, 2)$, $\y = (16, 32, 2, 8, 4)$ (demo-1 both unsorted)</li><li><code>unsorted-identity-unsorted</code>: $\x = (4, 1, 8, 2, 16)$, $\y = (16, 1, 8, 4, 2)$ (identity property, both unsorted)</li><li><code>unsorted-asymmetric-unsorted-2-3</code>: $\x = (2, 1)$, $\y = (3, 1, 2)$ (asymmetric, both unsorted)</li><li><code>unsorted-power-unsorted-5</code>: $\x = (16, 2, 8, 1, 4)$, $\y = (32, 4, 16, 2, 8)$ (powers of 2 unsorted)</li></ul><h2 id=97-avgspread>§9.7. AvgSpread</h2>$$
\AvgSpread(\x, \y) = \dfrac{n\Spread(\x) + m\Spread(\y)}{n + m}
$$<p>The $\AvgSpread$ test suite contains 49 test cases (35 original + 14 unsorted).
Since $\AvgSpread$ computes $\Spread(\x)$ and $\Spread(\y)$ independently, unsorted tests are critical to verify that both samples are sorted independently before computing their spreads.</p><p><strong>Demo examples</strong> ($n = m = 5$) — from manual introduction, validating properties:</p><ul><li><code>demo-1</code>: $\x = (0, 3, 6, 9, 12)$, $\y = (0, 2, 4, 6, 8)$, expected output: $5$ (base case: $(5 \cdot 6 + 5 \cdot 4)/10$)</li><li><code>demo-2</code>: $\x = (0, 3, 6, 9, 12)$, $\y = (0, 3, 6, 9, 12)$, expected output: $6$ (identity case)</li><li><code>demo-3</code>: $\x = (0, 6, 12, 18, 24)$, $\y = (0, 9, 18, 27, 36)$ (= [2×demo-1.x, 3×demo-1.y]), expected output: $15$ (scale equivariance)</li><li><code>demo-4</code>: $\x = (0, 2, 4, 6, 8)$, $\y = (0, 3, 6, 9, 12)$ (= reversed demo-1), expected output: $5$ (symmetry)</li><li><code>demo-5</code>: $\x = (0, 6, 12, 18, 24)$, $\y = (0, 4, 8, 12, 16)$ (= 2 × demo-1), expected output: $10$ (uniform scaling)</li></ul><p><strong>Natural sequences</strong> ($[n, m] \in \{1, 2, 3\} \times \{1, 2, 3\}$) — 9 combinations:</p><ul><li>All combinations from single-element to three-element samples, validating the weighted average calculation</li></ul><p><strong>Negative values</strong> ($[n, m] = [2, 2]$) — validates spread calculation with negative values:</p><ul><li><code>negative-2-2</code>: $\x = (-2, -1)$, $\y = (-2, -1)$, expected output: $1$</li></ul><p><strong>Zero values</strong> ($[n, m] \in \{1, 2\} \times \{1, 2\}$) — 4 combinations:</p><ul><li>All produce output $0$ since $\Spread$ of constant samples is zero</li></ul><p><strong>Additive distribution</strong> ($[n, m] \in \{5, 10, 30\} \times \{5, 10, 30\}$) — 9 combinations with $\Additive(10, 1)$:</p><ul><li>Tests pooled dispersion across different sample size combinations</li><li>Random generation: $\x$ uses seed 0, $\y$ uses seed 1</li></ul><p><strong>Uniform distribution</strong> ($[n, m] \in \{5, 100\} \times \{5, 100\}$) — 4 combinations with $\Uniform(0, 1)$:</p><ul><li>Validates correct weighting when sample sizes differ substantially</li><li>Random generation: $\x$ uses seed 2, $\y$ uses seed 3</li></ul><p>The asymmetric size combinations are particularly important for $\AvgSpread$ because the estimator must correctly weight each sample&rsquo;s contribution by its size.</p><p><strong>Composite estimator stress tests</strong> — edge cases for weighted averaging:</p><ul><li><code>composite-asymmetric-weights</code>: $\x = (1, 2)$, $\y = (3, 4, 5, 6, 7, 8, 9, 10)$ (2 vs 8, tests weighting formula)</li><li><code>composite-zero-spread-one</code>: $\x = (5, 5, 5)$, $\y = (1, 2, 3, 4, 5)$ (one zero spread, tests edge case)</li><li><code>composite-extreme-sizes</code>: $\x = (10)$, $\y = (1, 2, 3, 4, 5, 6, 7, 8, 9, 10)$ (1 vs 10, extreme weighting)</li></ul><p><strong>Unsorted tests</strong> — critical for verifying independent sorting (14 tests):</p><ul><li><code>unsorted-x-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: X unsorted (reversed), Y sorted (2 tests)</li><li><code>unsorted-y-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: X sorted, Y unsorted (reversed) (2 tests)</li><li><code>unsorted-both-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: both unsorted (reversed) (2 tests)</li><li><code>unsorted-demo-unsorted-x</code>: $\x = (12, 0, 6, 3, 9)$, $\y = (0, 2, 4, 6, 8)$ (demo-1 with X unsorted)</li><li><code>unsorted-demo-unsorted-y</code>: $\x = (0, 3, 6, 9, 12)$, $\y = (8, 0, 4, 2, 6)$ (demo-1 with Y unsorted)</li><li><code>unsorted-demo-both-unsorted</code>: $\x = (9, 0, 12, 3, 6)$, $\y = (6, 0, 8, 2, 4)$ (demo-1 both unsorted)</li><li><code>unsorted-identity-unsorted</code>: $\x = (6, 0, 12, 3, 9)$, $\y = (9, 0, 12, 6, 3)$ (demo-2 unsorted)</li><li><code>unsorted-negative-unsorted</code>: $\x = (-1, -2)$, $\y = (-1, -2)$ (negative unsorted)</li><li><code>unsorted-zero-unsorted-2-2</code>: $\x = (0, 0)$, $\y = (0, 0)$ (zeros, any order)</li><li><code>unsorted-asymmetric-weights-unsorted</code>: $\x = (2, 1)$, $\y = (8, 3, 6, 4, 10, 5, 9, 7)$ (asymmetric unsorted)</li><li><code>unsorted-zero-spread-x-unsorted</code>: $\x = (5, 5, 5)$, $\y = (5, 1, 4, 2, 3)$ (zero spread X, Y unsorted)</li></ul><p>These tests verify that implementations compute $\Spread(\x)$ and $\Spread(\y)$ with properly sorted samples.</p><h2 id=98-disparity>§9.8. Disparity</h2>$$
\Disparity(\x, \y) = \dfrac{\Shift(\x, \y)}{\AvgSpread(\x, \y)}
$$<p>The $\Disparity$ test suite contains 28 test cases (16 original + 12 unsorted).
Since $\Disparity$ combines $\Shift$ and $\AvgSpread$, unsorted tests verify both components handle sorting correctly.</p><p><strong>Demo examples</strong> ($n = m = 5$) — from manual introduction, validating properties:</p><ul><li><code>demo-1</code>: $\x = (0, 3, 6, 9, 12)$, $\y = (0, 2, 4, 6, 8)$, expected output: $0.4$ (base case: $2/5$)</li><li><code>demo-2</code>: $\x = (5, 8, 11, 14, 17)$, $\y = (5, 7, 9, 11, 13)$ (= demo-1 + 5), expected output: $0.4$ (location invariance)</li><li><code>demo-3</code>: $\x = (0, 6, 12, 18, 24)$, $\y = (0, 4, 8, 12, 16)$ (= 2 × demo-1), expected output: $0.4$ (scale invariance)</li><li><code>demo-4</code>: $\x = (0, 2, 4, 6, 8)$, $\y = (0, 3, 6, 9, 12)$ (= reversed demo-1), expected output: $-0.4$ (anti-symmetry)</li></ul><p><strong>Natural sequences</strong> ($[n, m] \in \{2, 3\} \times \{2, 3\}$) — 4 combinations:</p><ul><li><code>natural-2-2</code>, <code>natural-2-3</code>, <code>natural-3-2</code>, <code>natural-3-3</code></li><li>Minimum size $n, m \geq 2$ required for meaningful dispersion calculations</li></ul><p><strong>Negative values</strong> ($[n, m] = [2, 2]$) — end-to-end validation with negative values:</p><ul><li><code>negative-2-2</code>: $\x = (-2, -1)$, $\y = (-2, -1)$, expected output: $0$</li></ul><p><strong>Uniform distribution</strong> ($[n, m] \in \{5, 100\} \times \{5, 100\}$) — 4 combinations with $\Uniform(0, 1)$:</p><ul><li><code>uniform-5-5</code>, <code>uniform-5-100</code>, <code>uniform-100-5</code>, <code>uniform-100-100</code></li><li>Random generation: $\x$ uses seed 0, $\y$ uses seed 1</li></ul><p>The smaller test set for $\Disparity$ reflects implementation confidence.
Since $\Disparity$ combines $\Shift$ and $\AvgSpread$, correct implementation of those components ensures $\Disparity$ correctness.
The test cases validate the division operation and confirm scale-free properties.</p><p><strong>Composite estimator stress tests</strong> — edge cases for effect size calculation:</p><ul><li><code>composite-small-avgspread</code>: $\x = (10.001, 10.002, 10.003)$, $\y = (10.004, 10.005, 10.006)$ (tiny spread, large shift)</li><li><code>composite-large-avgspread</code>: $\x = (1, 100, 200)$, $\y = (50, 150, 250)$ (large spread, small shift)</li><li><code>composite-extreme-disparity</code>: $\x = (1, 1.001)$, $\y = (100, 100.001)$ (extreme ratio, tests precision)</li></ul><p><strong>Unsorted tests</strong> — verify both Shift and AvgSpread handle sorting (12 tests):</p><ul><li><code>unsorted-x-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: X unsorted (reversed), Y sorted (2 tests)</li><li><code>unsorted-y-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: X sorted, Y unsorted (reversed) (2 tests)</li><li><code>unsorted-both-natural-{n}-{m}</code> for $(n,m) \in \{(3,3), (4,4)\}$: both unsorted (reversed) (2 tests)</li><li><code>unsorted-demo-unsorted-x</code>: $\x = (12, 0, 6, 3, 9)$, $\y = (0, 2, 4, 6, 8)$ (demo-1 with X unsorted)</li><li><code>unsorted-demo-unsorted-y</code>: $\x = (0, 3, 6, 9, 12)$, $\y = (8, 0, 4, 2, 6)$ (demo-1 with Y unsorted)</li><li><code>unsorted-demo-both-unsorted</code>: $\x = (9, 0, 12, 3, 6)$, $\y = (6, 0, 8, 2, 4)$ (demo-1 both unsorted)</li><li><code>unsorted-location-invariance-unsorted</code>: $\x = (17, 5, 11, 8, 14)$, $\y = (13, 5, 9, 7, 11)$ (demo-2 unsorted)</li><li><code>unsorted-scale-invariance-unsorted</code>: $\x = (24, 0, 12, 6, 18)$, $\y = (16, 0, 8, 4, 12)$ (demo-3 unsorted)</li><li><code>unsorted-anti-symmetry-unsorted</code>: $\x = (8, 0, 4, 2, 6)$, $\y = (12, 0, 6, 3, 9)$ (demo-4 reversed and unsorted)</li></ul><p>As a composite estimator, $\Disparity$ tests both the numerator ($\Shift$) and denominator ($\AvgSpread$).
Unsorted variants verify end-to-end correctness including invariance properties.</p><h2 id=99-test-framework>§9.9. Test Framework</h2><p>The reference test framework consists of three components:</p><p><strong>Test generation</strong> — The C# implementation defines test inputs programmatically using builder patterns.
For deterministic cases, inputs are explicitly specified.
For random cases, the framework uses controlled seeds with <code>System.Random</code> to ensure reproducibility across all platforms.</p><p>The random generation mechanism works as follows:</p><ul><li>Each test suite builder maintains a seed counter initialized to zero.</li><li>For one-sample estimators, each distribution type receives the next available seed.
The same random generator produces all samples for all sizes within that distribution.</li><li>For two-sample estimators, each pair of distributions receives two consecutive seeds:
one for the $\x$ sample generator and one for the $\y$ sample generator.</li><li>The seed counter increments with each random generator creation, ensuring deterministic test data generation.</li></ul><p>For $\Additive$ distributions, random values are generated using the Box-Müller transform,
which converts pairs of uniform random values into normally distributed values.
The transform applies the formula:</p>$$
X = \mu + \sigma \sqrt{-2 \ln(U_1)} \sin(2\pi U_2)
$$<p>where $U_1, U_2$ are uniform random values from $\Uniform(0, 1)$, $\mu$ is the mean, and $\sigma$ is the standard deviation.</p><p>For $\Uniform$ distributions, random values are generated directly using the quantile function:</p>$$
X = \min + U \cdot (\max - \min)
$$<p>where $U$ is a uniform random value from $\Uniform(0, 1)$.</p><p>The framework executes the reference implementation on all generated inputs and serializes input-output pairs to JSON format.</p><p><strong>Test validation</strong> — Each language implementation loads the JSON test cases and executes them against its local estimator implementation.
Assertions verify that outputs match expected values within a given numerical tolerance (typically $10^{-10}$ for relative error).</p><p><strong>Test data format</strong> — Each test case is a JSON file containing <code>input</code> and <code>output</code> fields.
For one-sample estimators, the input contains array <code>x</code> and optional <code>parameters</code>.
For two-sample estimators, input contains arrays <code>x</code> and <code>y</code>.
Output is a single numeric value.</p><p><strong>Performance testing</strong> — The toolkit provides $O(n \log n)$ fast algorithms for $\Center$, $\Spread$, and $\Shift$ estimators,
dramatically more efficient than naive implementations that materialize all pairwise combinations.
Performance tests use sample size $n = 100{,}000$ (for one-sample) or $n = m = 100{,}000$ (for two-sample).
This specific size creates a clear performance distinction:
fast implementations ($O(n \log n)$ or $O((m+n) \log L)$) complete in under 5 seconds on modern hardware across all supported languages,
while naive implementations ($O(n^2 \log n)$ or $O(mn \log(mn))$) would be prohibitively slow (taking hours or failing due to memory exhaustion).
With $n = 100{,}000$, naive approaches would need to materialize approximately 5 billion pairwise values for $\Center$/$\Spread$
or 10 billion for $\Shift$, whereas fast algorithms require only $O(n)$ additional memory.
Performance tests serve dual purposes: correctness validation at scale and performance regression detection,
ensuring implementations use the efficient algorithms and remain practical for real-world datasets with hundreds of thousands of observations.
Performance test specifications are provided in the respective estimator sections above.</p><p>This framework ensures that all seven language implementations maintain strict numerical agreement across the full test suite.</p><h1 id=10-artifacts>§10. Artifacts</h1><p>Manual:</p><ul><li>PDF: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/pragmastat-v3.2.2.pdf>pragmastat-v3.2.2.pdf</a></li><li>Markdown: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/pragmastat-v3.2.2.md>pragmastat-v3.2.2.md</a></li><li>Website: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/web-v3.2.2.zip>web-v3.2.2.zip</a></li></ul><p>Implementations:</p><ul><li>Python: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/py-v3.2.2.zip>py-v3.2.2.zip</a></li><li>TypeScript: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/ts-v3.2.2.zip>ts-v3.2.2.zip</a></li><li>R: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/r-v3.2.2.zip>r-v3.2.2.zip</a></li><li>C#: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/cs-v3.2.2.zip>cs-v3.2.2.zip</a></li><li>Kotlin: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/kt-v3.2.2.zip>kt-v3.2.2.zip</a></li><li>Rust: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/rs-v3.2.2.zip>rs-v3.2.2.zip</a></li><li>Go: <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/go-v3.2.2.zip>go-v3.2.2.zip</a></li></ul><p>Data:</p><ul><li>Reference tests (json): <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/tests-v3.2.2.zip>tests-v3.2.2.zip</a></li><li>Reference simulations (json): <a href=https://github.com/AndreyAkinshin/pragmastat/releases/download/v3.2.2/sim-v3.2.2.zip>sim-v3.2.2.zip</a></li></ul><p>Source code:</p><ul><li><a href=https://github.com/AndreyAkinshin/pragmastat/archive/refs/tags/v3.2.2.zip>pragmastat-3.2.2.zip</a></li></ul></div></div><script>(()=>{var t=document.getElementById("theme-toggle-system-icon"),n=document.getElementById("theme-toggle-dark-icon"),s=document.getElementById("theme-toggle-light-icon"),o=document.querySelectorAll(".img-dark"),i=document.querySelectorAll(".img-light");function a(){return localStorage.getItem("color-theme")?localStorage.getItem("color-theme"):window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function e(e){let r=(e||a())==="dark",c=localStorage.getItem("color-theme")===null;document.documentElement.classList.toggle("dark",r),document.documentElement.setAttribute("data-theme",r?"dark":"light"),t.classList.toggle("hidden",!c),n.classList.toggle("hidden",c||r),s.classList.toggle("hidden",c||!r),o.forEach(e=>e.classList.toggle("hidden",!r)),i.forEach(e=>e.classList.toggle("hidden",r))}e(),document.getElementById("theme-toggle").addEventListener("click",t=>{let s=localStorage.getItem("color-theme"),n=window.matchMedia("(prefers-color-scheme: dark)").matches;s===null?localStorage.setItem("color-theme",n?"light":"dark"):s===(n?"light":"dark")?localStorage.setItem("color-theme",n?"dark":"light"):localStorage.removeItem("color-theme"),e()}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{localStorage.getItem("color-theme")||e(t.matches?"dark":"light")})})()</script><script>(()=>{window.MathJax={loader:{load:["[tex]/tagformat","[tex]/textmacros"]},tex:{tags:"ams",tagformat:{number:e=>e.toString(),tag:e=>"("+e+")",id:e=>e.replace(/\s/g,"_"),url:(e,t)=>t+"#"+encodeURIComponent(e)},packages:{"[+]":["tagformat","textmacros"]},inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"},svg:{fontCache:"global"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+=" has-jax"})})})()</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>(()=>{document.addEventListener("DOMContentLoaded",function(){function e(e){document.querySelectorAll(`span.autoanchor_${e}`).forEach((e,t)=>{e.textContent=t+1}),document.querySelectorAll(`a[href^="#${e}_"]`).forEach(t=>{let s=t.getAttribute("href").substring(1),n=document.querySelector(`span.autoanchor_${e}[data-ref="${s}"]`);n&&(t.textContent=n.textContent)})}["fig","exm","tbl"].forEach(e)})})()</script><footer class="z-20 py-2 mt-6 w-full flex items-center justify-center"><span class="text-front-dim-l dark:text-front-dim-d text-center mr-3">© 2025 <span class=whitespace-nowrap>Andrey Akinshin</span></span>
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></footer></body></html>