---
import BaseLayout from './BaseLayout.astro';
import MenuButton from '../components/MenuButton.astro';
import Sidebar from '../components/Sidebar.astro';
import GitHubButton from '../components/GitHubButton.astro';
import ThemeSwitcher from '../components/ThemeSwitcher.astro';
import PrevNextNav from '../components/PrevNextNav.astro';

interface Props {
  title: string;
  description?: string;
  headings?: { depth: number; slug: string; text: string }[];
}

const { title, description, headings = [] } = Astro.props;
const currentSlug = Astro.url.pathname.replace(/^\/|\/$/g, '');
---

<BaseLayout title={title} description={description}>
  <div class="layout" id="docs-layout">
    <aside class="sidebar-container" transition:persist="sidebar">
      <Sidebar headings={headings} currentSlug={currentSlug} />
    </aside>

    <main class="main-content">
      <article class="content">
        <h1>{title}</h1>
        <slot />
        <PrevNextNav currentSlug={currentSlug} />
      </article>
    </main>

    <!-- Expand button (visible when sidebar is collapsed) -->
    <button
      id="sidebar-expand"
      class="sidebar-expand"
      aria-label="Expand sidebar"
    >
      <svg
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        aria-hidden="true"
      >
        <polyline points="13 17 18 12 13 7" />
        <polyline points="6 17 11 12 6 7" />
      </svg>
    </button>
  </div>

  <!-- Mobile header -->
  <header class="mobile-header">
    <MenuButton />
    <a href="/" class="mobile-logo">Pragmastat</a>
    <div class="mobile-header-right">
      <GitHubButton />
      <ThemeSwitcher />
    </div>
  </header>

  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <script>
    // ========================================================================
    // Sidebar active state update (for transition:persist)
    // Runs on every navigation to update the persisted sidebar
    // ========================================================================
    function updateSidebarActiveState() {
      const currentPath = window.location.pathname.replace(/^\/|\/$/g, '');

      // Update active link classes
      document.querySelectorAll<HTMLAnchorElement>('.sidebar-link').forEach((link) => {
        const slug = (link.getAttribute('href') || '').replace(/^\/|\/$/g, '');
        const isActive = slug === currentPath;
        link.classList.toggle('active', isActive);
        if (isActive) {
          link.setAttribute('aria-current', 'page');
        } else {
          link.removeAttribute('aria-current');
        }
      });

      // Remove old sublinks
      document.querySelectorAll('.sidebar-sublist').forEach((el) => el.remove());

      // Build new sublinks from the current page's headings
      const headings = Array.from(
        document.querySelectorAll('.content h2, .content h3, .content h4, .content h5, .content h6'),
      )
        .filter((h) => h.id)
        .map((h) => ({
          depth: parseInt(h.tagName[1]),
          slug: h.id,
          text: (h.textContent || '').trim(),
        }));

      const activeLink = document.querySelector('.sidebar-link.active');
      if (activeLink && headings.length > 0) {
        const sublist = document.createElement('ul');
        sublist.className = 'sidebar-sublist';
        for (const h of headings) {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `#${h.slug}`;
          a.className = `sidebar-sublink depth-${h.depth}`;
          a.textContent = h.text;
          li.appendChild(a);
          sublist.appendChild(li);
        }
        // Insert after the active link (inside the same <li>)
        activeLink.after(sublist);
      }
    }

    document.addEventListener('astro:after-swap', updateSidebarActiveState);

    // ========================================================================
    // Page-specific initialization (runs on every navigation)
    // ========================================================================
    const copyIcon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
    const checkIcon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;

    // Cache references.json across navigations
    let cachedReferences: Record<string, any> | null = null;

    function initPage() {
      // Copy buttons for code blocks
      document.querySelectorAll('.content pre').forEach((pre) => {
        if (pre.querySelector('.copy-button')) return; // already initialized
        const button = document.createElement('button');
        button.className = 'copy-button';
        button.innerHTML = copyIcon;
        button.setAttribute('aria-label', 'Copy code');

        button.addEventListener('click', async () => {
          const code = pre.querySelector('code')?.textContent || '';
          await navigator.clipboard.writeText(code);
          button.innerHTML = checkIcon;
          button.classList.add('copied');
          setTimeout(() => {
            button.innerHTML = copyIcon;
            button.classList.remove('copied');
          }, 3000);
        });

        pre.appendChild(button);
      });

      // Mobile sidebar toggle
      const menuButton = document.getElementById('menu-button');
      const sidebar = document.querySelector('.sidebar-container');
      const overlay = document.getElementById('sidebar-overlay');

      function bindClickOnce(el: HTMLElement | null, handler: () => void) {
        if (!el) return;
        if (el.dataset.pragmastatBound === 'true') return;
        el.dataset.pragmastatBound = 'true';
        el.addEventListener('click', handler);
      }

      bindClickOnce(menuButton, () => {
        sidebar?.classList.toggle('open');
        overlay?.classList.toggle('open');
      });

      bindClickOnce(overlay, () => {
        sidebar?.classList.remove('open');
        overlay?.classList.remove('open');
      });

      // Close mobile sidebar on navigation
      sidebar?.classList.remove('open');
      overlay?.classList.remove('open');

      // Desktop sidebar collapse toggle
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const layout = document.getElementById('docs-layout');

      function setSidebarCollapsed(collapsed: boolean) {
        const layoutEl = document.getElementById('docs-layout');
        const toggleEl = document.getElementById('sidebar-toggle');
        if (collapsed) {
          document.documentElement.setAttribute('data-sidebar-collapsed', '');
          layoutEl?.setAttribute('data-sidebar-collapsed', '');
          toggleEl?.setAttribute('aria-expanded', 'false');
          localStorage.setItem('pragmastat-sidebar-collapsed', 'true');
        } else {
          document.documentElement.removeAttribute('data-sidebar-collapsed');
          layoutEl?.removeAttribute('data-sidebar-collapsed');
          toggleEl?.setAttribute('aria-expanded', 'true');
          localStorage.removeItem('pragmastat-sidebar-collapsed');
        }
      }

      // Initialize from localStorage
      const sidebarCollapsed = localStorage.getItem('pragmastat-sidebar-collapsed') === 'true';
      if (sidebarCollapsed) {
        layout?.setAttribute('data-sidebar-collapsed', '');
        sidebarToggle?.setAttribute('aria-expanded', 'false');
      }

      bindClickOnce(sidebarToggle, () => {
        const isCollapsed = document.getElementById('docs-layout')?.hasAttribute('data-sidebar-collapsed') ?? false;
        setSidebarCollapsed(!isCollapsed);
      });

      const sidebarExpand = document.getElementById('sidebar-expand');
      bindClickOnce(sidebarExpand, () => {
        setSidebarCollapsed(false);
      });

      // Active section highlighting in sidebar (scroll spy)
      initScrollSpy();

      // Citation popovers
      initCitations();
    }

    // ========================================================================
    // Scroll spy for sidebar sublinks
    // ========================================================================
    let scrollSpyCleanup: (() => void) | null = null;

    function initScrollSpy() {
      // Clean up previous scroll listener
      scrollSpyCleanup?.();
      scrollSpyCleanup = null;

      const sublinks = document.querySelectorAll<HTMLAnchorElement>('.sidebar-sublink');
      if (sublinks.length === 0) return;

      const headingIds = Array.from(sublinks).map((link) => link.hash.slice(1));
      let ticking = false;

      function updateActiveHeading() {
        const scrollTop = window.scrollY;
        const offset = 100;
        let activeId = '';

        for (const id of headingIds) {
          const el = document.getElementById(id);
          if (el && el.offsetTop - offset <= scrollTop) {
            activeId = id;
          }
        }

        if (window.innerHeight + scrollTop >= document.body.scrollHeight - 2) {
          activeId = headingIds[headingIds.length - 1];
        }

        sublinks.forEach((link) => {
          link.classList.toggle('active', link.hash === `#${activeId}`);
        });
        ticking = false;
      }

      function onScroll() {
        if (!ticking) {
          requestAnimationFrame(updateActiveHeading);
          ticking = true;
        }
      }

      window.addEventListener('scroll', onScroll);
      scrollSpyCleanup = () => window.removeEventListener('scroll', onScroll);
      updateActiveHeading();
    }

    // ========================================================================
    // Citation popovers
    // ========================================================================
    async function initCitations() {
      const citations = document.querySelectorAll('.citation');
      if (citations.length === 0) return;

      if (!cachedReferences) {
        try {
          const res = await fetch('/references.json');
          if (!res.ok) return;
          cachedReferences = await res.json();
        } catch {
          return;
        }
      }
      const references = cachedReferences!;

      let popover: HTMLElement | null = null;
      let hideTimeout: ReturnType<typeof setTimeout> | null = null;
      let isOverPopover = false;

      function showPopover(citation: Element, ref: any) {
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
        if (popover && popover.dataset.key === (citation as HTMLElement).dataset.key) return;

        hidePopoverNow();
        popover = document.createElement('div');
        popover.className = 'citation-popover';
        popover.dataset.key = (citation as HTMLElement).dataset.key!;

        const titleDiv = document.createElement('div');
        titleDiv.className = 'citation-popover-title';
        titleDiv.textContent = ref.title;
        popover.appendChild(titleDiv);

        const authorsDiv = document.createElement('div');
        authorsDiv.className = 'citation-popover-authors';
        authorsDiv.textContent = `${ref.authors.join(', ')} (${ref.year})`;
        popover.appendChild(authorsDiv);

        if (ref.venue) {
          const venueDiv = document.createElement('div');
          venueDiv.className = 'citation-popover-venue';
          venueDiv.textContent = ref.venue;
          popover.appendChild(venueDiv);
        }

        if (ref.doi) {
          const doiDiv = document.createElement('div');
          doiDiv.className = 'citation-popover-doi';
          const doiLink = document.createElement('a');
          doiLink.href = `https://doi.org/${encodeURIComponent(ref.doi)}`;
          doiLink.target = '_blank';
          doiLink.rel = 'noopener noreferrer';
          doiLink.textContent = `DOI: ${ref.doi}`;
          doiDiv.appendChild(doiLink);
          popover.appendChild(doiDiv);
        }

        popover.addEventListener('mouseenter', () => {
          isOverPopover = true;
          if (hideTimeout) {
            clearTimeout(hideTimeout);
            hideTimeout = null;
          }
        });
        popover.addEventListener('mouseleave', () => {
          isOverPopover = false;
          scheduleHide();
        });

        document.body.appendChild(popover);

        const rect = citation.getBoundingClientRect();
        const popRect = popover.getBoundingClientRect();
        let left = rect.left;
        let top = rect.bottom + 4;

        if (left + popRect.width > window.innerWidth - 16) {
          left = window.innerWidth - popRect.width - 16;
        }
        if (top + popRect.height > window.innerHeight - 16) {
          top = rect.top - popRect.height - 4;
        }

        popover.style.left = `${left}px`;
        popover.style.top = `${top}px`;
      }

      function scheduleHide() {
        if (hideTimeout) return;
        hideTimeout = setTimeout(() => {
          if (!isOverPopover) hidePopoverNow();
          hideTimeout = null;
        }, 150);
      }

      function hidePopoverNow() {
        if (popover) {
          popover.remove();
          popover = null;
        }
        isOverPopover = false;
      }

      citations.forEach((citation) => {
        const key = (citation as HTMLElement).dataset.key;
        if (!key) return;
        const ref = references[key];
        if (!ref) return;

        citation.addEventListener('mouseenter', () => showPopover(citation, ref));
        citation.addEventListener('mouseleave', scheduleHide);
        citation.addEventListener('click', (e) => {
          e.preventDefault();
          if (popover) hidePopoverNow();
          else showPopover(citation, ref);
        });
      });
    }

    // Run on initial load and every View Transition navigation
    document.addEventListener('astro:page-load', initPage);
  </script>
</BaseLayout>

<style>
  .layout {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr;
    min-height: 100vh;
    transition: grid-template-columns var(--transition-normal);
  }

  .sidebar-container {
    position: fixed;
    top: 0;
    left: 0;
    width: var(--sidebar-width);
    height: 100vh;
    overflow-y: auto;
    padding: 1.5rem 1rem;
    background-color: var(--color-bg);
    z-index: 10;
    transition: transform var(--transition-normal);
  }

  .main-content {
    grid-column: 2;
    padding: 2rem;
    max-width: 100%;
    overflow-x: hidden;
    transition: grid-column var(--transition-normal);
  }

  /* Collapsed sidebar state (desktop only) */
  /* Target both html[data-sidebar-collapsed] (early, from inline script) and .layout[data-sidebar-collapsed] (after JS) */
  @media (min-width: 961px) {
    :global(html[data-sidebar-collapsed]) .layout,
    .layout[data-sidebar-collapsed] {
      grid-template-columns: 0 1fr;
    }

    :global(html[data-sidebar-collapsed]) .sidebar-container,
    .layout[data-sidebar-collapsed] .sidebar-container {
      transform: translateX(-100%);
    }

    :global(html[data-sidebar-collapsed]) .main-content,
    .layout[data-sidebar-collapsed] .main-content {
      grid-column: 1 / -1;
    }

    :global(html[data-sidebar-collapsed]) .sidebar-expand,
    .layout[data-sidebar-collapsed] .sidebar-expand {
      opacity: 1;
      pointer-events: auto;
    }
  }

  /* Expand button - hidden by default, shown when collapsed */
  .sidebar-expand {
    display: none;
    position: fixed;
    top: 1rem;
    left: 1rem;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    opacity: 0;
    pointer-events: none;
    transition:
      opacity var(--transition-normal),
      color var(--transition-fast);
    z-index: 15;
  }

  .sidebar-expand:hover {
    color: var(--color-accent);
  }

  @media (min-width: 961px) {
    .sidebar-expand {
      display: flex;
    }
  }

  .content {
    max-width: var(--content-max-width);
    margin: 0 auto;
  }

  .mobile-header {
    --mobile-header-height: calc(var(--header-height) * 1.5);
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--mobile-header-height);
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    z-index: 20;
  }

  /* Blur/background layer behind header content */
  .mobile-header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      color-mix(in srgb, var(--color-bg) 92%, transparent) 0%,
      color-mix(in srgb, var(--color-bg) 80%, transparent) 70%,
      color-mix(in srgb, var(--color-bg) 65%, transparent) 100%
    );
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    mask-image: linear-gradient(to bottom, black 0%, black 70%, rgba(0,0,0,0.5) 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 0%, black 70%, rgba(0,0,0,0.5) 90%, transparent 100%);
    z-index: -1;
  }

  /* Soft fade below header */
  .mobile-header::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    height: 32px;
    background: linear-gradient(
      to bottom,
      color-mix(in srgb, var(--color-bg) 35%, transparent) 0%,
      color-mix(in srgb, var(--color-bg) 15%, transparent) 50%,
      transparent 100%
    );
    pointer-events: none;
  }

  .mobile-logo {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text);
    text-decoration: none;
  }

  .mobile-header-right {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background-color: var(--color-overlay);
    z-index: 9;
  }

  /* Mobile layout */
  @media (max-width: 960px) {
    .layout {
      grid-template-columns: 1fr;
      padding-top: calc(var(--header-height) * 1.5);
    }

    .mobile-header {
      display: flex;
    }

    .sidebar-container {
      top: calc(var(--header-height) * 1.5);
      height: calc(100vh - var(--header-height) * 1.5);
      transform: translateX(-100%);
      transition: transform var(--transition-normal);
    }

    .sidebar-container.open {
      transform: translateX(0);
    }

    .sidebar-overlay.open {
      display: block;
    }

    .main-content {
      grid-column: 1;
      padding: 1.5rem 1rem;
    }
  }
</style>
